<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>commitWork 阶段 | 秦光辉</title>
    <meta name="description" content="专注于前端开发，关注新技术，坚持学习。">
    <link rel="stylesheet" href="/assets/style.519b55ff.css">
    <link rel="modulepreload" href="/assets/chunks/AlgoliaSearchBox.db380e0b.js">
    <link rel="modulepreload" href="/assets/app.2e2e81fb.js">
    <link rel="modulepreload" href="/assets/react_commitWork.md.4f07d5be.lean.js">
    
    <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no, minimal-ui">
  <script>var _hmt=_hmt||[];(function(){var e=document.createElement("script");e.src="https://hm.baidu.com/hm.js?41a9a03811977ee15c69366a880d1296";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)})();</script>
  <meta name="twitter:title" content="commitWork 阶段 | 秦光辉">
  <meta property="og:title" content="commitWork 阶段 | 秦光辉">
  </head>
  <body>
    <div id="app"><!--[--><div class="theme"><header class="nav-bar" data-v-675d8756><div class="sidebar-button" data-v-675d8756><svg class="icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z" class></path></svg></div><a class="nav-bar-title" href="/" aria-label="秦光辉, back to home" data-v-675d8756 data-v-cc01ef16><img class="logo" src="/logo.png" alt="Logo" data-v-cc01ef16> 秦光辉</a><div class="flex-grow" data-v-675d8756></div><div class="nav" data-v-675d8756><nav class="nav-links" data-v-675d8756 data-v-eab3edfe><!--[--><div class="item" data-v-eab3edfe><div class="nav-link" data-v-eab3edfe data-v-b8818f8c><a class="item" href="/daily/index" data-v-b8818f8c>日常 <!----></a></div></div><div class="item" data-v-eab3edfe><div class="nav-link" data-v-eab3edfe data-v-b8818f8c><a class="item" href="/articles/index" data-v-b8818f8c>文章 <!----></a></div></div><div class="item" data-v-eab3edfe><div class="nav-dropdown-link" data-v-eab3edfe data-v-56bf3a3f><button class="button" data-v-56bf3a3f><span class="button-text" data-v-56bf3a3f>前端框架</span><span class="right button-arrow" data-v-56bf3a3f></span></button><ul class="dialog" data-v-56bf3a3f><!--[--><li class="dialog-item" data-v-56bf3a3f><div class="nav-dropdown-link-item" data-v-56bf3a3f data-v-bbc27490><a class="item" href="/vue/" data-v-bbc27490><span class="arrow" data-v-bbc27490></span><span class="text" data-v-bbc27490>Vue v2 源码解析</span><span class="icon" data-v-bbc27490><!----></span></a></div></li><li class="dialog-item" data-v-56bf3a3f><div class="nav-dropdown-link-item" data-v-56bf3a3f data-v-bbc27490><a class="item" href="/vue3/" data-v-bbc27490><span class="arrow" data-v-bbc27490></span><span class="text" data-v-bbc27490>Vue v3 源码</span><span class="icon" data-v-bbc27490><!----></span></a></div></li><li class="dialog-item" data-v-56bf3a3f><div class="nav-dropdown-link-item" data-v-56bf3a3f data-v-bbc27490><a class="item active" href="/react/" data-v-bbc27490><span class="arrow" data-v-bbc27490></span><span class="text" data-v-bbc27490>React v17 源码</span><span class="icon" data-v-bbc27490><!----></span></a></div></li><!--]--></ul></div></div><div class="item" data-v-eab3edfe><div class="nav-dropdown-link" data-v-eab3edfe data-v-56bf3a3f><button class="button" data-v-56bf3a3f><span class="button-text" data-v-56bf3a3f>构建工具</span><span class="right button-arrow" data-v-56bf3a3f></span></button><ul class="dialog" data-v-56bf3a3f><!--[--><li class="dialog-item" data-v-56bf3a3f><div class="nav-dropdown-link-item" data-v-56bf3a3f data-v-bbc27490><a class="item" href="/webpack/" data-v-bbc27490><span class="arrow" data-v-bbc27490></span><span class="text" data-v-bbc27490>Webpack</span><span class="icon" data-v-bbc27490><!----></span></a></div></li><li class="dialog-item" data-v-56bf3a3f><div class="nav-dropdown-link-item" data-v-56bf3a3f data-v-bbc27490><a class="item" href="/rollup/" data-v-bbc27490><span class="arrow" data-v-bbc27490></span><span class="text" data-v-bbc27490>Rollup</span><span class="icon" data-v-bbc27490><!----></span></a></div></li><li class="dialog-item" data-v-56bf3a3f><div class="nav-dropdown-link-item" data-v-56bf3a3f data-v-bbc27490><a class="item" href="/vite/" data-v-bbc27490><span class="arrow" data-v-bbc27490></span><span class="text" data-v-bbc27490>Vite</span><span class="icon" data-v-bbc27490><!----></span></a></div></li><li class="dialog-item" data-v-56bf3a3f><div class="nav-dropdown-link-item" data-v-56bf3a3f data-v-bbc27490><a class="item" href="/babel/" data-v-bbc27490><span class="arrow" data-v-bbc27490></span><span class="text" data-v-bbc27490>Babel</span><span class="icon" data-v-bbc27490><!----></span></a></div></li><!--]--></ul></div></div><div class="item" data-v-eab3edfe><div class="nav-dropdown-link" data-v-eab3edfe data-v-56bf3a3f><button class="button" data-v-56bf3a3f><span class="button-text" data-v-56bf3a3f>js</span><span class="right button-arrow" data-v-56bf3a3f></span></button><ul class="dialog" data-v-56bf3a3f><!--[--><li class="dialog-item" data-v-56bf3a3f><div class="nav-dropdown-link-item" data-v-56bf3a3f data-v-bbc27490><a class="item" href="/javascript/" data-v-bbc27490><span class="arrow" data-v-bbc27490></span><span class="text" data-v-bbc27490>ES6</span><span class="icon" data-v-bbc27490><!----></span></a></div></li><li class="dialog-item" data-v-56bf3a3f><div class="nav-dropdown-link-item" data-v-56bf3a3f data-v-bbc27490><a class="item" href="/node/" data-v-bbc27490><span class="arrow" data-v-bbc27490></span><span class="text" data-v-bbc27490>Node</span><span class="icon" data-v-bbc27490><!----></span></a></div></li><li class="dialog-item" data-v-56bf3a3f><div class="nav-dropdown-link-item" data-v-56bf3a3f data-v-bbc27490><a class="item" href="/typescript/" data-v-bbc27490><span class="arrow" data-v-bbc27490></span><span class="text" data-v-bbc27490>Typescript</span><span class="icon" data-v-bbc27490><!----></span></a></div></li><!--]--></ul></div></div><div class="item" data-v-eab3edfe><div class="nav-dropdown-link" data-v-eab3edfe data-v-56bf3a3f><button class="button" data-v-56bf3a3f><span class="button-text" data-v-56bf3a3f>基础</span><span class="right button-arrow" data-v-56bf3a3f></span></button><ul class="dialog" data-v-56bf3a3f><!--[--><li class="dialog-item" data-v-56bf3a3f><div class="nav-dropdown-link-item" data-v-56bf3a3f data-v-bbc27490><a class="item" href="/algorithms/" data-v-bbc27490><span class="arrow" data-v-bbc27490></span><span class="text" data-v-bbc27490>算法</span><span class="icon" data-v-bbc27490><!----></span></a></div></li><li class="dialog-item" data-v-56bf3a3f><div class="nav-dropdown-link-item" data-v-56bf3a3f data-v-bbc27490><a class="item" href="/data-structures/" data-v-bbc27490><span class="arrow" data-v-bbc27490></span><span class="text" data-v-bbc27490>数据结构</span><span class="icon" data-v-bbc27490><!----></span></a></div></li><li class="dialog-item" data-v-56bf3a3f><div class="nav-dropdown-link-item" data-v-56bf3a3f data-v-bbc27490><a class="item" href="/design-pattern/" data-v-bbc27490><span class="arrow" data-v-bbc27490></span><span class="text" data-v-bbc27490>设计模式</span><span class="icon" data-v-bbc27490><!----></span></a></div></li><li class="dialog-item" data-v-56bf3a3f><div class="nav-dropdown-link-item" data-v-56bf3a3f data-v-bbc27490><a class="item" href="/leetcode/" data-v-bbc27490><span class="arrow" data-v-bbc27490></span><span class="text" data-v-bbc27490>LeetCode</span><span class="icon" data-v-bbc27490><!----></span></a></div></li><li class="dialog-item" data-v-56bf3a3f><div class="nav-dropdown-link-item" data-v-56bf3a3f data-v-bbc27490><a class="item" href="/network/" data-v-bbc27490><span class="arrow" data-v-bbc27490></span><span class="text" data-v-bbc27490>网络</span><span class="icon" data-v-bbc27490><!----></span></a></div></li><li class="dialog-item" data-v-56bf3a3f><div class="nav-dropdown-link-item" data-v-56bf3a3f data-v-bbc27490><a class="item" href="/linux/" data-v-bbc27490><span class="arrow" data-v-bbc27490></span><span class="text" data-v-bbc27490>linux</span><span class="icon" data-v-bbc27490><!----></span></a></div></li><!--]--></ul></div></div><div class="item" data-v-eab3edfe><div class="nav-dropdown-link" data-v-eab3edfe data-v-56bf3a3f><button class="button" data-v-56bf3a3f><span class="button-text" data-v-56bf3a3f>资源</span><span class="right button-arrow" data-v-56bf3a3f></span></button><ul class="dialog" data-v-56bf3a3f><!--[--><li class="dialog-item" data-v-56bf3a3f><div class="nav-dropdown-link-item" data-v-56bf3a3f data-v-bbc27490><a class="item" href="/tools/" data-v-bbc27490><span class="arrow" data-v-bbc27490></span><span class="text" data-v-bbc27490>工具</span><span class="icon" data-v-bbc27490><!----></span></a></div></li><li class="dialog-item" data-v-56bf3a3f><div class="nav-dropdown-link-item" data-v-56bf3a3f data-v-bbc27490><a class="item" href="/resources/" data-v-bbc27490><span class="arrow" data-v-bbc27490></span><span class="text" data-v-bbc27490>资料</span><span class="icon" data-v-bbc27490><!----></span></a></div></li><!--]--></ul></div></div><div class="item" data-v-eab3edfe><div class="nav-link" data-v-eab3edfe data-v-b8818f8c><a class="item" href="/project/" data-v-b8818f8c>项目 <!----></a></div></div><!--]--><!----><div class="item" data-v-eab3edfe><div class="nav-link" data-v-eab3edfe data-v-b8818f8c><a class="item isExternal" href="https://github.com/promise96319" target="_blank" rel="noopener noreferrer" data-v-b8818f8c>GitHub <svg class="icon outbound" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15" data-v-b8818f8c><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div></div></nav></div><!--[--><!--[--><div class="algolia-search-box" id="docsearch"></div><!--]--><!--]--></header><aside class="sidebar" data-v-83e92a68><nav class="nav-links nav" data-v-83e92a68 data-v-eab3edfe><!--[--><div class="item" data-v-eab3edfe><div class="nav-link" data-v-eab3edfe data-v-b8818f8c><a class="item" href="/daily/index" data-v-b8818f8c>日常 <!----></a></div></div><div class="item" data-v-eab3edfe><div class="nav-link" data-v-eab3edfe data-v-b8818f8c><a class="item" href="/articles/index" data-v-b8818f8c>文章 <!----></a></div></div><div class="item" data-v-eab3edfe><div class="nav-dropdown-link" data-v-eab3edfe data-v-56bf3a3f><button class="button" data-v-56bf3a3f><span class="button-text" data-v-56bf3a3f>前端框架</span><span class="right button-arrow" data-v-56bf3a3f></span></button><ul class="dialog" data-v-56bf3a3f><!--[--><li class="dialog-item" data-v-56bf3a3f><div class="nav-dropdown-link-item" data-v-56bf3a3f data-v-bbc27490><a class="item" href="/vue/" data-v-bbc27490><span class="arrow" data-v-bbc27490></span><span class="text" data-v-bbc27490>Vue v2 源码解析</span><span class="icon" data-v-bbc27490><!----></span></a></div></li><li class="dialog-item" data-v-56bf3a3f><div class="nav-dropdown-link-item" data-v-56bf3a3f data-v-bbc27490><a class="item" href="/vue3/" data-v-bbc27490><span class="arrow" data-v-bbc27490></span><span class="text" data-v-bbc27490>Vue v3 源码</span><span class="icon" data-v-bbc27490><!----></span></a></div></li><li class="dialog-item" data-v-56bf3a3f><div class="nav-dropdown-link-item" data-v-56bf3a3f data-v-bbc27490><a class="item active" href="/react/" data-v-bbc27490><span class="arrow" data-v-bbc27490></span><span class="text" data-v-bbc27490>React v17 源码</span><span class="icon" data-v-bbc27490><!----></span></a></div></li><!--]--></ul></div></div><div class="item" data-v-eab3edfe><div class="nav-dropdown-link" data-v-eab3edfe data-v-56bf3a3f><button class="button" data-v-56bf3a3f><span class="button-text" data-v-56bf3a3f>构建工具</span><span class="right button-arrow" data-v-56bf3a3f></span></button><ul class="dialog" data-v-56bf3a3f><!--[--><li class="dialog-item" data-v-56bf3a3f><div class="nav-dropdown-link-item" data-v-56bf3a3f data-v-bbc27490><a class="item" href="/webpack/" data-v-bbc27490><span class="arrow" data-v-bbc27490></span><span class="text" data-v-bbc27490>Webpack</span><span class="icon" data-v-bbc27490><!----></span></a></div></li><li class="dialog-item" data-v-56bf3a3f><div class="nav-dropdown-link-item" data-v-56bf3a3f data-v-bbc27490><a class="item" href="/rollup/" data-v-bbc27490><span class="arrow" data-v-bbc27490></span><span class="text" data-v-bbc27490>Rollup</span><span class="icon" data-v-bbc27490><!----></span></a></div></li><li class="dialog-item" data-v-56bf3a3f><div class="nav-dropdown-link-item" data-v-56bf3a3f data-v-bbc27490><a class="item" href="/vite/" data-v-bbc27490><span class="arrow" data-v-bbc27490></span><span class="text" data-v-bbc27490>Vite</span><span class="icon" data-v-bbc27490><!----></span></a></div></li><li class="dialog-item" data-v-56bf3a3f><div class="nav-dropdown-link-item" data-v-56bf3a3f data-v-bbc27490><a class="item" href="/babel/" data-v-bbc27490><span class="arrow" data-v-bbc27490></span><span class="text" data-v-bbc27490>Babel</span><span class="icon" data-v-bbc27490><!----></span></a></div></li><!--]--></ul></div></div><div class="item" data-v-eab3edfe><div class="nav-dropdown-link" data-v-eab3edfe data-v-56bf3a3f><button class="button" data-v-56bf3a3f><span class="button-text" data-v-56bf3a3f>js</span><span class="right button-arrow" data-v-56bf3a3f></span></button><ul class="dialog" data-v-56bf3a3f><!--[--><li class="dialog-item" data-v-56bf3a3f><div class="nav-dropdown-link-item" data-v-56bf3a3f data-v-bbc27490><a class="item" href="/javascript/" data-v-bbc27490><span class="arrow" data-v-bbc27490></span><span class="text" data-v-bbc27490>ES6</span><span class="icon" data-v-bbc27490><!----></span></a></div></li><li class="dialog-item" data-v-56bf3a3f><div class="nav-dropdown-link-item" data-v-56bf3a3f data-v-bbc27490><a class="item" href="/node/" data-v-bbc27490><span class="arrow" data-v-bbc27490></span><span class="text" data-v-bbc27490>Node</span><span class="icon" data-v-bbc27490><!----></span></a></div></li><li class="dialog-item" data-v-56bf3a3f><div class="nav-dropdown-link-item" data-v-56bf3a3f data-v-bbc27490><a class="item" href="/typescript/" data-v-bbc27490><span class="arrow" data-v-bbc27490></span><span class="text" data-v-bbc27490>Typescript</span><span class="icon" data-v-bbc27490><!----></span></a></div></li><!--]--></ul></div></div><div class="item" data-v-eab3edfe><div class="nav-dropdown-link" data-v-eab3edfe data-v-56bf3a3f><button class="button" data-v-56bf3a3f><span class="button-text" data-v-56bf3a3f>基础</span><span class="right button-arrow" data-v-56bf3a3f></span></button><ul class="dialog" data-v-56bf3a3f><!--[--><li class="dialog-item" data-v-56bf3a3f><div class="nav-dropdown-link-item" data-v-56bf3a3f data-v-bbc27490><a class="item" href="/algorithms/" data-v-bbc27490><span class="arrow" data-v-bbc27490></span><span class="text" data-v-bbc27490>算法</span><span class="icon" data-v-bbc27490><!----></span></a></div></li><li class="dialog-item" data-v-56bf3a3f><div class="nav-dropdown-link-item" data-v-56bf3a3f data-v-bbc27490><a class="item" href="/data-structures/" data-v-bbc27490><span class="arrow" data-v-bbc27490></span><span class="text" data-v-bbc27490>数据结构</span><span class="icon" data-v-bbc27490><!----></span></a></div></li><li class="dialog-item" data-v-56bf3a3f><div class="nav-dropdown-link-item" data-v-56bf3a3f data-v-bbc27490><a class="item" href="/design-pattern/" data-v-bbc27490><span class="arrow" data-v-bbc27490></span><span class="text" data-v-bbc27490>设计模式</span><span class="icon" data-v-bbc27490><!----></span></a></div></li><li class="dialog-item" data-v-56bf3a3f><div class="nav-dropdown-link-item" data-v-56bf3a3f data-v-bbc27490><a class="item" href="/leetcode/" data-v-bbc27490><span class="arrow" data-v-bbc27490></span><span class="text" data-v-bbc27490>LeetCode</span><span class="icon" data-v-bbc27490><!----></span></a></div></li><li class="dialog-item" data-v-56bf3a3f><div class="nav-dropdown-link-item" data-v-56bf3a3f data-v-bbc27490><a class="item" href="/network/" data-v-bbc27490><span class="arrow" data-v-bbc27490></span><span class="text" data-v-bbc27490>网络</span><span class="icon" data-v-bbc27490><!----></span></a></div></li><li class="dialog-item" data-v-56bf3a3f><div class="nav-dropdown-link-item" data-v-56bf3a3f data-v-bbc27490><a class="item" href="/linux/" data-v-bbc27490><span class="arrow" data-v-bbc27490></span><span class="text" data-v-bbc27490>linux</span><span class="icon" data-v-bbc27490><!----></span></a></div></li><!--]--></ul></div></div><div class="item" data-v-eab3edfe><div class="nav-dropdown-link" data-v-eab3edfe data-v-56bf3a3f><button class="button" data-v-56bf3a3f><span class="button-text" data-v-56bf3a3f>资源</span><span class="right button-arrow" data-v-56bf3a3f></span></button><ul class="dialog" data-v-56bf3a3f><!--[--><li class="dialog-item" data-v-56bf3a3f><div class="nav-dropdown-link-item" data-v-56bf3a3f data-v-bbc27490><a class="item" href="/tools/" data-v-bbc27490><span class="arrow" data-v-bbc27490></span><span class="text" data-v-bbc27490>工具</span><span class="icon" data-v-bbc27490><!----></span></a></div></li><li class="dialog-item" data-v-56bf3a3f><div class="nav-dropdown-link-item" data-v-56bf3a3f data-v-bbc27490><a class="item" href="/resources/" data-v-bbc27490><span class="arrow" data-v-bbc27490></span><span class="text" data-v-bbc27490>资料</span><span class="icon" data-v-bbc27490><!----></span></a></div></li><!--]--></ul></div></div><div class="item" data-v-eab3edfe><div class="nav-link" data-v-eab3edfe data-v-b8818f8c><a class="item" href="/project/" data-v-b8818f8c>项目 <!----></a></div></div><!--]--><!----><div class="item" data-v-eab3edfe><div class="nav-link" data-v-eab3edfe data-v-b8818f8c><a class="item isExternal" href="https://github.com/promise96319" target="_blank" rel="noopener noreferrer" data-v-b8818f8c>GitHub <svg class="icon outbound" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15" data-v-b8818f8c><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div></div></nav><!--[--><!--]--><ul class="sidebar-links" data-v-83e92a68><!--[--><li class="sidebar-link"><a class="sidebar-link-item" href="/react/index">原理</a><ul class="sidebar-links"><li class="sidebar-link"><a class="sidebar-link-item" href="/react/react源码调试-next">react源码调试环境构建</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="/react/react源码调试">react源码调试</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="/react/react源码起始篇">react源码起始篇</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="/react/Lanes模型">Lanes模型</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="/react/Fiber">Fiber</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="/react/浏览器一帧里做了什么">浏览器一帧里做了什么</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="/react/任务调度">任务调度</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="/react/UpdateQueue">UpdateQueue</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="/react/beginWork-fiber创建">beginWork-fiber创建</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="/react/beginWork-fiber更新">beginWork-fiber更新</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="/react/completeWork">completeWork</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="/react/hooks实现">hooks实现</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item active" href="/react/commitWork">commitWork</a><ul class="sidebar-links"><li class="sidebar-link"><a class="sidebar-link-item" href="#flushpassiveeffects">flushPassiveEffects</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="#commitpassiveunmounteffects">commitPassiveUnmountEffects</a><ul class="sidebar-links"><li class="sidebar-link"><a class="sidebar-link-item" href="#commitpassiveunmounteffects-begin">commitPassiveUnmountEffects_begin</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="#commitpassiveunmounteffectsinsideofdeletedtree-begin">commitPassiveUnmountEffectsInsideOfDeletedTree_begin</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="#commithookeffectlistunmount">commitHookEffectListUnmount</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="#commitpassiveunmounteffectsinsideofdeletedtree-complete">commitPassiveUnmountEffectsInsideOfDeletedTree_complete</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="#commitpassiveunmounteffects-complete">commitPassiveUnmountEffects_complete</a><!----></li></ul></li><li class="sidebar-link"><a class="sidebar-link-item" href="#commitpassivemounteffects">commitPassiveMountEffects</a><ul class="sidebar-links"><li class="sidebar-link"><a class="sidebar-link-item" href="#commitpassivemounteffects-begin">commitPassiveMountEffects_begin</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="#commitpassivemounteffects-complete">commitPassiveMountEffects_complete</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="#commitpassivemountonfiber">commitPassiveMountOnFiber</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="#commithookeffectlistmount">commitHookEffectListMount</a><!----></li></ul></li><li class="sidebar-link"><a class="sidebar-link-item" href="#变量重置">变量重置</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="#beforemutation-阶段">beforeMutation 阶段</a><ul class="sidebar-links"><li class="sidebar-link"><a class="sidebar-link-item" href="#commitbeforemutationeffects">commitBeforeMutationEffects</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="#commitbeforemutationeffects-begin">commitBeforeMutationEffects_begin</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="#commitbeforemutationeffects-complete">commitBeforeMutationEffects_complete</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="#commitbeforemutationeffectsonfiber">commitBeforeMutationEffectsOnFiber</a><!----></li></ul></li><li class="sidebar-link"><a class="sidebar-link-item" href="#mutation-阶段">mutation 阶段</a><ul class="sidebar-links"><li class="sidebar-link"><a class="sidebar-link-item" href="#commitmutationeffects">commitMutationEffects</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="#unmounthostcomponents">unmountHostComponents</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="#commitunmount">commitUnmount</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="#commitmutationeffects-complete">commitMutationEffects_complete</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="#commitmutationeffectsonfiber">commitMutationEffectsOnFiber</a><!----></li></ul></li><li class="sidebar-link"><a class="sidebar-link-item" href="#layout-阶段">layout 阶段</a><ul class="sidebar-links"><li class="sidebar-link"><a class="sidebar-link-item" href="#commitlayouteffects">commitLayoutEffects</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="#commitlayouteffectonfiber">commitLayoutEffectOnFiber</a><!----></li></ul></li><li class="sidebar-link"><a class="sidebar-link-item" href="#最后">最后</a><!----></li></ul></li><li class="sidebar-link"><a class="sidebar-link-item" href="/react/Suspense实现">Suspense实现</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="/react/事件系统">事件系统</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="/react/手写简版redux">手写简版redux</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="/react/手写简版react-redux">手写简版react-redux</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="/react/阅读资料">阅读资料</a><!----></li></ul></li><!--]--></ul><!--[--><!--]--></aside><div class="sidebar-mask"></div><main class="page" data-v-7eddb2c4><div class="container" data-v-7eddb2c4><!--[--><!--]--><div style="position:relative;" class="content" data-v-7eddb2c4><div><h1 id="commitwork-阶段" tabindex="-1">commitWork 阶段 <a class="header-anchor" href="#commitwork-阶段" aria-hidden="true">#</a></h1><p><code>beginWork</code>和<code>completeWork</code>阶段都正常结束后，此时所有的<code>fiber</code>和真实节点创建完成，进入到<code>commit</code>阶段：</p><div class="language-javascript"><pre><code><span class="token keyword">const</span> <span class="token literal-property property">finishedWork</span><span class="token operator">:</span> Fiber <span class="token operator">=</span> <span class="token punctuation">(</span>root<span class="token punctuation">.</span>current<span class="token punctuation">.</span>alternate<span class="token operator">:</span> any<span class="token punctuation">)</span><span class="token punctuation">;</span>
root<span class="token punctuation">.</span>finishedWork <span class="token operator">=</span> finishedWork<span class="token punctuation">;</span>
root<span class="token punctuation">.</span>finishedLanes <span class="token operator">=</span> lanes<span class="token punctuation">;</span>
<span class="token function">finishConcurrentRender</span><span class="token punctuation">(</span>root<span class="token punctuation">,</span> exitStatus<span class="token punctuation">,</span> lanes<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>当结果为<code>RootCompleted</code>时，<code>finishConcurrentRender</code>函数会调用<code>commitRoot(root)</code>方法：</p><div class="language-javascript"><pre><code><span class="token keyword">function</span> <span class="token function">commitRoot</span><span class="token punctuation">(</span><span class="token parameter">root</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> previousUpdateLanePriority <span class="token operator">=</span> <span class="token function">getCurrentUpdatePriority</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> prevTransition <span class="token operator">=</span> ReactCurrentBatchConfig<span class="token punctuation">.</span>transition<span class="token punctuation">;</span>
  <span class="token keyword">try</span> <span class="token punctuation">{</span>
    ReactCurrentBatchConfig<span class="token punctuation">.</span>transition <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token comment">// 优先级为同步，不可被打断</span>
    <span class="token function">setCurrentUpdatePriority</span><span class="token punctuation">(</span>DiscreteEventPriority<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">commitRootImpl</span><span class="token punctuation">(</span>root<span class="token punctuation">,</span> previousUpdateLanePriority<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
    ReactCurrentBatchConfig<span class="token punctuation">.</span>transition <span class="token operator">=</span> prevTransition<span class="token punctuation">;</span>
    <span class="token function">setCurrentUpdatePriority</span><span class="token punctuation">(</span>previousUpdateLanePriority<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p><code>commit</code>执行时，会将当前优先级置为<code>DiscreteEventPriority</code>，也就是同步优先级，为同步执行，不可被打断。</p><h2 id="flushpassiveeffects" tabindex="-1">flushPassiveEffects <a class="header-anchor" href="#flushpassiveeffects" aria-hidden="true">#</a></h2><p><code>commit</code>第一步会执行<code>flushPassiveEffects</code>方法：</p><div class="language-javascript"><pre><code><span class="token keyword">do</span> <span class="token punctuation">{</span>
  <span class="token function">flushPassiveEffects</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span>rootWithPendingPassiveEffects <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>那么什么时候<code>rootWithPendingPassiveEffects !== null</code>成立呢？在<code>commitRootImpl</code>方法后半段会进行赋值：</p><div class="language-javascript"><pre><code><span class="token keyword">if</span> <span class="token punctuation">(</span>rootDoesHavePassiveEffects<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  rootDoesHavePassiveEffects <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  rootWithPendingPassiveEffects <span class="token operator">=</span> root<span class="token punctuation">;</span>
  pendingPassiveEffectsLanes <span class="token operator">=</span> lanes<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>如果<code>rootDoesHavePassiveEffects</code>成立，那么会将<code>root</code>赋值给<code>rootWithPendingPassiveEffects</code>。那么下一轮<code>commit</code>时，<code>rootWithPendingPassiveEffects !== null</code> 就会成立了。还是在这个函数中，再看看<code>rootDoesHavePassiveEffects</code>变量：</p><div class="language-javascript"><pre><code><span class="token keyword">if</span> <span class="token punctuation">(</span>
  <span class="token punctuation">(</span>finishedWork<span class="token punctuation">.</span>subtreeFlags <span class="token operator">&amp;</span> PassiveMask<span class="token punctuation">)</span> <span class="token operator">!==</span> NoFlags <span class="token operator">||</span>
  <span class="token punctuation">(</span>finishedWork<span class="token punctuation">.</span>flags <span class="token operator">&amp;</span> PassiveMask<span class="token punctuation">)</span> <span class="token operator">!==</span> NoFlags
<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>rootDoesHavePassiveEffects<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    rootDoesHavePassiveEffects <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token function">scheduleCallback</span><span class="token punctuation">(</span>NormalSchedulerPriority<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token function">flushPassiveEffects</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>如果<code>flags/subtreeFlags</code>中存在<code>PassiveMask</code>，即<code>Passive|ChildDeletion</code>，那么<code>rootDoesHavePassiveEffects</code>为<code>true</code>。也就是说如果使用了<code>useEffect</code>或者是节点有删除的情况，那么就会执行<code>flushPassiveEffects</code>方法：</p><div class="language-javascript"><pre><code><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">flushPassiveEffects</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> boolean <span class="token punctuation">{</span>
  <span class="token comment">// 如果 rootWithPendingPassiveEffects 存在，说明使用了 useEffect 或者有子节点被删除</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>rootWithPendingPassiveEffects <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> renderPriority <span class="token operator">=</span> <span class="token function">lanesToEventPriority</span><span class="token punctuation">(</span>pendingPassiveEffectsLanes<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> priority <span class="token operator">=</span> <span class="token function">lowerEventPriority</span><span class="token punctuation">(</span>DefaultEventPriority<span class="token punctuation">,</span> renderPriority<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> prevTransition <span class="token operator">=</span> ReactCurrentBatchConfig<span class="token punctuation">.</span>transition<span class="token punctuation">;</span>
    <span class="token keyword">const</span> previousPriority <span class="token operator">=</span> <span class="token function">getCurrentUpdatePriority</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
      <span class="token comment">// transition 置为 0</span>
      ReactCurrentBatchConfig<span class="token punctuation">.</span>transition <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
      <span class="token comment">// 设置 update 优先级，获取 lane 的时候会用得到</span>
      <span class="token function">setCurrentUpdatePriority</span><span class="token punctuation">(</span>priority<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> <span class="token function">flushPassiveEffectsImpl</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
      <span class="token function">setCurrentUpdatePriority</span><span class="token punctuation">(</span>previousPriority<span class="token punctuation">)</span><span class="token punctuation">;</span>
      ReactCurrentBatchConfig<span class="token punctuation">.</span>transition <span class="token operator">=</span> prevTransition<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>设置更新的优先级后，会执行两个方法：一个是卸载方法，一个是挂载方法。</p><div class="language-javascript"><pre><code><span class="token comment">// 从下到 sibling 到 return 这种深度遍历的方式，一次执行 effect 的 destroy 方法</span>
<span class="token function">commitPassiveUnmountEffects</span><span class="token punctuation">(</span>root<span class="token punctuation">.</span>current<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 遍历 root.current 的 updateQueue，执行上面的 effect 的 create 方法</span>
<span class="token function">commitPassiveMountEffects</span><span class="token punctuation">(</span>root<span class="token punctuation">,</span> root<span class="token punctuation">.</span>current<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h2 id="commitpassiveunmounteffects" tabindex="-1">commitPassiveUnmountEffects <a class="header-anchor" href="#commitpassiveunmounteffects" aria-hidden="true">#</a></h2><h3 id="commitpassiveunmounteffects-begin" tabindex="-1">commitPassiveUnmountEffects_begin <a class="header-anchor" href="#commitpassiveunmounteffects-begin" aria-hidden="true">#</a></h3><p><code>commitPassiveUnmountEffects</code>实际调用的是<code>commitPassiveUnmountEffects_begin</code>方法，该方法首先会向下遍历，对于有<code>ChildDeletion</code>标记的都会遍历<code>fiber.deletions</code>（记录了需要删除的老<code>fiber</code>）执行真实节点的删除：</p><div class="language-javascript"><pre><code><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>nextEffect<span class="token punctuation">.</span>flags <span class="token operator">&amp;</span> ChildDeletion<span class="token punctuation">)</span> <span class="token operator">!==</span> NoFlags<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> deletions <span class="token operator">=</span> fiber<span class="token punctuation">.</span>deletions<span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>deletions <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>i <span class="token operator">&lt;</span> deletions<span class="token punctuation">.</span>length<span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> fiberToDelete <span class="token operator">=</span> deletions<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
      nextEffect <span class="token operator">=</span> fiberToDelete<span class="token punctuation">;</span>
      <span class="token comment">// 进行具体 delete</span>
      <span class="token function">commitPassiveUnmountEffectsInsideOfDeletedTree_begin</span><span class="token punctuation">(</span>
        fiberToDelete<span class="token punctuation">,</span>
        fiber<span class="token punctuation">,</span>
      <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="commitpassiveunmounteffectsinsideofdeletedtree-begin" tabindex="-1">commitPassiveUnmountEffectsInsideOfDeletedTree_begin <a class="header-anchor" href="#commitpassiveunmounteffectsinsideofdeletedtree-begin" aria-hidden="true">#</a></h3><p><code>commitPassiveUnmountEffectsInsideOfDeletedTree_begin</code>方法同样会向下遍历，对于遍历到的<code>function</code>组件，执行卸载方法：</p><div class="language-javascript"><pre><code><span class="token function">commitPassiveUnmountInsideDeletedTreeOnFiber</span><span class="token punctuation">(</span>fiber<span class="token punctuation">,</span> nearestMountedAncestor<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function">commitPassiveUnmountInsideDeletedTreeOnFiber</span><span class="token punctuation">(</span>
  <span class="token parameter"><span class="token literal-property property">current</span><span class="token operator">:</span> Fiber<span class="token punctuation">,</span>
  <span class="token literal-property property">nearestMountedAncestor</span><span class="token operator">:</span> Fiber <span class="token operator">|</span> <span class="token keyword">null</span><span class="token punctuation">,</span></span>
<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span> <span class="token punctuation">{</span>
  <span class="token keyword">switch</span> <span class="token punctuation">(</span>current<span class="token punctuation">.</span>tag<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">case</span> <span class="token literal-property property">FunctionComponent</span><span class="token operator">:</span>
    <span class="token keyword">case</span> <span class="token literal-property property">ForwardRef</span><span class="token operator">:</span>
    <span class="token keyword">case</span> <span class="token literal-property property">SimpleMemoComponent</span><span class="token operator">:</span> <span class="token punctuation">{</span>
			<span class="token comment">// 执行卸载方法</span>
      <span class="token function">commitHookEffectListUnmount</span><span class="token punctuation">(</span>
        HookPassive<span class="token punctuation">,</span>
        current<span class="token punctuation">,</span>
        nearestMountedAncestor<span class="token punctuation">,</span>
      <span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="commithookeffectlistunmount" tabindex="-1">commitHookEffectListUnmount <a class="header-anchor" href="#commithookeffectlistunmount" aria-hidden="true">#</a></h3><p><code>commitHookEffectListUnmount</code>方法会循环执行<code>fiber</code>上的<code>effects</code>(如果使用了<code>useEffect/useLayoutEffect</code>等，会创建<code>effect</code>，并形成链表挂载到<code>fiber.updateQueue.effects.lastEffect</code>上)：</p><div class="language-javascript"><pre><code><span class="token keyword">const</span> firstEffect <span class="token operator">=</span> lastEffect<span class="token punctuation">.</span>next<span class="token punctuation">;</span>
<span class="token comment">// 找到第一个 effect</span>
<span class="token keyword">let</span> effect <span class="token operator">=</span> firstEffect<span class="token punctuation">;</span>
<span class="token keyword">do</span> <span class="token punctuation">{</span>
  <span class="token comment">// 如果 tag 包含 flags</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>effect<span class="token punctuation">.</span>tag <span class="token operator">&amp;</span> flags<span class="token punctuation">)</span> <span class="token operator">===</span> flags<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> destroy <span class="token operator">=</span> effect<span class="token punctuation">.</span>destroy<span class="token punctuation">;</span>
    effect<span class="token punctuation">.</span>destroy <span class="token operator">=</span> <span class="token keyword">undefined</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>destroy <span class="token operator">!==</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">safelyCallDestroy</span><span class="token punctuation">(</span>finishedWork<span class="token punctuation">,</span> nearestMountedAncestor<span class="token punctuation">,</span> destroy<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  effect <span class="token operator">=</span> effect<span class="token punctuation">.</span>next<span class="token punctuation">;</span>
<span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span>effect <span class="token operator">!==</span> firstEffect<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>由于这里的<code>tag</code>为<code>HookPassive</code>，因此只有<code>useEffect</code>里的<code>destroy</code>方法才会被执行，而<code>useLayoutEffect</code>里的<code>destroy</code>不会被执行。</p><h3 id="commitpassiveunmounteffectsinsideofdeletedtree-complete" tabindex="-1">commitPassiveUnmountEffectsInsideOfDeletedTree_complete <a class="header-anchor" href="#commitpassiveunmounteffectsinsideofdeletedtree-complete" aria-hidden="true">#</a></h3><p>在执行了<code>destroy</code>方法后，会删除<code>fiber</code>引用并且删除对应真实节点的引用：</p><div class="language-javascript"><pre><code><span class="token keyword">function</span> <span class="token function">detachFiberAfterEffects</span><span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">fiber</span><span class="token operator">:</span> Fiber</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  fiber<span class="token punctuation">.</span>child <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  fiber<span class="token punctuation">.</span>deletions <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  fiber<span class="token punctuation">.</span>sibling <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  
  <span class="token comment">// ...</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>fiber<span class="token punctuation">.</span>tag <span class="token operator">===</span> HostComponent<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token literal-property property">hostInstance</span><span class="token operator">:</span> Instance <span class="token operator">=</span> fiber<span class="token punctuation">.</span>stateNode<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>hostInstance <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">detachDeletedInstance</span><span class="token punctuation">(</span>hostInstance<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  fiber<span class="token punctuation">.</span>stateNode <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>

	<span class="token comment">// ...</span>
<span class="token punctuation">}</span>
</code></pre></div><p>如果是普通便签，且<code>fiber.stateNode</code>存在，那么需要调用<code>detachDeletedInstance</code>方法删除<code>node</code>节点上的一些引用：</p><div class="language-javascript"><pre><code><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">detachDeletedInstance</span><span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">node</span><span class="token operator">:</span> Instance</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span> <span class="token punctuation">{</span>
  <span class="token keyword">delete</span> <span class="token punctuation">(</span>node<span class="token operator">:</span> any<span class="token punctuation">)</span><span class="token punctuation">[</span>internalInstanceKey<span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token keyword">delete</span> <span class="token punctuation">(</span>node<span class="token operator">:</span> any<span class="token punctuation">)</span><span class="token punctuation">[</span>internalPropsKey<span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token keyword">delete</span> <span class="token punctuation">(</span>node<span class="token operator">:</span> any<span class="token punctuation">)</span><span class="token punctuation">[</span>internalEventHandlersKey<span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token keyword">delete</span> <span class="token punctuation">(</span>node<span class="token operator">:</span> any<span class="token punctuation">)</span><span class="token punctuation">[</span>internalEventHandlerListenersKey<span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token keyword">delete</span> <span class="token punctuation">(</span>node<span class="token operator">:</span> any<span class="token punctuation">)</span><span class="token punctuation">[</span>internalEventHandlesSetKey<span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>回到<code>commitPassiveUnmountEffects_begin</code>方法，在执行了老<code>fiber</code>子节点的删除后，还需要将老<code>fiber</code>与子节点，未删除子节点与已删除子节点之间的引用删除：</p><div class="language-javascript"><pre><code><span class="token keyword">const</span> previousFiber <span class="token operator">=</span> fiber<span class="token punctuation">.</span>alternate<span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>previousFiber <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> detachedChild <span class="token operator">=</span> previousFiber<span class="token punctuation">.</span>child<span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>detachedChild <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    previousFiber<span class="token punctuation">.</span>child <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token keyword">do</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> detachedSibling <span class="token operator">=</span> detachedChild<span class="token punctuation">.</span>sibling<span class="token punctuation">;</span>
      <span class="token comment">// 挨个将 sibling 指向置空</span>
      detachedChild<span class="token punctuation">.</span>sibling <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
      detachedChild <span class="token operator">=</span> detachedSibling<span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span>detachedChild <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="commitpassiveunmounteffects-complete" tabindex="-1">commitPassiveUnmountEffects_complete <a class="header-anchor" href="#commitpassiveunmounteffects-complete" aria-hidden="true">#</a></h3><p>向下查找直到找到不是<code>PassiveMask</code>的节点，此时执行<code>commitPassiveUnmountEffects_complete</code>方法：</p><div class="language-javascript"><pre><code><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>fiber<span class="token punctuation">.</span>flags <span class="token operator">&amp;</span> Passive<span class="token punctuation">)</span> <span class="token operator">!==</span> NoFlags<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 循环执行 unmount 下的 destroy 方法</span>
  <span class="token function">commitPassiveUnmountOnFiber</span><span class="token punctuation">(</span>fiber<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>该方法会向上查找，是否有<code>flags</code>包含<code>Passive</code>的<code>fiber</code>。如果有，同样会调用<code>commitPassiveUnmountOnFiber</code>执行<code>effect</code>的<code>destroy</code>方法。这样整棵树中有<code>ChildDeletion</code>和<code>Passive</code>标记的<code>fiber</code>中的卸载方法就全都执行了。</p><h2 id="commitpassivemounteffects" tabindex="-1">commitPassiveMountEffects <a class="header-anchor" href="#commitpassivemounteffects" aria-hidden="true">#</a></h2><h3 id="commitpassivemounteffects-begin" tabindex="-1">commitPassiveMountEffects_begin <a class="header-anchor" href="#commitpassivemounteffects-begin" aria-hidden="true">#</a></h3><p><code>commitPassiveMountEffects_begin</code>方法作用是向下查找，找到一个非<code>PassiveMask</code>标记的节点：</p><div class="language-javascript"><pre><code><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>fiber<span class="token punctuation">.</span>subtreeFlags <span class="token operator">&amp;</span> PassiveMask<span class="token punctuation">)</span> <span class="token operator">!==</span> NoFlags <span class="token operator">&amp;&amp;</span> firstChild <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">ensureCorrectReturnPointer</span><span class="token punctuation">(</span>firstChild<span class="token punctuation">,</span> fiber<span class="token punctuation">)</span><span class="token punctuation">;</span>
  nextEffect <span class="token operator">=</span> firstChild<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="commitpassivemounteffects-complete" tabindex="-1">commitPassiveMountEffects_complete <a class="header-anchor" href="#commitpassivemounteffects-complete" aria-hidden="true">#</a></h3><p><code>commitPassiveMountEffects_complete</code>方法会从下往上查找有<code>Passive</code>标记的节点，并执行其<code>commitPassiveMountOnFiber</code>方法：</p><div class="language-javascript"><pre><code><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>fiber<span class="token punctuation">.</span>flags <span class="token operator">&amp;</span> Passive<span class="token punctuation">)</span> <span class="token operator">!==</span> NoFlags<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">commitPassiveMountOnFiber</span><span class="token punctuation">(</span>root<span class="token punctuation">,</span> fiber<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="commitpassivemountonfiber" tabindex="-1">commitPassiveMountOnFiber <a class="header-anchor" href="#commitpassivemountonfiber" aria-hidden="true">#</a></h3><p>对于函数式组件都会执行<code>commitHookEffectListMount</code>方法，此时<code>hook</code>的<code>tag</code>为<code>HookPassive | HookHasEffect</code>：</p><div class="language-javascript"><pre><code><span class="token keyword">function</span> <span class="token function">commitPassiveMountOnFiber</span><span class="token punctuation">(</span>
  <span class="token parameter"><span class="token literal-property property">finishedRoot</span><span class="token operator">:</span> FiberRoot<span class="token punctuation">,</span>
   <span class="token literal-property property">finishedWork</span><span class="token operator">:</span> Fiber<span class="token punctuation">,</span></span>
<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span> <span class="token punctuation">{</span>
  <span class="token keyword">switch</span> <span class="token punctuation">(</span>finishedWork<span class="token punctuation">.</span>tag<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">case</span> <span class="token literal-property property">FunctionComponent</span><span class="token operator">:</span>
    <span class="token keyword">case</span> <span class="token literal-property property">ForwardRef</span><span class="token operator">:</span>
    <span class="token keyword">case</span> <span class="token literal-property property">SimpleMemoComponent</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token function">commitHookEffectListMount</span><span class="token punctuation">(</span>HookPassive <span class="token operator">|</span> HookHasEffect<span class="token punctuation">,</span> finishedWork<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="commithookeffectlistmount" tabindex="-1">commitHookEffectListMount <a class="header-anchor" href="#commithookeffectlistmount" aria-hidden="true">#</a></h3><p><code>commitHookEffectListMount</code>则是循环调用<code>effects</code>里的<code>create</code>方法并生成<code>destroy</code>：</p><div class="language-javascript"><pre><code><span class="token keyword">const</span> firstEffect <span class="token operator">=</span> lastEffect<span class="token punctuation">.</span>next<span class="token punctuation">;</span>
<span class="token comment">// 找到第一个 effect</span>
<span class="token keyword">let</span> effect <span class="token operator">=</span> firstEffect<span class="token punctuation">;</span>
<span class="token keyword">do</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>effect<span class="token punctuation">.</span>tag <span class="token operator">&amp;</span> tag<span class="token punctuation">)</span> <span class="token operator">===</span> tag<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 调用 create 方法</span>
    <span class="token keyword">const</span> create <span class="token operator">=</span> effect<span class="token punctuation">.</span>create<span class="token punctuation">;</span>
    effect<span class="token punctuation">.</span>destroy <span class="token operator">=</span> <span class="token function">create</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    effect <span class="token operator">=</span> effect<span class="token punctuation">.</span>next<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span>effect <span class="token operator">!==</span> firstEffect<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h2 id="变量重置" tabindex="-1">变量重置 <a class="header-anchor" href="#变量重置" aria-hidden="true">#</a></h2><p>一些列全局的变量重置：</p><div class="language-javascript"><pre><code><span class="token keyword">const</span> finishedWork <span class="token operator">=</span> root<span class="token punctuation">.</span>finishedWork<span class="token punctuation">;</span>
<span class="token keyword">const</span> lanes <span class="token operator">=</span> root<span class="token punctuation">.</span>finishedLanes<span class="token punctuation">;</span>

root<span class="token punctuation">.</span>finishedWork <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
root<span class="token punctuation">.</span>finishedLanes <span class="token operator">=</span> NoLanes<span class="token punctuation">;</span>

<span class="token comment">// 任务重置</span>
root<span class="token punctuation">.</span>callbackNode <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
root<span class="token punctuation">.</span>callbackPriority <span class="token operator">=</span> NoLane<span class="token punctuation">;</span>

<span class="token comment">// 移除 lane</span>
<span class="token keyword">let</span> remainingLanes <span class="token operator">=</span> <span class="token function">mergeLanes</span><span class="token punctuation">(</span>finishedWork<span class="token punctuation">.</span>lanes<span class="token punctuation">,</span> finishedWork<span class="token punctuation">.</span>childLanes<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">markRootFinished</span><span class="token punctuation">(</span>root<span class="token punctuation">,</span> remainingLanes<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">if</span> <span class="token punctuation">(</span>root <span class="token operator">===</span> workInProgressRoot<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token comment">// 重置</span>
  workInProgressRoot <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  workInProgress <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  workInProgressRootRenderLanes <span class="token operator">=</span> NoLanes<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>重置完成后判断是否具有<code>PassiveMask</code>（最开始的<code>flushPassiveEffects</code>与这里的判断有关）。如果之前<code>rootDoesHavePassiveEffects</code>为<code>false</code>，表示<code>effect</code>还未被记录，此时需要调用一次<code>flushPassiveEffects</code>方法。</p><div class="language-javascript"><pre><code><span class="token keyword">if</span> <span class="token punctuation">(</span>
  <span class="token punctuation">(</span>finishedWork<span class="token punctuation">.</span>subtreeFlags <span class="token operator">&amp;</span> PassiveMask<span class="token punctuation">)</span> <span class="token operator">!==</span> NoFlags <span class="token operator">||</span>
  <span class="token punctuation">(</span>finishedWork<span class="token punctuation">.</span>flags <span class="token operator">&amp;</span> PassiveMask<span class="token punctuation">)</span> <span class="token operator">!==</span> NoFlags
<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>rootDoesHavePassiveEffects<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    rootDoesHavePassiveEffects <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token function">scheduleCallback</span><span class="token punctuation">(</span>NormalSchedulerPriority<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token function">flushPassiveEffects</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>执行<code>flushPassiveEffects</code>时，会先遍历执行<code>destroy</code>，由于第一次创建没有<code>destroy</code>，所以不会执行。然后会遍历执行<code>create</code>，并且生成<code>destroy</code>。</p><h2 id="beforemutation-阶段" tabindex="-1">beforeMutation 阶段 <a class="header-anchor" href="#beforemutation-阶段" aria-hidden="true">#</a></h2><h3 id="commitbeforemutationeffects" tabindex="-1">commitBeforeMutationEffects <a class="header-anchor" href="#commitbeforemutationeffects" aria-hidden="true">#</a></h3><div class="language-javascript"><pre><code><span class="token keyword">const</span> subtreeHasEffects <span class="token operator">=</span>
  <span class="token punctuation">(</span>finishedWork<span class="token punctuation">.</span>subtreeFlags <span class="token operator">&amp;</span>
    <span class="token punctuation">(</span>BeforeMutationMask <span class="token operator">|</span> MutationMask <span class="token operator">|</span> LayoutMask <span class="token operator">|</span> PassiveMask<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!==</span>
  NoFlags<span class="token punctuation">;</span>
<span class="token keyword">const</span> rootHasEffect <span class="token operator">=</span>
  <span class="token punctuation">(</span>finishedWork<span class="token punctuation">.</span>flags <span class="token operator">&amp;</span>
    <span class="token punctuation">(</span>BeforeMutationMask <span class="token operator">|</span> MutationMask <span class="token operator">|</span> LayoutMask <span class="token operator">|</span> PassiveMask<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!==</span>
  NoFlags<span class="token punctuation">;</span>
</code></pre></div><p>如果<code>subtreeHasEffects</code>或<code>rootHasEffect</code>存在，说明有更新。首先会进入<code>beforeMutation</code>阶段，调用<code>commitBeforeMutationEffects</code>方法：</p><div class="language-javascript"><pre><code><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">commitBeforeMutationEffects</span><span class="token punctuation">(</span>
  <span class="token parameter"><span class="token literal-property property">root</span><span class="token operator">:</span> FiberRoot<span class="token punctuation">,</span>
  <span class="token literal-property property">firstChild</span><span class="token operator">:</span> Fiber<span class="token punctuation">,</span></span>
<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// ...</span>
  <span class="token function">commitBeforeMutationEffects_begin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// ...</span>
<span class="token punctuation">}</span>
</code></pre></div><p>其核心是调用<code>commitBeforeMutationEffects_begin</code>方法。</p><h3 id="commitbeforemutationeffects-begin" tabindex="-1">commitBeforeMutationEffects_begin <a class="header-anchor" href="#commitbeforemutationeffects-begin" aria-hidden="true">#</a></h3><p>与<code>flushPassiveEffects</code>中类似，这里以<code>_begin</code>结尾的函数都是向下遍历，直到找到一个不符合<code>BeforeMutationMask</code>的节点。</p><div class="language-javascript"><pre><code><span class="token keyword">export</span> <span class="token keyword">const</span> BeforeMutationMask <span class="token operator">=</span> Update <span class="token operator">|</span> Snapshot
</code></pre></div><p>一种是标记了<code>Update</code>的节点，一种是标记<code>SnapShot</code>的节点，如在<code>class</code>组件中定义了<code>getSnapshotBeforeUpdate</code>函数，那么在<code>beginWork</code>阶段就会将<code>fiber</code>标记为<code>SnapShot</code>。</p><h3 id="commitbeforemutationeffects-complete" tabindex="-1">commitBeforeMutationEffects_complete <a class="header-anchor" href="#commitbeforemutationeffects-complete" aria-hidden="true">#</a></h3><p>以<code>_complete</code>结尾的函数都是从下往上遍历，然后执行某个函数。这里执行的函数为<code>commitBeforeMutationEffectsOnFiber</code>。</p><h3 id="commitbeforemutationeffectsonfiber" tabindex="-1">commitBeforeMutationEffectsOnFiber <a class="header-anchor" href="#commitbeforemutationeffectsonfiber" aria-hidden="true">#</a></h3><div class="language-javascript"><pre><code><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>flags <span class="token operator">&amp;</span> Snapshot<span class="token punctuation">)</span> <span class="token operator">!==</span> NoFlags<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">switch</span> <span class="token punctuation">(</span>finishedWork<span class="token punctuation">.</span>tag<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">case</span> <span class="token literal-property property">ClassComponent</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>current <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> prevProps <span class="token operator">=</span> current<span class="token punctuation">.</span>memoizedProps<span class="token punctuation">;</span>
        <span class="token keyword">const</span> prevState <span class="token operator">=</span> current<span class="token punctuation">.</span>memoizedState<span class="token punctuation">;</span>
        <span class="token keyword">const</span> instance <span class="token operator">=</span> finishedWork<span class="token punctuation">.</span>stateNode<span class="token punctuation">;</span>
        <span class="token keyword">const</span> snapshot <span class="token operator">=</span> instance<span class="token punctuation">.</span><span class="token function">getSnapshotBeforeUpdate</span><span class="token punctuation">(</span>
          finishedWork<span class="token punctuation">.</span>elementType <span class="token operator">===</span> finishedWork<span class="token punctuation">.</span>type
          <span class="token operator">?</span> prevProps
          <span class="token operator">:</span> <span class="token function">resolveDefaultProps</span><span class="token punctuation">(</span>finishedWork<span class="token punctuation">.</span>type<span class="token punctuation">,</span> prevProps<span class="token punctuation">)</span><span class="token punctuation">,</span>
          prevState<span class="token punctuation">,</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
        instance<span class="token punctuation">.</span>__reactInternalSnapshotBeforeUpdate <span class="token operator">=</span> snapshot<span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">case</span> <span class="token literal-property property">HostRoot</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>supportsMutation<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> root <span class="token operator">=</span> finishedWork<span class="token punctuation">.</span>stateNode<span class="token punctuation">;</span>
        <span class="token function">clearContainer</span><span class="token punctuation">(</span>root<span class="token punctuation">.</span>containerInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>如果<code>SnapShot</code>标记主要有两种情况：一种是<code>HostRoot</code>，在<code>completeWork</code>阶段会将其标记：</p><div class="language-javascript"><pre><code><span class="token keyword">if</span> <span class="token punctuation">(</span>current <span class="token operator">===</span> <span class="token keyword">null</span> <span class="token operator">||</span> current<span class="token punctuation">.</span>child <span class="token operator">===</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  workInProgress<span class="token punctuation">.</span>flags <span class="token operator">|=</span> Snapshot<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>如果<code>current或current.child</code>不存在，在<code>commit</code>阶段会将<code>root.containerInfo</code>真实节点的内容置空。</p><p>另一种情况是<code>class</code>组件定义了<code>getSnapshotBeforeUpdate</code>，此时会直接调用该函数，传入的值为先前的<code>props</code>和<code>state</code>。</p><h2 id="mutation-阶段" tabindex="-1">mutation 阶段 <a class="header-anchor" href="#mutation-阶段" aria-hidden="true">#</a></h2><h3 id="commitmutationeffects" tabindex="-1">commitMutationEffects <a class="header-anchor" href="#commitmutationeffects" aria-hidden="true">#</a></h3><p><code>commitMutationEffects</code>执行的是<code>commitMutationEffects_begin</code>方法：</p><div class="language-javascript"><pre><code><span class="token keyword">const</span> deletions <span class="token operator">=</span> fiber<span class="token punctuation">.</span>deletions<span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>deletions <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>i <span class="token operator">&lt;</span> deletions<span class="token punctuation">.</span>length<span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> childToDelete <span class="token operator">=</span> deletions<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token function">commitDeletion</span><span class="token punctuation">(</span>root<span class="token punctuation">,</span> childToDelete<span class="token punctuation">,</span> fiber<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>首先是循环遍历，向下执<code>commitDeletion</code>方法，等同于执行了<code>unmountHostComponents</code>方法。</p><h3 id="unmounthostcomponents" tabindex="-1">unmountHostComponents <a class="header-anchor" href="#unmounthostcomponents" aria-hidden="true">#</a></h3><p><code>unmountHostComponents</code>方法作用是删除<code>fiber</code>对应的真实节点。首先是找到这个<code>fiber</code>的父真实节点：</p><div class="language-javascript"><pre><code><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>currentParentIsValid<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> parent <span class="token operator">=</span> node<span class="token punctuation">.</span>return<span class="token punctuation">;</span>
  <span class="token literal-property property">findParent</span><span class="token operator">:</span> <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> parentStateNode <span class="token operator">=</span> parent<span class="token punctuation">.</span>stateNode<span class="token punctuation">;</span>
    <span class="token keyword">switch</span> <span class="token punctuation">(</span>parent<span class="token punctuation">.</span>tag<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">case</span> <span class="token literal-property property">HostComponent</span><span class="token operator">:</span>
        currentParent <span class="token operator">=</span> parentStateNode<span class="token punctuation">;</span>
        currentParentIsContainer <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
        <span class="token keyword">break</span> findParent<span class="token punctuation">;</span>
      <span class="token keyword">case</span> <span class="token literal-property property">HostRoot</span><span class="token operator">:</span>
        currentParent <span class="token operator">=</span> parentStateNode<span class="token punctuation">.</span>containerInfo<span class="token punctuation">;</span>
        currentParentIsContainer <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token keyword">break</span> findParent<span class="token punctuation">;</span>
      <span class="token keyword">case</span> <span class="token literal-property property">HostPortal</span><span class="token operator">:</span>
        currentParent <span class="token operator">=</span> parentStateNode<span class="token punctuation">.</span>containerInfo<span class="token punctuation">;</span>
        currentParentIsContainer <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
        <span class="token keyword">break</span> findParent<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    parent <span class="token operator">=</span> parent<span class="token punctuation">.</span>return<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  currentParentIsValid <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>只有<code>HostComponent、HostRoot、HostPortal</code>才会渲染成真实节点，其他的标签都是<code>React</code>内部定义，不会渲染出来。</p><p>然后判断当前节点的类型，如果是<code>HostComponent</code>或<code>HostText</code>类型：</p><div class="language-javascript"><pre><code><span class="token keyword">if</span> <span class="token punctuation">(</span>node<span class="token punctuation">.</span>tag <span class="token operator">===</span> HostComponent <span class="token operator">||</span> node<span class="token punctuation">.</span>tag <span class="token operator">===</span> HostText<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 1. 递归触发卸载事件。(useLayoutEffect/componentWillUnmount)</span>
  <span class="token function">commitNestedUnmounts</span><span class="token punctuation">(</span>finishedRoot<span class="token punctuation">,</span> node<span class="token punctuation">,</span> nearestMountedAncestor<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 2. 触发完事件，就需要移除真实节点</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>currentParentIsContainer<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">removeChildFromContainer</span><span class="token punctuation">(</span>
      <span class="token punctuation">(</span><span class="token punctuation">(</span>currentParent<span class="token operator">:</span> any<span class="token punctuation">)</span><span class="token operator">:</span> Container<span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token punctuation">(</span>node<span class="token punctuation">.</span>stateNode<span class="token operator">:</span> Instance <span class="token operator">|</span> TextInstance<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token comment">// 移除真实节点</span>
    <span class="token function">removeChild</span><span class="token punctuation">(</span>
      <span class="token punctuation">(</span><span class="token punctuation">(</span>currentParent<span class="token operator">:</span> any<span class="token punctuation">)</span><span class="token operator">:</span> Instance<span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token punctuation">(</span>node<span class="token punctuation">.</span>stateNode<span class="token operator">:</span> Instance <span class="token operator">|</span> TextInstance<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>首先是调用<code>commitNestedUnmounts</code>方法，这个方法会遍历该节点下的所有<code>fiber</code>，然后调用<code>commitUnmount</code>方法。（<strong>注意：向下遍历遇到HostPortal时不会调用commitUnmount</strong>）。</p><h3 id="commitunmount" tabindex="-1">commitUnmount <a class="header-anchor" href="#commitunmount" aria-hidden="true">#</a></h3><p>对于函数式组件，会循环执行带有<code>Layout</code>的<code>tag</code>的<code>effect</code>。</p><div class="language-javascript"><pre><code><span class="token keyword">do</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">{</span> destroy<span class="token punctuation">,</span> tag <span class="token punctuation">}</span> <span class="token operator">=</span> effect<span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>destroy <span class="token operator">!==</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 执行 layout 的 destroy，也就是 useLayoutEffect</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>tag <span class="token operator">&amp;</span> HookLayout<span class="token punctuation">)</span> <span class="token operator">!==</span> NoHookEffect<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">safelyCallDestroy</span><span class="token punctuation">(</span>current<span class="token punctuation">,</span> nearestMountedAncestor<span class="token punctuation">,</span> destroy<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  effect <span class="token operator">=</span> effect<span class="token punctuation">.</span>next<span class="token punctuation">;</span>
<span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span>effect <span class="token operator">!==</span> firstEffect<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>对于<code>class</code>组件，一是移除<code>ref</code>，二是调用<code>componentWillUnmount</code>方法：</p><div class="language-javascript"><pre><code><span class="token function">safelyDetachRef</span><span class="token punctuation">(</span>current<span class="token punctuation">,</span> nearestMountedAncestor<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> instance <span class="token operator">=</span> current<span class="token punctuation">.</span>stateNode<span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> instance<span class="token punctuation">.</span>componentWillUnmount <span class="token operator">===</span> <span class="token string">&#39;function&#39;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">safelyCallComponentWillUnmount</span><span class="token punctuation">(</span>
    current<span class="token punctuation">,</span>
    nearestMountedAncestor<span class="token punctuation">,</span>
    instance<span class="token punctuation">,</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>对于<code>HostPortal</code>，则是调用<code>unmountHostComponents</code>处理它的子节点。</p><h3 id="commitmutationeffects-complete" tabindex="-1">commitMutationEffects_complete <a class="header-anchor" href="#commitmutationeffects-complete" aria-hidden="true">#</a></h3><p>等删除节点操作完成后，回到<code>commitMutationEffects_begin</code>方法，会开始执行<code>commitMutationEffects_complete</code>方法。该方法会向上查找，并且调用<code>commitMutationEffectsOnFiber</code>方法。</p><h3 id="commitmutationeffectsonfiber" tabindex="-1">commitMutationEffectsOnFiber <a class="header-anchor" href="#commitmutationeffectsonfiber" aria-hidden="true">#</a></h3><p>对于不同的<code>flags</code>，<code>mutation</code>阶段会做不同的处理：</p><h4 id="contentreset" tabindex="-1">ContentReset <a class="header-anchor" href="#contentreset" aria-hidden="true">#</a></h4><p>表示需要按文本内容处理，并将内容置空：</p><div class="language-javascript"><pre><code><span class="token function">commitResetTextContent</span><span class="token punctuation">(</span>finishedWork<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h4 id="visibility" tabindex="-1">Visibility <a class="header-anchor" href="#visibility" aria-hidden="true">#</a></h4><p><code>suspense</code>相关处理，<code>suspense</code>章节再做讲解。</p><h4 id="placement" tabindex="-1">Placement <a class="header-anchor" href="#placement" aria-hidden="true">#</a></h4><p>表示插入节点。第一步需要找到该节点的父<code>fiber</code>节，注意，这里的父<code>fiber</code>必须是能够渲染成真实<code>DOM</code>的<code>fiber</code>。</p><div class="language-javascript"><pre><code><span class="token keyword">const</span> parentFiber <span class="token operator">=</span> <span class="token function">getHostParentFiber</span><span class="token punctuation">(</span>finishedWork<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function">getHostParentFiber</span><span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">fiber</span><span class="token operator">:</span> Fiber</span><span class="token punctuation">)</span><span class="token operator">:</span> Fiber <span class="token punctuation">{</span>
  <span class="token keyword">let</span> parent <span class="token operator">=</span> fiber<span class="token punctuation">.</span>return<span class="token punctuation">;</span>
  <span class="token keyword">while</span> <span class="token punctuation">(</span>parent <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isHostParent</span><span class="token punctuation">(</span>parent<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> parent<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    parent <span class="token operator">=</span> parent<span class="token punctuation">.</span>return<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">function</span> <span class="token function">isHostParent</span><span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">fiber</span><span class="token operator">:</span> Fiber</span><span class="token punctuation">)</span><span class="token operator">:</span> boolean <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token punctuation">(</span>
    fiber<span class="token punctuation">.</span>tag <span class="token operator">===</span> HostComponent <span class="token operator">||</span>
    fiber<span class="token punctuation">.</span>tag <span class="token operator">===</span> HostRoot <span class="token operator">||</span>
    fiber<span class="token punctuation">.</span>tag <span class="token operator">===</span> HostPortal
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>第二步通过父<code>fiber</code>获取真实节点：</p><div class="language-javascript"><pre><code><span class="token keyword">const</span> parentStateNode <span class="token operator">=</span> parentFiber<span class="token punctuation">.</span>stateNode<span class="token punctuation">;</span>
<span class="token comment">// 找到真实父节点</span>
<span class="token keyword">switch</span> <span class="token punctuation">(</span>parentFiber<span class="token punctuation">.</span>tag<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">case</span> <span class="token literal-property property">HostComponent</span><span class="token operator">:</span>
    parent <span class="token operator">=</span> parentStateNode<span class="token punctuation">;</span>
    isContainer <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token keyword">break</span><span class="token punctuation">;</span>
  <span class="token keyword">case</span> <span class="token literal-property property">HostRoot</span><span class="token operator">:</span>
    <span class="token comment">// 注意这里是添加到根节点上去了。</span>
    parent <span class="token operator">=</span> parentStateNode<span class="token punctuation">.</span>containerInfo<span class="token punctuation">;</span>
    isContainer <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token keyword">break</span><span class="token punctuation">;</span>
  <span class="token keyword">case</span> <span class="token literal-property property">HostPortal</span><span class="token operator">:</span>
    <span class="token comment">// 注意这里是添加到根节点上去了。</span>
    parent <span class="token operator">=</span> parentStateNode<span class="token punctuation">.</span>containerInfo<span class="token punctuation">;</span>
    isContainer <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token keyword">break</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>第三步获取兄弟结点：</p><div class="language-javascript"><pre><code><span class="token keyword">const</span> before <span class="token operator">=</span> <span class="token function">getHostSibling</span><span class="token punctuation">(</span>finishedWork<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function">getHostSibling</span><span class="token punctuation">(</span><span class="token parameter"><span class="token literal-property property">fiber</span><span class="token operator">:</span> Fiber</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token operator">?</span>Instance <span class="token punctuation">{</span>
  <span class="token literal-property property">siblings</span><span class="token operator">:</span> <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 如果 sibling 不存在</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span>node<span class="token punctuation">.</span>sibling <span class="token operator">===</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 如果 return 不存在 获取 父亲是可以渲染成真实节点的 fiber</span>
      <span class="token comment">// 那么说明 sibling 确实是不存在的</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>node<span class="token punctuation">.</span>return <span class="token operator">===</span> <span class="token keyword">null</span> <span class="token operator">||</span> <span class="token function">isHostParent</span><span class="token punctuation">(</span>node<span class="token punctuation">.</span>return<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      node <span class="token operator">=</span> node<span class="token punctuation">.</span>return<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// sibling 存在时</span>
    node<span class="token punctuation">.</span>sibling<span class="token punctuation">.</span>return <span class="token operator">=</span> node<span class="token punctuation">.</span>return<span class="token punctuation">;</span>
    node <span class="token operator">=</span> node<span class="token punctuation">.</span>sibling<span class="token punctuation">;</span>
    <span class="token comment">// 向下查找，查找合适的主节点</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span>
      node<span class="token punctuation">.</span>tag <span class="token operator">!==</span> HostComponent <span class="token operator">&amp;&amp;</span>
      node<span class="token punctuation">.</span>tag <span class="token operator">!==</span> HostText <span class="token operator">&amp;&amp;</span>
      node<span class="token punctuation">.</span>tag <span class="token operator">!==</span> DehydratedFragment
    <span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 如果是标记为Placement的，那么是不可用的。</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>node<span class="token punctuation">.</span>flags <span class="token operator">&amp;</span> Placement<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">continue</span> siblings<span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>node<span class="token punctuation">.</span>child <span class="token operator">===</span> <span class="token keyword">null</span> <span class="token operator">||</span> node<span class="token punctuation">.</span>tag <span class="token operator">===</span> HostPortal<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">continue</span> siblings<span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token comment">// 查找孩子节点（因为react中fiber与实际的真实并不是完全对应的，如有的会形成一层包装）</span>
        node<span class="token punctuation">.</span>child<span class="token punctuation">.</span>return <span class="token operator">=</span> node<span class="token punctuation">;</span>
        node <span class="token operator">=</span> node<span class="token punctuation">.</span>child<span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// 如果找到的节点是不需要插入的节点，则返回该节点。</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token punctuation">(</span>node<span class="token punctuation">.</span>flags <span class="token operator">&amp;</span> Placement<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// Found it!</span>
      <span class="token keyword">return</span> node<span class="token punctuation">.</span>stateNode<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p><strong>需要注意的是，能渲染的真实节点的结构跟fiber结构并不会完全对应，可能会存在一些层次的包装，所以需要进行比较复杂的查找。</strong></p><p>第四步则是正式的插入节点了：</p><div class="language-javascript"><pre><code><span class="token keyword">if</span> <span class="token punctuation">(</span>isContainer<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">insertOrAppendPlacementNodeIntoContainer</span><span class="token punctuation">(</span>finishedWork<span class="token punctuation">,</span> before<span class="token punctuation">,</span> parent<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
  <span class="token function">insertOrAppendPlacementNode</span><span class="token punctuation">(</span>finishedWork<span class="token punctuation">,</span> before<span class="token punctuation">,</span> parent<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h4 id="update" tabindex="-1">Update <a class="header-anchor" href="#update" aria-hidden="true">#</a></h4><p>当标记为<code>Update</code>时，执行<code>commitWork</code>。</p><p><strong>当为函数组件时</strong></p><div class="language-javascript"><pre><code><span class="token function">commitHookEffectListUnmount</span><span class="token punctuation">(</span>
  HookLayout <span class="token operator">|</span> HookHasEffect<span class="token punctuation">,</span>
  finishedWork<span class="token punctuation">,</span>
  finishedWork<span class="token punctuation">.</span>return<span class="token punctuation">,</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>触发<code>useLayoutEffect</code>的<code>destroy</code>方法。</p><p><strong>当为普通真实节点时</strong></p><div class="language-javascript"><pre><code><span class="token keyword">const</span> <span class="token literal-property property">updatePayload</span><span class="token operator">:</span> <span class="token keyword">null</span> <span class="token operator">|</span> UpdatePayload <span class="token operator">=</span> <span class="token punctuation">(</span>finishedWork<span class="token punctuation">.</span>updateQueue<span class="token operator">:</span> any<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 如果有属性被更新了</span>
finishedWork<span class="token punctuation">.</span>updateQueue <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
<span class="token comment">// 更新真实节点的属性</span>
<span class="token function">commitUpdate</span><span class="token punctuation">(</span>
  instance<span class="token punctuation">,</span>
  updatePayload<span class="token punctuation">,</span>
  type<span class="token punctuation">,</span>
  oldProps<span class="token punctuation">,</span>
  newProps<span class="token punctuation">,</span>
  finishedWork<span class="token punctuation">,</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>如果属性有更新，那么会调用<code>commitUpdate</code>（<code>DOM</code>属性处理的方法）更新真实<code>DOM</code>上的属性，如<code>style，href</code>等等。</p><h2 id="layout-阶段" tabindex="-1">layout 阶段 <a class="header-anchor" href="#layout-阶段" aria-hidden="true">#</a></h2><h3 id="commitlayouteffects" tabindex="-1">commitLayoutEffects <a class="header-anchor" href="#commitlayouteffects" aria-hidden="true">#</a></h3><p><code>commitLayoutEffects</code>调用<code>commitLayoutEffects_begin</code>方法，还是一样，找到第一个不是<code>LayoutMask</code>的子节点，然后向上执行<code>commitLayoutEffectOnFiber</code>方法。</p><h3 id="commitlayouteffectonfiber" tabindex="-1">commitLayoutEffectOnFiber <a class="header-anchor" href="#commitlayouteffectonfiber" aria-hidden="true">#</a></h3><h4 id="函数组件" tabindex="-1">函数组件 <a class="header-anchor" href="#函数组件" aria-hidden="true">#</a></h4><p>为函数组件时，执行<code>commitHookEffectListMount</code>方法，也就是<code>useLayoutEffect</code>的<code>create</code>方法。</p><div class="language-javascript"><pre><code><span class="token function">commitHookEffectListMount</span><span class="token punctuation">(</span>HookLayout <span class="token operator">|</span> HookHasEffect<span class="token punctuation">,</span> finishedWork<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h4 id="class-组件" tabindex="-1">class 组件 <a class="header-anchor" href="#class-组件" aria-hidden="true">#</a></h4><p>如果<code>flags</code>存在<code>Update</code>，说明定义了生命周期函数。当<code>current</code>为<code>null</code>的时候，说明是挂载阶段，调用<code>componentDidMount</code>方法：</p><div class="language-javascript"><pre><code>instance<span class="token punctuation">.</span><span class="token function">componentDidMount</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>否则说明是更新阶段，调用<code>componentDidUpdate</code>方法：</p><div class="language-javascript"><pre><code>instance<span class="token punctuation">.</span><span class="token function">componentDidUpdate</span><span class="token punctuation">(</span>
  prevProps<span class="token punctuation">,</span>
  prevState<span class="token punctuation">,</span>
  instance<span class="token punctuation">.</span>__reactInternalSnapshotBeforeUpdate<span class="token punctuation">,</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>最后，<code>state</code>更新完成之后，执行<code>update</code>上的回调函数：</p><div class="language-javascript"><pre><code><span class="token keyword">if</span> <span class="token punctuation">(</span>updateQueue <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">commitUpdateQueue</span><span class="token punctuation">(</span>finishedWork<span class="token punctuation">,</span> updateQueue<span class="token punctuation">,</span> instance<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">export</span> <span class="token keyword">function</span> commitUpdateQueue<span class="token operator">&lt;</span>State<span class="token operator">&gt;</span><span class="token punctuation">(</span>
  <span class="token literal-property property">finishedWork</span><span class="token operator">:</span> Fiber<span class="token punctuation">,</span>
  <span class="token literal-property property">finishedQueue</span><span class="token operator">:</span> UpdateQueue<span class="token operator">&lt;</span>State<span class="token operator">&gt;</span><span class="token punctuation">,</span>
  <span class="token literal-property property">instance</span><span class="token operator">:</span> any<span class="token punctuation">,</span>
<span class="token punctuation">)</span><span class="token operator">:</span> <span class="token keyword">void</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> effects <span class="token operator">=</span> finishedQueue<span class="token punctuation">.</span>effects<span class="token punctuation">;</span>
  finishedQueue<span class="token punctuation">.</span>effects <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>effects <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 依次执行已经update了的回调函数</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>i <span class="token operator">&lt;</span> effects<span class="token punctuation">.</span>length<span class="token punctuation">;</span>i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> effect <span class="token operator">=</span> effects<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">;</span>
      <span class="token keyword">const</span> callback <span class="token operator">=</span> effect<span class="token punctuation">.</span>callback<span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>callback <span class="token operator">!==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        effect<span class="token punctuation">.</span>callback <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token function">callCallback</span><span class="token punctuation">(</span>callback<span class="token punctuation">,</span> instance<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="最后" tabindex="-1">最后 <a class="header-anchor" href="#最后" aria-hidden="true">#</a></h2><p>在更新完成之后，更改<code>root.current</code>指向，相当于交换了<code>current</code>和<code>workInProgress</code>：</p><div class="language-javascript"><pre><code>root<span class="token punctuation">.</span>current <span class="token operator">=</span> finishedWork<span class="token punctuation">;</span>
</code></pre></div><p>然后再次进行调度：</p><div class="language-javascript"><pre><code><span class="token function">ensureRootIsScheduled</span><span class="token punctuation">(</span>root<span class="token punctuation">,</span> <span class="token function">now</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>如果还有未完成的更新，即优先级不够的更新，那么这里会被继续调度进行更新。</p><p>如果当前更新中包含<code>useEffect</code>，并且<code>lanes</code>中含有同步<code>lane</code>，那么需要立即执行<code>flushPassiveEffect</code>：</p><div class="language-javascript"><pre><code><span class="token keyword">if</span> <span class="token punctuation">(</span>
  <span class="token function">includesSomeLane</span><span class="token punctuation">(</span>pendingPassiveEffectsLanes<span class="token punctuation">,</span> SyncLane<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
  root<span class="token punctuation">.</span>tag <span class="token operator">!==</span> LegacyRoot
<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">flushPassiveEffects</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>相比于<code>schedule</code>执行<code>flushPassiveEffects</code>，这里执行更靠前。</p><p>最后还会执行<code>flushSyncCallbacks</code>：</p><div class="language-javascript"><pre><code><span class="token function">flushSyncCallbacks</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>该函数用于将立即执行<code>layout</code>里新添加的任务。</p></div></div><footer class="page-footer" data-v-7eddb2c4 data-v-07c132fc><div class="edit" data-v-07c132fc><div class="edit-link" data-v-07c132fc data-v-1ed99556><!----></div></div><div class="updated" data-v-07c132fc><p class="last-updated" data-v-07c132fc data-v-abce3432><span class="prefix" data-v-abce3432>最近更新:</span><span class="datetime" data-v-abce3432></span></p></div></footer><div class="next-and-prev-link" data-v-7eddb2c4 data-v-38ede35f><div class="container" data-v-38ede35f><div class="prev" data-v-38ede35f><a class="link" href="/react/hooks实现" data-v-38ede35f><svg xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" class="icon icon-prev" data-v-38ede35f><path d="M19,11H7.4l5.3-5.3c0.4-0.4,0.4-1,0-1.4s-1-0.4-1.4,0l-7,7c-0.1,0.1-0.2,0.2-0.2,0.3c-0.1,0.2-0.1,0.5,0,0.8c0.1,0.1,0.1,0.2,0.2,0.3l7,7c0.2,0.2,0.5,0.3,0.7,0.3s0.5-0.1,0.7-0.3c0.4-0.4,0.4-1,0-1.4L7.4,13H19c0.6,0,1-0.4,1-1S19.6,11,19,11z"></path></svg><span class="text" data-v-38ede35f>hooks实现</span></a></div><div class="next" data-v-38ede35f><a class="link" href="/react/Suspense实现" data-v-38ede35f><span class="text" data-v-38ede35f>Suspense实现</span><svg xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" class="icon icon-next" data-v-38ede35f><path d="M19.9,12.4c0.1-0.2,0.1-0.5,0-0.8c-0.1-0.1-0.1-0.2-0.2-0.3l-7-7c-0.4-0.4-1-0.4-1.4,0s-0.4,1,0,1.4l5.3,5.3H5c-0.6,0-1,0.4-1,1s0.4,1,1,1h11.6l-5.3,5.3c-0.4,0.4-0.4,1,0,1.4c0.2,0.2,0.5,0.3,0.7,0.3s0.5-0.1,0.7-0.3l7-7C19.8,12.6,19.9,12.5,19.9,12.4z"></path></svg></a></div></div></div><!--[--><!--]--></div></main></div><!----><!--]--></div>
    <script>__VP_HASH_MAP__ = JSON.parse("{\"about_readme.md\":\"1753e359\",\"about_index.md\":\"f8bdf8ce\",\"about_plan.md\":\"3ceffa23\",\"algorithms_index.md\":\"0d2b7a1c\",\"algorithms_二叉树.md\":\"ffef13bf\",\"algorithms_动态规划.md\":\"0b91fd81\",\"algorithms_回溯法.md\":\"6dd98f88\",\"algorithms_字符串.md\":\"a520b1c2\",\"algorithms_排序汇总.md\":\"a0e89d43\",\"algorithms_数组.md\":\"2fe25727\",\"algorithms_树结构遍历.md\":\"76a1f119\",\"articles_index.md\":\"9287a054\",\"articles_react-concurrency.md\":\"05ba5645\",\"articles_todo.md\":\"65557f52\",\"babel_babel.md\":\"c2fdbe4b\",\"babel_index.md\":\"603c55b8\",\"babel_resource.md\":\"1c8037f8\",\"computer_index.md\":\"535159a2\",\"daily_2022_05.md\":\"24d5d00a\",\"daily_2022_06.md\":\"4401938a\",\"daily_2022_07.md\":\"33017e0f\",\"daily_2022_08.md\":\"02d5b435\",\"daily_2022_09.md\":\"7a1b2dad\",\"daily_index.md\":\"939b1d19\",\"data-structures_index.md\":\"298cd308\",\"data-structures_二叉查找树.md\":\"dcab6e33\",\"data-structures_哈希表.md\":\"98e13748\",\"data-structures_堆.md\":\"c1e08dfa\",\"data-structures_字典树.md\":\"3ab6bfeb\",\"data-structures_布隆过滤器.md\":\"a8efe9cb\",\"data-structures_平衡二叉树.md\":\"173f6805\",\"data-structures_并查集.md\":\"5747b975\",\"data-structures_树状数组.md\":\"3435d694\",\"data-structures_红黑树.md\":\"b028be24\",\"data-structures_线段树.md\":\"af552755\",\"design-pattern_index.md\":\"cf4744a2\",\"design-pattern_创建型模式.md\":\"43e27f32\",\"design-pattern_结构型模式.md\":\"248bb96d\",\"design-pattern_行为型模式.md\":\"fc0f3317\",\"design-pattern_阅读资料.md\":\"057cf17a\",\"index.md\":\"e413d6a2\",\"javascript_typescript.md\":\"46fca758\",\"javascript_co库.md\":\"a8400a4e\",\"javascript_es6.md\":\"b43959ee\",\"javascript_index.md\":\"0d083418\",\"javascript_js方法实现.md\":\"29974f56\",\"javascript_js继承.md\":\"335a40e8\",\"javascript_事件循环机制.md\":\"bf80a2f3\",\"javascript_函数式编程.md\":\"aea74ad6\",\"javascript_手写promise.md\":\"08f556bb\",\"leetcode_1-20.md\":\"a117cc49\",\"leetcode_21-40.md\":\"aa3cf7b9\",\"leetcode_index.md\":\"7ac8b5b9\",\"leetcode_leetcode.md\":\"1d89df87\",\"linux_bash.md\":\"5e64749b\",\"linux_index.md\":\"fa1ec6d9\",\"linux_ssh.md\":\"4402ad81\",\"linux_vim.md\":\"9343179f\",\"network_index.md\":\"142c7512\",\"network_应用层.md\":\"f2d62bc2\",\"network_缓存.md\":\"0d4bfcab\",\"network_运输层.md\":\"84e9fdde\",\"node_compose.md\":\"92e29b6f\",\"node_index.md\":\"e1e45b7d\",\"node_手写简版express.md\":\"acb74a25\",\"node_资料.md\":\"486cf656\",\"node_进程与线程.md\":\"565eda3a\",\"project_css-background-img.md\":\"7fc54a47\",\"project_css-hack.md\":\"989b057f\",\"project_css-media.md\":\"14348336\",\"project_drawer.md\":\"7aba77c5\",\"project_index.md\":\"b7d4d5c1\",\"project_semi-design.md\":\"aaf00912\",\"project_space.md\":\"28b74cf7\",\"react_fiber.md\":\"8d62b7ee\",\"react_lanes模型.md\":\"15a22ff8\",\"react_suspense实现.md\":\"d30a1b5e\",\"react_updatequeue.md\":\"a60d1189\",\"react_beginwork-fiber创建.md\":\"e48704e5\",\"react_beginwork-fiber更新.md\":\"f96459f7\",\"react_commitwork.md\":\"4f07d5be\",\"react_completework.md\":\"a0b7c65a\",\"react_hooks实现.md\":\"ce2709ae\",\"react_index.md\":\"5ff54d12\",\"react_react源码调试-next.md\":\"9b4c43ef\",\"react_react源码调试.md\":\"87d6bca3\",\"react_react源码起始篇.md\":\"f3f06d6c\",\"react_react热更新实现原理.md\":\"157df57e\",\"react_tmp.md\":\"852c9179\",\"react_事件系统.md\":\"1c3dd239\",\"react_任务调度.md\":\"0ef6d254\",\"react_学习计划.md\":\"cb457ae4\",\"react_手写简版react-redux.md\":\"475af89e\",\"react_手写简版redux.md\":\"e0a9ddf0\",\"react_浏览器一帧里做了什么.md\":\"506502b4\",\"react_渲染.md\":\"e4fd8c9f\",\"react_阅读资料.md\":\"1b114c64\",\"resources_index.md\":\"e1eeea69\",\"resources_js.md\":\"48e15c0b\",\"resources_前端博客.md\":\"ff709040\",\"resources_小程序.md\":\"0824f3e2\",\"resources_算法.md\":\"9462c935\",\"resources_网络协议.md\":\"7913a85a\",\"rollup_plugin.md\":\"b083fa8c\",\"rollup_scopehoist.md\":\"732b9496\",\"rollup_splitcode.md\":\"4aea7511\",\"rollup_treeshaking.md\":\"d9d7940e\",\"rollup_index.md\":\"53d36373\",\"rollup_todo.md\":\"21c824f2\",\"rollup_源码调试.md\":\"403ac5d1\",\"static_index.md\":\"779ebeff\",\"tools_github-workflow.md\":\"dc139a5d\",\"tools_img-library.md\":\"9631a3be\",\"tools_index.md\":\"14bd7da5\",\"tools_iterm2-ohmyzsh.md\":\"8bce8bd8\",\"tools_jenkins.md\":\"3ccc485c\",\"tools_software.md\":\"b0420bc7\",\"trend_bundleless.md\":\"b04ae274\",\"trend_index.md\":\"0ebac083\",\"trend_jiti.md\":\"414bc853\",\"typescript_index.md\":\"5ca50e5e\",\"typescript_utility-types.md\":\"6f382a8d\",\"vite_index.md\":\"911d9cd8\",\"vite_源码调试.md\":\"65ced6bd\",\"vue_index.md\":\"99831803\",\"vue_一些原理汇总.md\":\"f24ae41e\",\"vue_响应式原理上篇.md\":\"4ed821d3\",\"vue_响应式原理下篇.md\":\"398ba12a\",\"vue_响应式原理中篇.md\":\"40baddbe\",\"vue_手写简版vuerouter.md\":\"38e682c1\",\"vue_手写简版vuex.md\":\"149cb090\",\"vue_插槽实现原理.md\":\"15d60ad8\",\"vue_最长递增子序列.md\":\"fba93eaf\",\"vue_组件实现原理.md\":\"2d29b336\",\"vue_组成与设计.md\":\"46bbc5c9\",\"vue_编译原理上篇.md\":\"383aa0d8\",\"vue_编译原理下篇.md\":\"54f1f37f\",\"vue_编译原理中篇.md\":\"15cb0e75\",\"vue_选项合并.md\":\"c4477d95\",\"vue_阅读资料.md\":\"95c21444\",\"vue3_index.md\":\"b3f3ee40\",\"vue3_源码调试.md\":\"ff7ca6ce\",\"webpack_splitchunksplugin.md\":\"8c0abef5\",\"webpack_tapable.md\":\"d6c3db85\",\"webpack_treeshaking原理.md\":\"39c514ff\",\"webpack_addmodule.md\":\"a251a36b\",\"webpack_buildmodule.md\":\"d5c6c354\",\"webpack_emit阶段.md\":\"ad37d20a\",\"webpack_factorizemodule.md\":\"b333cf01\",\"webpack_import.md\":\"2b7f26d7\",\"webpack_index.md\":\"b45c202c\",\"webpack_make阶段.md\":\"d2c4f1ce\",\"webpack_seal阶段.md\":\"d1b9810f\",\"webpack_vue-loader实现.md\":\"9438acdd\",\"webpack_watch实现.md\":\"1d7f715b\",\"webpack_webpack优化.md\":\"93765d85\",\"webpack_webpack官方文档.md\":\"bb95f4a9\",\"webpack_webpack源码调试.md\":\"593222bc\",\"webpack_官方文档.md\":\"97f1ee29\",\"webpack_流程开始.md\":\"753d85dd\",\"webpack_热更新实现原理.md\":\"a1c4f92e\"}")</script>
    <script type="module" async src="/assets/app.2e2e81fb.js"></script>
    
  </body>
</html>