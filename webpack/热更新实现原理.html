<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>热更新实现原理 | 秦光辉</title>
    <meta name="description" content="专注于前端开发，关注新技术，坚持学习。">
    <link rel="stylesheet" href="/assets/style.519b55ff.css">
    <link rel="modulepreload" href="/assets/chunks/AlgoliaSearchBox.f359bb5b.js">
    <link rel="modulepreload" href="/assets/app.943409a9.js">
    <link rel="modulepreload" href="/assets/webpack_热更新实现原理.md.bfd2e8bb.lean.js">
    
    <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no, minimal-ui">
  <script>var _hmt=_hmt||[];(function(){var e=document.createElement("script");e.src="https://hm.baidu.com/hm.js?41a9a03811977ee15c69366a880d1296";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)})();</script>
  <meta name="twitter:title" content="热更新实现原理 | 秦光辉">
  <meta property="og:title" content="热更新实现原理 | 秦光辉">
  </head>
  <body>
    <div id="app"><!--[--><div class="theme"><header class="nav-bar" data-v-675d8756><div class="sidebar-button" data-v-675d8756><svg class="icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z" class></path></svg></div><a class="nav-bar-title" href="/" aria-label="秦光辉, back to home" data-v-675d8756 data-v-cc01ef16><img class="logo" src="/logo.png" alt="Logo" data-v-cc01ef16> 秦光辉</a><div class="flex-grow" data-v-675d8756></div><div class="nav" data-v-675d8756><nav class="nav-links" data-v-675d8756 data-v-eab3edfe><!--[--><div class="item" data-v-eab3edfe><div class="nav-link" data-v-eab3edfe data-v-b8818f8c><a class="item" href="/daily/index" data-v-b8818f8c>日常 <!----></a></div></div><div class="item" data-v-eab3edfe><div class="nav-link" data-v-eab3edfe data-v-b8818f8c><a class="item" href="/articles/index" data-v-b8818f8c>文章 <!----></a></div></div><div class="item" data-v-eab3edfe><div class="nav-dropdown-link" data-v-eab3edfe data-v-56bf3a3f><button class="button" data-v-56bf3a3f><span class="button-text" data-v-56bf3a3f>前端框架</span><span class="right button-arrow" data-v-56bf3a3f></span></button><ul class="dialog" data-v-56bf3a3f><!--[--><li class="dialog-item" data-v-56bf3a3f><div class="nav-dropdown-link-item" data-v-56bf3a3f data-v-bbc27490><a class="item" href="/vue/" data-v-bbc27490><span class="arrow" data-v-bbc27490></span><span class="text" data-v-bbc27490>Vue v2 源码解析</span><span class="icon" data-v-bbc27490><!----></span></a></div></li><li class="dialog-item" data-v-56bf3a3f><div class="nav-dropdown-link-item" data-v-56bf3a3f data-v-bbc27490><a class="item" href="/vue3/" data-v-bbc27490><span class="arrow" data-v-bbc27490></span><span class="text" data-v-bbc27490>Vue v3 源码</span><span class="icon" data-v-bbc27490><!----></span></a></div></li><li class="dialog-item" data-v-56bf3a3f><div class="nav-dropdown-link-item" data-v-56bf3a3f data-v-bbc27490><a class="item" href="/react/" data-v-bbc27490><span class="arrow" data-v-bbc27490></span><span class="text" data-v-bbc27490>React v17 源码</span><span class="icon" data-v-bbc27490><!----></span></a></div></li><!--]--></ul></div></div><div class="item" data-v-eab3edfe><div class="nav-dropdown-link" data-v-eab3edfe data-v-56bf3a3f><button class="button" data-v-56bf3a3f><span class="button-text" data-v-56bf3a3f>构建工具</span><span class="right button-arrow" data-v-56bf3a3f></span></button><ul class="dialog" data-v-56bf3a3f><!--[--><li class="dialog-item" data-v-56bf3a3f><div class="nav-dropdown-link-item" data-v-56bf3a3f data-v-bbc27490><a class="item active" href="/webpack/" data-v-bbc27490><span class="arrow" data-v-bbc27490></span><span class="text" data-v-bbc27490>Webpack</span><span class="icon" data-v-bbc27490><!----></span></a></div></li><li class="dialog-item" data-v-56bf3a3f><div class="nav-dropdown-link-item" data-v-56bf3a3f data-v-bbc27490><a class="item" href="/rollup/" data-v-bbc27490><span class="arrow" data-v-bbc27490></span><span class="text" data-v-bbc27490>Rollup</span><span class="icon" data-v-bbc27490><!----></span></a></div></li><li class="dialog-item" data-v-56bf3a3f><div class="nav-dropdown-link-item" data-v-56bf3a3f data-v-bbc27490><a class="item" href="/vite/" data-v-bbc27490><span class="arrow" data-v-bbc27490></span><span class="text" data-v-bbc27490>Vite</span><span class="icon" data-v-bbc27490><!----></span></a></div></li><li class="dialog-item" data-v-56bf3a3f><div class="nav-dropdown-link-item" data-v-56bf3a3f data-v-bbc27490><a class="item" href="/babel/" data-v-bbc27490><span class="arrow" data-v-bbc27490></span><span class="text" data-v-bbc27490>Babel</span><span class="icon" data-v-bbc27490><!----></span></a></div></li><!--]--></ul></div></div><div class="item" data-v-eab3edfe><div class="nav-dropdown-link" data-v-eab3edfe data-v-56bf3a3f><button class="button" data-v-56bf3a3f><span class="button-text" data-v-56bf3a3f>js</span><span class="right button-arrow" data-v-56bf3a3f></span></button><ul class="dialog" data-v-56bf3a3f><!--[--><li class="dialog-item" data-v-56bf3a3f><div class="nav-dropdown-link-item" data-v-56bf3a3f data-v-bbc27490><a class="item" href="/javascript/" data-v-bbc27490><span class="arrow" data-v-bbc27490></span><span class="text" data-v-bbc27490>ES6</span><span class="icon" data-v-bbc27490><!----></span></a></div></li><li class="dialog-item" data-v-56bf3a3f><div class="nav-dropdown-link-item" data-v-56bf3a3f data-v-bbc27490><a class="item" href="/node/" data-v-bbc27490><span class="arrow" data-v-bbc27490></span><span class="text" data-v-bbc27490>Node</span><span class="icon" data-v-bbc27490><!----></span></a></div></li><li class="dialog-item" data-v-56bf3a3f><div class="nav-dropdown-link-item" data-v-56bf3a3f data-v-bbc27490><a class="item" href="/typescript/" data-v-bbc27490><span class="arrow" data-v-bbc27490></span><span class="text" data-v-bbc27490>Typescript</span><span class="icon" data-v-bbc27490><!----></span></a></div></li><!--]--></ul></div></div><div class="item" data-v-eab3edfe><div class="nav-dropdown-link" data-v-eab3edfe data-v-56bf3a3f><button class="button" data-v-56bf3a3f><span class="button-text" data-v-56bf3a3f>基础</span><span class="right button-arrow" data-v-56bf3a3f></span></button><ul class="dialog" data-v-56bf3a3f><!--[--><li class="dialog-item" data-v-56bf3a3f><div class="nav-dropdown-link-item" data-v-56bf3a3f data-v-bbc27490><a class="item" href="/algorithms/" data-v-bbc27490><span class="arrow" data-v-bbc27490></span><span class="text" data-v-bbc27490>算法</span><span class="icon" data-v-bbc27490><!----></span></a></div></li><li class="dialog-item" data-v-56bf3a3f><div class="nav-dropdown-link-item" data-v-56bf3a3f data-v-bbc27490><a class="item" href="/data-structures/" data-v-bbc27490><span class="arrow" data-v-bbc27490></span><span class="text" data-v-bbc27490>数据结构</span><span class="icon" data-v-bbc27490><!----></span></a></div></li><li class="dialog-item" data-v-56bf3a3f><div class="nav-dropdown-link-item" data-v-56bf3a3f data-v-bbc27490><a class="item" href="/design-pattern/" data-v-bbc27490><span class="arrow" data-v-bbc27490></span><span class="text" data-v-bbc27490>设计模式</span><span class="icon" data-v-bbc27490><!----></span></a></div></li><li class="dialog-item" data-v-56bf3a3f><div class="nav-dropdown-link-item" data-v-56bf3a3f data-v-bbc27490><a class="item" href="/leetcode/" data-v-bbc27490><span class="arrow" data-v-bbc27490></span><span class="text" data-v-bbc27490>LeetCode</span><span class="icon" data-v-bbc27490><!----></span></a></div></li><li class="dialog-item" data-v-56bf3a3f><div class="nav-dropdown-link-item" data-v-56bf3a3f data-v-bbc27490><a class="item" href="/network/" data-v-bbc27490><span class="arrow" data-v-bbc27490></span><span class="text" data-v-bbc27490>网络</span><span class="icon" data-v-bbc27490><!----></span></a></div></li><li class="dialog-item" data-v-56bf3a3f><div class="nav-dropdown-link-item" data-v-56bf3a3f data-v-bbc27490><a class="item" href="/linux/" data-v-bbc27490><span class="arrow" data-v-bbc27490></span><span class="text" data-v-bbc27490>linux</span><span class="icon" data-v-bbc27490><!----></span></a></div></li><!--]--></ul></div></div><div class="item" data-v-eab3edfe><div class="nav-dropdown-link" data-v-eab3edfe data-v-56bf3a3f><button class="button" data-v-56bf3a3f><span class="button-text" data-v-56bf3a3f>资源</span><span class="right button-arrow" data-v-56bf3a3f></span></button><ul class="dialog" data-v-56bf3a3f><!--[--><li class="dialog-item" data-v-56bf3a3f><div class="nav-dropdown-link-item" data-v-56bf3a3f data-v-bbc27490><a class="item" href="/tools/" data-v-bbc27490><span class="arrow" data-v-bbc27490></span><span class="text" data-v-bbc27490>工具</span><span class="icon" data-v-bbc27490><!----></span></a></div></li><li class="dialog-item" data-v-56bf3a3f><div class="nav-dropdown-link-item" data-v-56bf3a3f data-v-bbc27490><a class="item" href="/resources/" data-v-bbc27490><span class="arrow" data-v-bbc27490></span><span class="text" data-v-bbc27490>资料</span><span class="icon" data-v-bbc27490><!----></span></a></div></li><!--]--></ul></div></div><div class="item" data-v-eab3edfe><div class="nav-link" data-v-eab3edfe data-v-b8818f8c><a class="item" href="/project/" data-v-b8818f8c>项目 <!----></a></div></div><!--]--><!----><div class="item" data-v-eab3edfe><div class="nav-link" data-v-eab3edfe data-v-b8818f8c><a class="item isExternal" href="https://github.com/promise96319" target="_blank" rel="noopener noreferrer" data-v-b8818f8c>GitHub <svg class="icon outbound" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15" data-v-b8818f8c><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div></div></nav></div><!--[--><!--[--><div class="algolia-search-box" id="docsearch"></div><!--]--><!--]--></header><aside class="sidebar" data-v-83e92a68><nav class="nav-links nav" data-v-83e92a68 data-v-eab3edfe><!--[--><div class="item" data-v-eab3edfe><div class="nav-link" data-v-eab3edfe data-v-b8818f8c><a class="item" href="/daily/index" data-v-b8818f8c>日常 <!----></a></div></div><div class="item" data-v-eab3edfe><div class="nav-link" data-v-eab3edfe data-v-b8818f8c><a class="item" href="/articles/index" data-v-b8818f8c>文章 <!----></a></div></div><div class="item" data-v-eab3edfe><div class="nav-dropdown-link" data-v-eab3edfe data-v-56bf3a3f><button class="button" data-v-56bf3a3f><span class="button-text" data-v-56bf3a3f>前端框架</span><span class="right button-arrow" data-v-56bf3a3f></span></button><ul class="dialog" data-v-56bf3a3f><!--[--><li class="dialog-item" data-v-56bf3a3f><div class="nav-dropdown-link-item" data-v-56bf3a3f data-v-bbc27490><a class="item" href="/vue/" data-v-bbc27490><span class="arrow" data-v-bbc27490></span><span class="text" data-v-bbc27490>Vue v2 源码解析</span><span class="icon" data-v-bbc27490><!----></span></a></div></li><li class="dialog-item" data-v-56bf3a3f><div class="nav-dropdown-link-item" data-v-56bf3a3f data-v-bbc27490><a class="item" href="/vue3/" data-v-bbc27490><span class="arrow" data-v-bbc27490></span><span class="text" data-v-bbc27490>Vue v3 源码</span><span class="icon" data-v-bbc27490><!----></span></a></div></li><li class="dialog-item" data-v-56bf3a3f><div class="nav-dropdown-link-item" data-v-56bf3a3f data-v-bbc27490><a class="item" href="/react/" data-v-bbc27490><span class="arrow" data-v-bbc27490></span><span class="text" data-v-bbc27490>React v17 源码</span><span class="icon" data-v-bbc27490><!----></span></a></div></li><!--]--></ul></div></div><div class="item" data-v-eab3edfe><div class="nav-dropdown-link" data-v-eab3edfe data-v-56bf3a3f><button class="button" data-v-56bf3a3f><span class="button-text" data-v-56bf3a3f>构建工具</span><span class="right button-arrow" data-v-56bf3a3f></span></button><ul class="dialog" data-v-56bf3a3f><!--[--><li class="dialog-item" data-v-56bf3a3f><div class="nav-dropdown-link-item" data-v-56bf3a3f data-v-bbc27490><a class="item active" href="/webpack/" data-v-bbc27490><span class="arrow" data-v-bbc27490></span><span class="text" data-v-bbc27490>Webpack</span><span class="icon" data-v-bbc27490><!----></span></a></div></li><li class="dialog-item" data-v-56bf3a3f><div class="nav-dropdown-link-item" data-v-56bf3a3f data-v-bbc27490><a class="item" href="/rollup/" data-v-bbc27490><span class="arrow" data-v-bbc27490></span><span class="text" data-v-bbc27490>Rollup</span><span class="icon" data-v-bbc27490><!----></span></a></div></li><li class="dialog-item" data-v-56bf3a3f><div class="nav-dropdown-link-item" data-v-56bf3a3f data-v-bbc27490><a class="item" href="/vite/" data-v-bbc27490><span class="arrow" data-v-bbc27490></span><span class="text" data-v-bbc27490>Vite</span><span class="icon" data-v-bbc27490><!----></span></a></div></li><li class="dialog-item" data-v-56bf3a3f><div class="nav-dropdown-link-item" data-v-56bf3a3f data-v-bbc27490><a class="item" href="/babel/" data-v-bbc27490><span class="arrow" data-v-bbc27490></span><span class="text" data-v-bbc27490>Babel</span><span class="icon" data-v-bbc27490><!----></span></a></div></li><!--]--></ul></div></div><div class="item" data-v-eab3edfe><div class="nav-dropdown-link" data-v-eab3edfe data-v-56bf3a3f><button class="button" data-v-56bf3a3f><span class="button-text" data-v-56bf3a3f>js</span><span class="right button-arrow" data-v-56bf3a3f></span></button><ul class="dialog" data-v-56bf3a3f><!--[--><li class="dialog-item" data-v-56bf3a3f><div class="nav-dropdown-link-item" data-v-56bf3a3f data-v-bbc27490><a class="item" href="/javascript/" data-v-bbc27490><span class="arrow" data-v-bbc27490></span><span class="text" data-v-bbc27490>ES6</span><span class="icon" data-v-bbc27490><!----></span></a></div></li><li class="dialog-item" data-v-56bf3a3f><div class="nav-dropdown-link-item" data-v-56bf3a3f data-v-bbc27490><a class="item" href="/node/" data-v-bbc27490><span class="arrow" data-v-bbc27490></span><span class="text" data-v-bbc27490>Node</span><span class="icon" data-v-bbc27490><!----></span></a></div></li><li class="dialog-item" data-v-56bf3a3f><div class="nav-dropdown-link-item" data-v-56bf3a3f data-v-bbc27490><a class="item" href="/typescript/" data-v-bbc27490><span class="arrow" data-v-bbc27490></span><span class="text" data-v-bbc27490>Typescript</span><span class="icon" data-v-bbc27490><!----></span></a></div></li><!--]--></ul></div></div><div class="item" data-v-eab3edfe><div class="nav-dropdown-link" data-v-eab3edfe data-v-56bf3a3f><button class="button" data-v-56bf3a3f><span class="button-text" data-v-56bf3a3f>基础</span><span class="right button-arrow" data-v-56bf3a3f></span></button><ul class="dialog" data-v-56bf3a3f><!--[--><li class="dialog-item" data-v-56bf3a3f><div class="nav-dropdown-link-item" data-v-56bf3a3f data-v-bbc27490><a class="item" href="/algorithms/" data-v-bbc27490><span class="arrow" data-v-bbc27490></span><span class="text" data-v-bbc27490>算法</span><span class="icon" data-v-bbc27490><!----></span></a></div></li><li class="dialog-item" data-v-56bf3a3f><div class="nav-dropdown-link-item" data-v-56bf3a3f data-v-bbc27490><a class="item" href="/data-structures/" data-v-bbc27490><span class="arrow" data-v-bbc27490></span><span class="text" data-v-bbc27490>数据结构</span><span class="icon" data-v-bbc27490><!----></span></a></div></li><li class="dialog-item" data-v-56bf3a3f><div class="nav-dropdown-link-item" data-v-56bf3a3f data-v-bbc27490><a class="item" href="/design-pattern/" data-v-bbc27490><span class="arrow" data-v-bbc27490></span><span class="text" data-v-bbc27490>设计模式</span><span class="icon" data-v-bbc27490><!----></span></a></div></li><li class="dialog-item" data-v-56bf3a3f><div class="nav-dropdown-link-item" data-v-56bf3a3f data-v-bbc27490><a class="item" href="/leetcode/" data-v-bbc27490><span class="arrow" data-v-bbc27490></span><span class="text" data-v-bbc27490>LeetCode</span><span class="icon" data-v-bbc27490><!----></span></a></div></li><li class="dialog-item" data-v-56bf3a3f><div class="nav-dropdown-link-item" data-v-56bf3a3f data-v-bbc27490><a class="item" href="/network/" data-v-bbc27490><span class="arrow" data-v-bbc27490></span><span class="text" data-v-bbc27490>网络</span><span class="icon" data-v-bbc27490><!----></span></a></div></li><li class="dialog-item" data-v-56bf3a3f><div class="nav-dropdown-link-item" data-v-56bf3a3f data-v-bbc27490><a class="item" href="/linux/" data-v-bbc27490><span class="arrow" data-v-bbc27490></span><span class="text" data-v-bbc27490>linux</span><span class="icon" data-v-bbc27490><!----></span></a></div></li><!--]--></ul></div></div><div class="item" data-v-eab3edfe><div class="nav-dropdown-link" data-v-eab3edfe data-v-56bf3a3f><button class="button" data-v-56bf3a3f><span class="button-text" data-v-56bf3a3f>资源</span><span class="right button-arrow" data-v-56bf3a3f></span></button><ul class="dialog" data-v-56bf3a3f><!--[--><li class="dialog-item" data-v-56bf3a3f><div class="nav-dropdown-link-item" data-v-56bf3a3f data-v-bbc27490><a class="item" href="/tools/" data-v-bbc27490><span class="arrow" data-v-bbc27490></span><span class="text" data-v-bbc27490>工具</span><span class="icon" data-v-bbc27490><!----></span></a></div></li><li class="dialog-item" data-v-56bf3a3f><div class="nav-dropdown-link-item" data-v-56bf3a3f data-v-bbc27490><a class="item" href="/resources/" data-v-bbc27490><span class="arrow" data-v-bbc27490></span><span class="text" data-v-bbc27490>资料</span><span class="icon" data-v-bbc27490><!----></span></a></div></li><!--]--></ul></div></div><div class="item" data-v-eab3edfe><div class="nav-link" data-v-eab3edfe data-v-b8818f8c><a class="item" href="/project/" data-v-b8818f8c>项目 <!----></a></div></div><!--]--><!----><div class="item" data-v-eab3edfe><div class="nav-link" data-v-eab3edfe data-v-b8818f8c><a class="item isExternal" href="https://github.com/promise96319" target="_blank" rel="noopener noreferrer" data-v-b8818f8c>GitHub <svg class="icon outbound" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15" data-v-b8818f8c><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div></div></nav><!--[--><!--]--><ul class="sidebar-links" data-v-83e92a68><!--[--><li class="sidebar-link"><a class="sidebar-link-item" href="/webpack/index">原理</a><ul class="sidebar-links"><li class="sidebar-link"><a class="sidebar-link-item" href="/webpack/webpack源码调试">webpack源码调试</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="/webpack/流程开始">流程开始</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="/webpack/make阶段">make阶段</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="/webpack/factorizeModule">factorizeModule</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="/webpack/addModule">addModule</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="/webpack/buildModule">buildModule</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="/webpack/seal阶段">seal阶段</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="/webpack/emit阶段">emit阶段</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="/webpack/import">import</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="/webpack/TreeShaking原理">TreeShaking原理</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="/webpack/SplitChunksPlugin">SplitChunksPlugin</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="/webpack/watch实现">watch实现</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="/webpack/vue-loader实现">vue-loader实现</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item active" href="/webpack/热更新实现原理">热更新实现原理</a><ul class="sidebar-links"><li class="sidebar-link"><a class="sidebar-link-item" href="#启动">启动</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="#webpack-dev-server">webpack-dev-server</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="#添加client端socket代码">添加client端socket代码</a><ul class="sidebar-links"><li class="sidebar-link"><a class="sidebar-link-item" href="#client-index-js">client/index.js</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="#webpack-hot-dev-server-js">webpack/hot/dev-server.js</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="#小结">小结</a><!----></li></ul></li><li class="sidebar-link"><a class="sidebar-link-item" href="#提供-webpack-dev-server-client">提供_webpackdevserverclient__</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="#hotmodulereplacementplugin">HotModuleReplacementPlugin</a><ul class="sidebar-links"><li class="sidebar-link"><a class="sidebar-link-item" href="#_1-处理热更新api">1. 处理热更新api</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="#_2-hooks-additionaltreeruntimerequirements">2. hooks.additionalTreeRuntimeRequirements</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="#_3-hooks-fullhash">3. hooks.fullhash</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="#_4-hooks-processassets">4. hooks.processAssets</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="#_5-hooks-record">5. hooks.record</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="#小结-1">小结</a><!----></li></ul></li><li class="sidebar-link"><a class="sidebar-link-item" href="#建立服务端server">建立服务端server</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="#webpack-dev-middleware">webpack-dev-middleware</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="#hotcheck">hotCheck</a><ul class="sidebar-links"><li class="sidebar-link"><a class="sidebar-link-item" href="#fullhash-hot-update-json">[fullhash].hot-update.json</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="#fullhash-hot-update-js">[fullhash].hot-update.js</a><!----></li></ul></li><li class="sidebar-link"><a class="sidebar-link-item" href="#hotapply">hotApply</a><ul class="sidebar-links"><li class="sidebar-link"><a class="sidebar-link-item" href="#module-hot相关api定义">module.hot相关api定义</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="#applyinvalidatedmodules">applyInvalidatedModules</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="#applyhandler">applyHandler</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="#dispose">dispose</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="#apply">apply</a><!----></li></ul></li><li class="sidebar-link"><a class="sidebar-link-item" href="#hash-更新">hash 更新</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="#总结">总结</a><!----></li></ul></li><li class="sidebar-link"><a class="sidebar-link-item" href="/webpack/Tapable">Tapable</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="/webpack/webpack优化">webpack优化</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="/webpack/webpack官方文档">webpack官方文档</a><!----></li></ul></li><!--]--></ul><!--[--><!--]--></aside><div class="sidebar-mask"></div><main class="page" data-v-7eddb2c4><div class="container" data-v-7eddb2c4><!--[--><!--]--><div style="position:relative;" class="content" data-v-7eddb2c4><div><h1 id="热更新实现原理" tabindex="-1">热更新实现原理 <a class="header-anchor" href="#热更新实现原理" aria-hidden="true">#</a></h1><p><a href="https://webpack.docschina.org/configuration/dev-server/#root" target="_blank" rel="noopener noreferrer">webpack DevServer 配置</a></p><h2 id="启动" tabindex="-1">启动 <a class="header-anchor" href="#启动" aria-hidden="true">#</a></h2><p>当运行<code>webpack serve</code>命令时，解析命令后会加载<code>node_modules/@webpack-cli/serve/lib/index.js</code>中的<code>ServeCommand</code>，并执行其<code>apply</code>方法，最后触发回调函数，精简后的代码如下：</p><div class="language-javascript"><pre><code><span class="token comment">// 1. 创建 compiler</span>
<span class="token keyword">const</span> compiler <span class="token operator">=</span> <span class="token keyword">await</span> cli<span class="token punctuation">.</span><span class="token function">createCompiler</span><span class="token punctuation">(</span>webpackCLIOptions<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 2. 加载 webpack-dev-server 包</span>
<span class="token keyword">const</span> DevServer <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token constant">WEBPACK_DEV_SERVER_PACKAGE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 3. 整理所有 compilers</span>
<span class="token keyword">const</span> compilers <span class="token operator">=</span> <span class="token keyword">typeof</span> compiler<span class="token punctuation">.</span>compilers <span class="token operator">!==</span> <span class="token string">&quot;undefined&quot;</span> <span class="token operator">?</span> compiler<span class="token punctuation">.</span>compilers <span class="token operator">:</span> <span class="token punctuation">[</span>compiler<span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> possibleCompilers <span class="token operator">=</span> compilers<span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">compiler</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> compiler<span class="token punctuation">.</span>options<span class="token punctuation">.</span>devServer<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> compilersForDevServer <span class="token operator">=</span> possibleCompilers<span class="token punctuation">.</span>length <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token operator">?</span> possibleCompilers <span class="token operator">:</span> <span class="token punctuation">[</span>compilers<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token comment">// 4. 遍历所有 compilers</span>
<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> compilerForDevServer <span class="token keyword">of</span> compilersForDevServer<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 5. 提取 devServer 配置</span>
  <span class="token keyword">const</span> result <span class="token operator">=</span> Object<span class="token punctuation">.</span><span class="token function">assign</span><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>compilerForDevServer<span class="token punctuation">.</span>options<span class="token punctuation">.</span>devServer <span class="token operator">||</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  devServerOptions <span class="token operator">=</span> result<span class="token punctuation">;</span>

  <span class="token keyword">try</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> server<span class="token punctuation">;</span>
    <span class="token comment">// 6. 运行 devServer</span>
    server <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DevServer</span><span class="token punctuation">(</span>devServerOptions<span class="token punctuation">,</span> compiler<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> server<span class="token punctuation">.</span>start <span class="token operator">===</span> <span class="token string">&quot;function&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">await</span> server<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    servers<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>server<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="webpack-dev-server" tabindex="-1">webpack-dev-server <a class="header-anchor" href="#webpack-dev-server" aria-hidden="true">#</a></h2><p>找到<code>node_modules/webpack-dev-server/lib/Server.js</code>文件中的<code>start</code>函数，精简后的代码如下：</p><div class="language-javascript"><pre><code><span class="token keyword">async</span> <span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 1. 整理 options</span>
  <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">normalizeOptions</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 2. 初始化</span>
  <span class="token keyword">await</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">initialize</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token comment">// 3. 监听请求</span>
  <span class="token keyword">await</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>server<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span>listenOptions<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token comment">// 4. 创建 websocket server</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>options<span class="token punctuation">.</span>webSocketServer<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">createWebSocketServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>其中最核心的是初始化过程，下面着重讲解<code>initialize</code>方法。</p><h2 id="添加client端socket代码" tabindex="-1">添加client端socket代码 <a class="header-anchor" href="#添加client端socket代码" aria-hidden="true">#</a></h2><p><code>initialize</code>方法首先执行<code>addAdditionalEntries</code>方法：</p><div class="language-javascript"><pre><code><span class="token comment">// 添加 client socket 代码</span>
additionalEntries<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>
  <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>require<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">&quot;../client/index.js&quot;</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">?</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>webSocketURL<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 添加 webpack dev-server 代码</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>options<span class="token punctuation">.</span>hot <span class="token operator">===</span> <span class="token string">&quot;only&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  hotEntry <span class="token operator">=</span> require<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">&quot;webpack/hot/only-dev-server&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>options<span class="token punctuation">.</span>hot<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  hotEntry <span class="token operator">=</span> require<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">&quot;webpack/hot/dev-server&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
additionalEntries<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>hotEntry<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 应用 entry</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> webpack<span class="token punctuation">.</span>EntryPlugin <span class="token operator">!==</span> <span class="token string">&quot;undefined&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> additionalEntry <span class="token keyword">of</span> additionalEntries<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">new</span> <span class="token class-name">webpack<span class="token punctuation">.</span>EntryPlugin</span><span class="token punctuation">(</span>compiler<span class="token punctuation">.</span>context<span class="token punctuation">,</span> additionalEntry<span class="token punctuation">,</span> <span class="token punctuation">{</span>
      <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token keyword">undefined</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span>compiler<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>该函数的主要作用是添加了两个<code>entry</code>，相当于最终打包出来的<code>bundle</code>文件会引入这两个<code>entry</code>对应的代码。</p><h3 id="client-index-js" tabindex="-1">client/index.js <a class="header-anchor" href="#client-index-js" aria-hidden="true">#</a></h3><p>首先是<code>../client/index.js</code>文件：</p><div class="language-javascript"><pre><code><span class="token comment">// client/index.js 文件</span>
<span class="token comment">// 创建了 WebSocket 客户端</span>
<span class="token keyword">var</span> socketURL <span class="token operator">=</span> <span class="token function">createSocketURL</span><span class="token punctuation">(</span>parsedResourceQuery<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token function">socket</span><span class="token punctuation">(</span>socketURL<span class="token punctuation">,</span> onSocketMessage<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// client/socket.js 文件</span>
<span class="token keyword">var</span> Client <span class="token operator">=</span> 
    <span class="token keyword">typeof</span> __webpack_dev_server_client__ <span class="token operator">!==</span> <span class="token string">&quot;undefined&quot;</span> <span class="token operator">?</span>
    <span class="token keyword">typeof</span> __webpack_dev_server_client__<span class="token punctuation">.</span>default <span class="token operator">!==</span> <span class="token string">&quot;undefined&quot;</span> <span class="token operator">?</span> __webpack_dev_server_client__<span class="token punctuation">.</span>default <span class="token operator">:</span> __webpack_dev_server_client__ <span class="token operator">:</span> WebSocketClient<span class="token punctuation">;</span>

<span class="token keyword">var</span> <span class="token function-variable function">socket</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token function">initSocket</span><span class="token punctuation">(</span><span class="token parameter">url<span class="token punctuation">,</span> handlers</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  client <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Client</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">;</span>
  client<span class="token punctuation">.</span><span class="token function">onOpen</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  client<span class="token punctuation">.</span><span class="token function">onClose</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  client<span class="token punctuation">.</span><span class="token function">onMessage</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">data</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> socket<span class="token punctuation">;</span>
</code></pre></div><p>该文件的核心是创建了一个<code>WebSocket</code>的客户端，用于接收服务端传递的信息。</p><h3 id="webpack-hot-dev-server-js" tabindex="-1">webpack/hot/dev-server.js <a class="header-anchor" href="#webpack-hot-dev-server-js" aria-hidden="true">#</a></h3><p>其次是<code>dev-server.js</code>文件：</p><div class="language-javascript"><pre><code><span class="token keyword">if</span> <span class="token punctuation">(</span>module<span class="token punctuation">.</span>hot<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> <span class="token function-variable function">check</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token function">check</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    module<span class="token punctuation">.</span>hot
      <span class="token punctuation">.</span><span class="token function">check</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">updatedModules</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token keyword">var</span> hotEmitter <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;./emitter&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  hotEmitter<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">&quot;webpackHotUpdate&quot;</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">currentHash</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    lastHash <span class="token operator">=</span> currentHash<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">upToDate</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> module<span class="token punctuation">.</span>hot<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token string">&quot;idle&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;info&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;[HMR] Checking for updates on the server...&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">check</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>该代码的核心逻辑是监听<code>webpackHotUpdate</code>事件，触发<code>check</code>方法的执行。</p><h3 id="小结" tabindex="-1">小结 <a class="header-anchor" href="#小结" aria-hidden="true">#</a></h3><p><code>addAdditionalEntries</code>通过添加两个<code>entry</code>，在<code>bundle</code>里添加了<code>WebSocket</code>客户端代码，使得客户端具备接收服务端消息的能力。</p><h2 id="提供-webpack-dev-server-client" tabindex="-1">提供__webpack_dev_server_client__ <a class="header-anchor" href="#提供-webpack-dev-server-client" aria-hidden="true">#</a></h2><p>添加完<code>entry</code>后，接着调用<code>ProvidePlugin</code>：</p><div class="language-javascript"><pre><code><span class="token keyword">new</span> <span class="token class-name">webpack<span class="token punctuation">.</span>ProvidePlugin</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token literal-property property">__webpack_dev_server_client__</span><span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getClientTransport</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span>compiler<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>该插件相当于为全局提供了变量。这就意味着<code>bundle.js</code>文件里的代码可以访问<code>__webpack_dev_server_client__</code>变量，而<code>this.getClientTransport()</code>方法则是提供客户端的<code>socket</code>代码，这里默认使用的是<code>WebSocket</code>。我们在上面<code>entry</code>中的<code>client/index.js</code>文件中使用到了这个变量。</p><h2 id="hotmodulereplacementplugin" tabindex="-1">HotModuleReplacementPlugin <a class="header-anchor" href="#hotmodulereplacementplugin" aria-hidden="true">#</a></h2><p>其次是应用<code>HotModuleReplacementPlugin</code>插件：</p><div class="language-javascript"><pre><code><span class="token keyword">const</span> plugin <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">webpack<span class="token punctuation">.</span>HotModuleReplacementPlugin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token function">plugin</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span>compiler<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>该插件定义在<code>webpack/lib/HotModuleReplacementPlugin.js</code>文件中。下面我们分析一下其作用。</p><h3 id="_1-处理热更新api" tabindex="-1">1. 处理热更新api <a class="header-anchor" href="#_1-处理热更新api" aria-hidden="true">#</a></h3><p>首先会定义<code>module.hot</code>相关<code>api</code>的<code>dependency</code>以及<code>template</code>：</p><div class="language-javascript"><pre><code><span class="token comment">//#region module.hot.* API</span>
compilation<span class="token punctuation">.</span>dependencyFactories<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>
  ModuleHotAcceptDependency<span class="token punctuation">,</span>
  normalModuleFactory
<span class="token punctuation">)</span><span class="token punctuation">;</span>
compilation<span class="token punctuation">.</span>dependencyTemplates<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>
  ModuleHotAcceptDependency<span class="token punctuation">,</span>
  <span class="token keyword">new</span> <span class="token class-name">ModuleHotAcceptDependency<span class="token punctuation">.</span>Template</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
compilation<span class="token punctuation">.</span>dependencyFactories<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>
  ModuleHotDeclineDependency<span class="token punctuation">,</span>
  normalModuleFactory
<span class="token punctuation">)</span><span class="token punctuation">;</span>
compilation<span class="token punctuation">.</span>dependencyTemplates<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>
  ModuleHotDeclineDependency<span class="token punctuation">,</span>
  <span class="token keyword">new</span> <span class="token class-name">ModuleHotDeclineDependency<span class="token punctuation">.</span>Template</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>然后监听<code>parser</code>阶段，对<code>module.hot</code>等<code>api</code>进行解析，例如：</p><div class="language-javascript"><pre><code>parser<span class="token punctuation">.</span>hooks<span class="token punctuation">.</span>call
  <span class="token punctuation">.</span><span class="token function">for</span><span class="token punctuation">(</span><span class="token string">&quot;module.hot.accept&quot;</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">tap</span><span class="token punctuation">(</span>
  <span class="token string">&quot;HotModuleReplacementPlugin&quot;</span><span class="token punctuation">,</span>
  <span class="token function">createAcceptHandler</span><span class="token punctuation">(</span>parser<span class="token punctuation">,</span> ModuleHotAcceptDependency<span class="token punctuation">)</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>因此<code>module.hot</code>等<code>api</code>经过<code>parser</code>后会变为相应的<code>dependency</code>。在<code>code generate</code>时，调用对应的<code>template</code>生成新的代码：</p><div class="language-javascript"><pre><code><span class="token comment">// 转换前</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>module<span class="token punctuation">.</span>hot<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  module<span class="token punctuation">.</span>hot<span class="token punctuation">.</span><span class="token function">accept</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token string">&#39;./moduleB.js&#39;</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;======&gt;  accept B&#39;</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">// 转换后</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  module<span class="token punctuation">.</span>hot<span class="token punctuation">.</span><span class="token function">accept</span><span class="token punctuation">(</span><span class="token punctuation">[</span><span class="token comment">/*! ./moduleB.js */</span> <span class="token string">&quot;./src/moduleB.js&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token parameter">__WEBPACK_OUTDATED_DEPENDENCIES__</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span> 
    <span class="token comment">/* harmony import */</span> _moduleB__WEBPACK_IMPORTED_MODULE_0__ <span class="token operator">=</span> <span class="token function">__webpack_require__</span><span class="token punctuation">(</span><span class="token comment">/*! ./moduleB.js */</span> <span class="token string">&quot;./src/moduleB.js&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&#39;======&gt;  accept B&#39;</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span>__WEBPACK_OUTDATED_DEPENDENCIES__<span class="token punctuation">)</span><span class="token punctuation">;</span> 
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="_2-hooks-additionaltreeruntimerequirements" tabindex="-1">2. hooks.additionalTreeRuntimeRequirements <a class="header-anchor" href="#_2-hooks-additionaltreeruntimerequirements" aria-hidden="true">#</a></h3><p>在<code>seal</code>阶段，所有模块的代码生成之后，会调用<code>additionalTreeRuntimeRequirements</code>钩子，用于添加模块在代码生成时需要的<code>runtime</code>代码。如果使用到了热更新功能，那么会添加热更新相关的<code>runtime</code>代码：</p><div class="language-javascript"><pre><code>compilation<span class="token punctuation">.</span>hooks<span class="token punctuation">.</span>additionalTreeRuntimeRequirements<span class="token punctuation">.</span><span class="token function">tap</span><span class="token punctuation">(</span>
  <span class="token string">&quot;HotModuleReplacementPlugin&quot;</span><span class="token punctuation">,</span>
  <span class="token punctuation">(</span><span class="token parameter">chunk<span class="token punctuation">,</span> runtimeRequirements</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    runtimeRequirements<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>RuntimeGlobals<span class="token punctuation">.</span>hmrDownloadManifest<span class="token punctuation">)</span><span class="token punctuation">;</span>
    runtimeRequirements<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>RuntimeGlobals<span class="token punctuation">.</span>hmrDownloadUpdateHandlers<span class="token punctuation">)</span><span class="token punctuation">;</span>
    runtimeRequirements<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>RuntimeGlobals<span class="token punctuation">.</span>interceptModuleExecution<span class="token punctuation">)</span><span class="token punctuation">;</span>
    runtimeRequirements<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>RuntimeGlobals<span class="token punctuation">.</span>moduleCache<span class="token punctuation">)</span><span class="token punctuation">;</span>
    compilation<span class="token punctuation">.</span><span class="token function">addRuntimeModule</span><span class="token punctuation">(</span>
      chunk<span class="token punctuation">,</span>
      <span class="token keyword">new</span> <span class="token class-name">HotModuleReplacementRuntimeModule</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>注意这个时候添加了一个新的module为HotModuleReplacementRuntimeModule。在<code>webpack/lib/hmr/HotModuleReplacementRuntimeModule.js</code>中：</p><div class="language-javascript"><pre><code><span class="token keyword">class</span> <span class="token class-name">HotModuleReplacementRuntimeModule</span> <span class="token keyword">extends</span> <span class="token class-name">RuntimeModule</span> <span class="token punctuation">{</span>
	<span class="token function">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">super</span><span class="token punctuation">(</span><span class="token string">&quot;hot module replacement&quot;</span><span class="token punctuation">,</span> RuntimeModule<span class="token punctuation">.</span><span class="token constant">STAGE_BASIC</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	
	<span class="token function">generate</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">return</span> Template<span class="token punctuation">.</span><span class="token function">getFunctionContent</span><span class="token punctuation">(</span>
			<span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;./HotModuleReplacement.runtime.js&quot;</span><span class="token punctuation">)</span>
		<span class="token punctuation">)</span>
			<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\$getFullHash\$</span><span class="token regex-delimiter">/</span><span class="token regex-flags">g</span></span><span class="token punctuation">,</span> RuntimeGlobals<span class="token punctuation">.</span>getFullHash<span class="token punctuation">)</span>
			<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span>
				<span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\$interceptModuleExecution\$</span><span class="token regex-delimiter">/</span><span class="token regex-flags">g</span></span><span class="token punctuation">,</span>
				RuntimeGlobals<span class="token punctuation">.</span>interceptModuleExecution
			<span class="token punctuation">)</span>
			<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\$moduleCache\$</span><span class="token regex-delimiter">/</span><span class="token regex-flags">g</span></span><span class="token punctuation">,</span> RuntimeGlobals<span class="token punctuation">.</span>moduleCache<span class="token punctuation">)</span>
			<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\$hmrModuleData\$</span><span class="token regex-delimiter">/</span><span class="token regex-flags">g</span></span><span class="token punctuation">,</span> RuntimeGlobals<span class="token punctuation">.</span>hmrModuleData<span class="token punctuation">)</span>
			<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\$hmrDownloadManifest\$</span><span class="token regex-delimiter">/</span><span class="token regex-flags">g</span></span><span class="token punctuation">,</span> RuntimeGlobals<span class="token punctuation">.</span>hmrDownloadManifest<span class="token punctuation">)</span>
			<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span>
				<span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\$hmrInvalidateModuleHandlers\$</span><span class="token regex-delimiter">/</span><span class="token regex-flags">g</span></span><span class="token punctuation">,</span>
				RuntimeGlobals<span class="token punctuation">.</span>hmrInvalidateModuleHandlers
			<span class="token punctuation">)</span>
			<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span>
				<span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\$hmrDownloadUpdateHandlers\$</span><span class="token regex-delimiter">/</span><span class="token regex-flags">g</span></span><span class="token punctuation">,</span>
				RuntimeGlobals<span class="token punctuation">.</span>hmrDownloadUpdateHandlers
			<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p><strong>在生成代码阶段会调用module.generate方法，所以HotModuleReplacementRuntimeModule模块最终生成的代码相当于require(&quot;./HotModuleReplacement.runtime.js&quot;)文件中的代码，然后用正则将$开头的一些变量替换后的代码。而这个文件的代码，正是热更新中更新过程的核心代码。</strong></p><h3 id="_3-hooks-fullhash" tabindex="-1">3. hooks.fullhash <a class="header-anchor" href="#_3-hooks-fullhash" aria-hidden="true">#</a></h3><p>待<code>runtime</code>代码也被添加之后，为项目生成新的<code>fullhash</code>，此时会调用<code>hooks.fullhash</code>钩子，触发<code>HotModuleReplacementPlugin</code>插件：</p><div class="language-javascript"><pre><code>compilation<span class="token punctuation">.</span>hooks<span class="token punctuation">.</span>fullHash<span class="token punctuation">.</span><span class="token function">tap</span><span class="token punctuation">(</span><span class="token string">&quot;HotModuleReplacementPlugin&quot;</span><span class="token punctuation">,</span> <span class="token parameter">hash</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> chunk <span class="token keyword">of</span> compilation<span class="token punctuation">.</span>chunks<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> modules <span class="token operator">=</span> chunkGraph<span class="token punctuation">.</span><span class="token function">getChunkModulesIterable</span><span class="token punctuation">(</span>chunk<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> module <span class="token keyword">of</span> modules<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>fullHashModulesInThisChunk<span class="token punctuation">.</span><span class="token function">has</span><span class="token punctuation">(</span><span class="token punctuation">(</span>module<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>records<span class="token punctuation">.</span>fullHashChunkModuleHashes<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">!==</span> hash<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          updatedModules<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>module<span class="token punctuation">,</span> chunk<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        fullHashChunkModuleHashes<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> hash<span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>records<span class="token punctuation">.</span>chunkModuleHashes<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">!==</span> hash<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          updatedModules<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>module<span class="token punctuation">,</span> chunk<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        chunkModuleHashes<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> hash<span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>这段代码有很多分支，这里做了精简处理。其核心作用是对比<code>chunk</code>中的<code>module</code>的<code>hash</code>值。如果与原来存放的<code>hash</code>不相等，那么将<code>module/chunk</code>添加到<code>updatedModules</code>中。因此，可以判别出哪些<code>module</code>产生了更新。</p><h3 id="_4-hooks-processassets" tabindex="-1">4. hooks.processAssets <a class="header-anchor" href="#_4-hooks-processassets" aria-hidden="true">#</a></h3><p>在所有代码生成完成之后，调用<code>hooks.processAssets</code>钩子，触发<code>HotModuleReplacementPlugin</code>插件：</p><div class="language-javascript"><pre><code>compilation<span class="token punctuation">.</span>hooks<span class="token punctuation">.</span>processAssets<span class="token punctuation">.</span><span class="token function">tap</span><span class="token punctuation">(</span>
  <span class="token punctuation">{</span>
    <span class="token literal-property property">name</span><span class="token operator">:</span> <span class="token string">&quot;HotModuleReplacementPlugin&quot;</span><span class="token punctuation">,</span>
    <span class="token literal-property property">stage</span><span class="token operator">:</span> Compilation<span class="token punctuation">.</span><span class="token constant">PROCESS_ASSETS_STAGE_ADDITIONAL</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> key <span class="token keyword">of</span> Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>records<span class="token punctuation">.</span>chunkHashes<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token comment">// 新 module</span>
      newModules <span class="token operator">=</span> chunkGraph
        <span class="token punctuation">.</span><span class="token function">getChunkModules</span><span class="token punctuation">(</span>currentChunk<span class="token punctuation">)</span>
        <span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token parameter">module</span> <span class="token operator">=&gt;</span> updatedModules<span class="token punctuation">.</span><span class="token function">has</span><span class="token punctuation">(</span>module<span class="token punctuation">,</span> currentChunk<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// 新 runtime module</span>
      newRuntimeModules <span class="token operator">=</span> Array<span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span>
        chunkGraph<span class="token punctuation">.</span><span class="token function">getChunkRuntimeModulesIterable</span><span class="token punctuation">(</span>currentChunk<span class="token punctuation">)</span>
      <span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token parameter">module</span> <span class="token operator">=&gt;</span> updatedModules<span class="token punctuation">.</span><span class="token function">has</span><span class="token punctuation">(</span>module<span class="token punctuation">,</span> currentChunk<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// 新 fullhash module</span>
      <span class="token keyword">const</span> fullHashModules <span class="token operator">=</span>
            chunkGraph<span class="token punctuation">.</span><span class="token function">getChunkFullHashModulesIterable</span><span class="token punctuation">(</span>currentChunk<span class="token punctuation">)</span><span class="token punctuation">;</span>
      newFullHashModules <span class="token operator">=</span>
        fullHashModules <span class="token operator">&amp;&amp;</span>
        Array<span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span>fullHashModules<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token parameter">module</span> <span class="token operator">=&gt;</span>
                                           updatedModules<span class="token punctuation">.</span><span class="token function">has</span><span class="token punctuation">(</span>module<span class="token punctuation">,</span> currentChunk<span class="token punctuation">)</span>
                                          <span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">const</span> dependentHashModules <span class="token operator">=</span>
            chunkGraph<span class="token punctuation">.</span><span class="token function">getChunkDependentHashModulesIterable</span><span class="token punctuation">(</span>currentChunk<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// 新 dependency module</span>
      newDependentHashModules <span class="token operator">=</span>
        dependentHashModules <span class="token operator">&amp;&amp;</span>
        Array<span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span>dependentHashModules<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">filter</span><span class="token punctuation">(</span><span class="token parameter">module</span> <span class="token operator">=&gt;</span>
                                                updatedModules<span class="token punctuation">.</span><span class="token function">has</span><span class="token punctuation">(</span>module<span class="token punctuation">,</span> currentChunk<span class="token punctuation">)</span>
                                               <span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// 移除的 runtime module</span>
      removedFromRuntime <span class="token operator">=</span> <span class="token function">subtractRuntime</span><span class="token punctuation">(</span>oldRuntime<span class="token punctuation">,</span> newRuntime<span class="token punctuation">)</span><span class="token punctuation">;</span>
      
      <span class="token comment">// ...</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">)</span>
</code></pre></div><p>首先会对<code>chunk</code>下的<code>module</code>的<code>hash</code>值进行对比。对比完成后，得到了更新的<code>module</code>。随后为这些更新后的<code>module</code>创建一个新的<code>chunk</code>，类型为<code>HotUpdateChunk</code>：</p><div class="language-javascript"><pre><code><span class="token comment">// 1. 创建 HotUpdateChunk</span>
<span class="token keyword">const</span> hotUpdateChunk <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HotUpdateChunk</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 2. 记录 chunk</span>
ChunkGraph<span class="token punctuation">.</span><span class="token function">setChunkGraphForChunk</span><span class="token punctuation">(</span>hotUpdateChunk<span class="token punctuation">,</span> chunkGraph<span class="token punctuation">)</span><span class="token punctuation">;</span>
hotUpdateChunk<span class="token punctuation">.</span>id <span class="token operator">=</span> chunkId<span class="token punctuation">;</span>
hotUpdateChunk<span class="token punctuation">.</span>runtime <span class="token operator">=</span> newRuntime<span class="token punctuation">;</span>
<span class="token comment">// 3. 添加到当前 chunkGroup</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>currentChunk<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> group <span class="token keyword">of</span> currentChunk<span class="token punctuation">.</span>groupsIterable<span class="token punctuation">)</span>
    hotUpdateChunk<span class="token punctuation">.</span><span class="token function">addGroup</span><span class="token punctuation">(</span>group<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">// 4. 建立联系</span>
chunkGraph<span class="token punctuation">.</span><span class="token function">attachModules</span><span class="token punctuation">(</span>hotUpdateChunk<span class="token punctuation">,</span> newModules <span class="token operator">||</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
chunkGraph<span class="token punctuation">.</span><span class="token function">attachRuntimeModules</span><span class="token punctuation">(</span>
  hotUpdateChunk<span class="token punctuation">,</span>
  newRuntimeModules <span class="token operator">||</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>newFullHashModules<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  chunkGraph<span class="token punctuation">.</span><span class="token function">attachFullHashModules</span><span class="token punctuation">(</span>
    hotUpdateChunk<span class="token punctuation">,</span>
    newFullHashModules
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>newDependentHashModules<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  chunkGraph<span class="token punctuation">.</span><span class="token function">attachDependentHashModules</span><span class="token punctuation">(</span>
    hotUpdateChunk<span class="token punctuation">,</span>
    newDependentHashModules
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">// 5. 新增 chunk render</span>
<span class="token keyword">const</span> renderManifest <span class="token operator">=</span> compilation<span class="token punctuation">.</span><span class="token function">getRenderManifest</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  <span class="token literal-property property">chunk</span><span class="token operator">:</span> hotUpdateChunk<span class="token punctuation">,</span>
  <span class="token literal-property property">hash</span><span class="token operator">:</span> records<span class="token punctuation">.</span>hash<span class="token punctuation">,</span>
  <span class="token literal-property property">fullHash</span><span class="token operator">:</span> records<span class="token punctuation">.</span>hash<span class="token punctuation">,</span>
  <span class="token literal-property property">outputOptions</span><span class="token operator">:</span> compilation<span class="token punctuation">.</span>outputOptions<span class="token punctuation">,</span>
  <span class="token literal-property property">moduleTemplates</span><span class="token operator">:</span> compilation<span class="token punctuation">.</span>moduleTemplates<span class="token punctuation">,</span>
  <span class="token literal-property property">dependencyTemplates</span><span class="token operator">:</span> compilation<span class="token punctuation">.</span>dependencyTemplates<span class="token punctuation">,</span>
  <span class="token literal-property property">codeGenerationResults</span><span class="token operator">:</span> compilation<span class="token punctuation">.</span>codeGenerationResults<span class="token punctuation">,</span>
  <span class="token literal-property property">runtimeTemplate</span><span class="token operator">:</span> compilation<span class="token punctuation">.</span>runtimeTemplate<span class="token punctuation">,</span>
  <span class="token literal-property property">moduleGraph</span><span class="token operator">:</span> compilation<span class="token punctuation">.</span>moduleGraph<span class="token punctuation">,</span>
  chunkGraph
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 6. 生成代码，并进行 emit</span>
<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> entry <span class="token keyword">of</span> renderManifest<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> filename<span class="token punctuation">;</span>
  <span class="token keyword">let</span> assetInfo<span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token string">&quot;filename&quot;</span> <span class="token keyword">in</span> entry<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    filename <span class="token operator">=</span> entry<span class="token punctuation">.</span>filename<span class="token punctuation">;</span>
    assetInfo <span class="token operator">=</span> entry<span class="token punctuation">.</span>info<span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token punctuation">(</span><span class="token punctuation">{</span> <span class="token literal-property property">path</span><span class="token operator">:</span> filename<span class="token punctuation">,</span> <span class="token literal-property property">info</span><span class="token operator">:</span> assetInfo <span class="token punctuation">}</span> <span class="token operator">=</span>
     compilation<span class="token punctuation">.</span><span class="token function">getPathWithInfo</span><span class="token punctuation">(</span>
      entry<span class="token punctuation">.</span>filenameTemplate<span class="token punctuation">,</span>
      entry<span class="token punctuation">.</span>pathOptions
    <span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">const</span> source <span class="token operator">=</span> entry<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  compilation<span class="token punctuation">.</span>additionalChunkAssets<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>filename<span class="token punctuation">)</span><span class="token punctuation">;</span>
  compilation<span class="token punctuation">.</span><span class="token function">emitAsset</span><span class="token punctuation">(</span>filename<span class="token punctuation">,</span> source<span class="token punctuation">,</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">hotModuleReplacement</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    <span class="token operator">...</span>assetInfo
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>currentChunk<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    currentChunk<span class="token punctuation">.</span>files<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>filename<span class="token punctuation">)</span><span class="token punctuation">;</span>
    compilation<span class="token punctuation">.</span>hooks<span class="token punctuation">.</span><span class="token function">chunkAsset</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>currentChunk<span class="token punctuation">,</span> filename<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token comment">// 8. 记录更新的 runtime</span>
<span class="token function">forEachRuntime</span><span class="token punctuation">(</span>newRuntime<span class="token punctuation">,</span> <span class="token parameter">runtime</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  hotUpdateMainContentByRuntime
    <span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>runtime<span class="token punctuation">)</span>
    <span class="token punctuation">.</span>updatedChunkIds<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>chunkId<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>具体的执行步骤已经注释，需要注意的是<code>HotUpdateChunk</code>在<code>getRenderManifest</code>时，此时<code>filename</code>获取的是<code>outputOptions.hotUpdateChunkFilename</code>：</p><div class="language-javascript"><pre><code><span class="token comment">// 调用getRenderManifest时触发</span>
<span class="token keyword">const</span> filenameTemplate <span class="token operator">=</span> JavascriptModulesPlugin<span class="token punctuation">.</span><span class="token function">getChunkFilenameTemplate</span><span class="token punctuation">(</span>chunk<span class="token punctuation">,</span> outputOptions<span class="token punctuation">)</span><span class="token punctuation">;</span>
result<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  render<span class="token punctuation">,</span>
  filenameTemplate<span class="token punctuation">,</span>
  <span class="token comment">// ..</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">//  实际使用的是 getChunkFilenameTemplate 方法获取 filename</span>
<span class="token keyword">static</span> <span class="token function">getChunkFilenameTemplate</span><span class="token punctuation">(</span><span class="token parameter">chunk<span class="token punctuation">,</span> outputOptions</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>chunk<span class="token punctuation">.</span>filenameTemplate<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> chunk<span class="token punctuation">.</span>filenameTemplate<span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>chunk <span class="token keyword">instanceof</span> <span class="token class-name">HotUpdateChunk</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> outputOptions<span class="token punctuation">.</span>hotUpdateChunkFilename<span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>chunk<span class="token punctuation">.</span><span class="token function">canBeInitial</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> outputOptions<span class="token punctuation">.</span>filename<span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> outputOptions<span class="token punctuation">.</span>chunkFilename<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>而在项目启动的初始化阶段，定义了一些属性，其中就包含<code>hotUpdateChunkFilename</code>：</p><div class="language-javascript"><pre><code><span class="token constant">D</span><span class="token punctuation">(</span>output<span class="token punctuation">,</span> <span class="token string">&quot;hotUpdateChunkFilename&quot;</span><span class="token punctuation">,</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">[id].[fullhash].hot-update.</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>output<span class="token punctuation">.</span>module <span class="token operator">?</span> <span class="token string">&quot;mjs&quot;</span> <span class="token operator">:</span> <span class="token string">&quot;js&quot;</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token constant">D</span><span class="token punctuation">(</span>output<span class="token punctuation">,</span> <span class="token string">&quot;hotUpdateMainFilename&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;[runtime].[fullhash].hot-update.json&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>这就是热更新时<code>xxx.hot-update.js</code>文件生成的实际位置，它包含了所有更新的模块的代码。</p><p>最后，根据更新的模块，将变动信息直接输出到<code>xxx.hot-update.json</code>文件当中。</p><div class="language-javascript"><pre><code><span class="token comment">// 添加 xxx-hot-update.json</span>
<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token punctuation">[</span>
  filename<span class="token punctuation">,</span>
  <span class="token punctuation">{</span> removedChunkIds<span class="token punctuation">,</span> removedModules<span class="token punctuation">,</span> updatedChunkIds<span class="token punctuation">,</span> assetInfo <span class="token punctuation">}</span>
<span class="token punctuation">]</span> <span class="token keyword">of</span> hotUpdateMainContentByFilename<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> hotUpdateMainJson <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">c</span><span class="token operator">:</span> Array<span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span>updatedChunkIds<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token literal-property property">r</span><span class="token operator">:</span> Array<span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span>removedChunkIds<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token literal-property property">m</span><span class="token operator">:</span>
    removedModules<span class="token punctuation">.</span>size <span class="token operator">===</span> <span class="token number">0</span>
    <span class="token operator">?</span> completelyRemovedModulesArray
    <span class="token operator">:</span> completelyRemovedModulesArray<span class="token punctuation">.</span><span class="token function">concat</span><span class="token punctuation">(</span>
      Array<span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span>removedModules<span class="token punctuation">,</span> <span class="token parameter">m</span> <span class="token operator">=&gt;</span>
                 chunkGraph<span class="token punctuation">.</span><span class="token function">getModuleId</span><span class="token punctuation">(</span>m<span class="token punctuation">)</span>
                <span class="token punctuation">)</span>
    <span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
  
  <span class="token keyword">const</span> source <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RawSource</span><span class="token punctuation">(</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>hotUpdateMainJson<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  compilation<span class="token punctuation">.</span><span class="token function">emitAsset</span><span class="token punctuation">(</span>filename<span class="token punctuation">,</span> source<span class="token punctuation">,</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">hotModuleReplacement</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    <span class="token operator">...</span>assetInfo
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>其中<code>c</code>代表更新的<code>chunk id</code>，<code>r</code>代表移除的<code>chunk id</code>，<code>m</code>代表移除的<code>module</code>。</p><h3 id="_5-hooks-record" tabindex="-1">5. hooks.record <a class="header-anchor" href="#_5-hooks-record" aria-hidden="true">#</a></h3><p>最终会记录一些<code>hash、id</code>等相关信息：</p><div class="language-javascript"><pre><code>compilation<span class="token punctuation">.</span>hooks<span class="token punctuation">.</span>record<span class="token punctuation">.</span><span class="token function">tap</span><span class="token punctuation">(</span>
  <span class="token string">&quot;HotModuleReplacementPlugin&quot;</span><span class="token punctuation">,</span>
  <span class="token punctuation">(</span><span class="token parameter">compilation<span class="token punctuation">,</span> records</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>records<span class="token punctuation">.</span>hash <span class="token operator">===</span> compilation<span class="token punctuation">.</span>hash<span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> chunkGraph <span class="token operator">=</span> compilation<span class="token punctuation">.</span>chunkGraph<span class="token punctuation">;</span>
    records<span class="token punctuation">.</span>hash <span class="token operator">=</span> compilation<span class="token punctuation">.</span>hash<span class="token punctuation">;</span>
    records<span class="token punctuation">.</span>fullHashChunkModuleHashes <span class="token operator">=</span> fullHashChunkModuleHashes<span class="token punctuation">;</span>
    records<span class="token punctuation">.</span>chunkModuleHashes <span class="token operator">=</span> chunkModuleHashes<span class="token punctuation">;</span>
    records<span class="token punctuation">.</span>chunkHashes <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
    records<span class="token punctuation">.</span>chunkRuntime <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> chunk <span class="token keyword">of</span> compilation<span class="token punctuation">.</span>chunks<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      records<span class="token punctuation">.</span>chunkHashes<span class="token punctuation">[</span>chunk<span class="token punctuation">.</span>id<span class="token punctuation">]</span> <span class="token operator">=</span> chunk<span class="token punctuation">.</span>hash<span class="token punctuation">;</span>
      records<span class="token punctuation">.</span>chunkRuntime<span class="token punctuation">[</span>chunk<span class="token punctuation">.</span>id<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token function">getRuntimeKey</span><span class="token punctuation">(</span>chunk<span class="token punctuation">.</span>runtime<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// ...</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="小结-1" tabindex="-1">小结 <a class="header-anchor" href="#小结-1" aria-hidden="true">#</a></h3><p><code>HotModuleReplacementPlugin</code>的作用实际上有三个：</p><ol><li>处理<code>module.hot.xxx</code>等<code>api</code>，转换成新的代码。</li><li>对比<code>hash</code>值，判断出哪些<code>module/chunk</code>更新。将更新的模块单独生成一个<code>chunk</code>，将代码输出到<code>xxx.hot-update.js</code>文件中。而将更新的信息输出到<code>xxx.hot-update.json</code>文件中。</li><li>添加<code>HotModuleReplacementRuntimeModule</code>模块，供后续触发更新。</li></ol><h2 id="建立服务端server" tabindex="-1">建立服务端server <a class="header-anchor" href="#建立服务端server" aria-hidden="true">#</a></h2><p><code>webpack</code>中使用<code>express</code>作为服务端框架为浏览器提供服务：</p><div class="language-javascript"><pre><code><span class="token comment">// 建立 server</span>
<span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setupApp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 检查请求头部信息</span>
<span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setupHostHeaderCheck</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 创建 server</span>
<span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">createServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 监听</span>
<span class="token keyword">await</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>server<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span>listenOptions<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>在<code>express</code>的基础上，创建服务端的<code>WebSocket</code>，用于给客户端发送信息：</p><div class="language-javascript"><pre><code><span class="token function">createWebSocketServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>webSocketServer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getServerTransport</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>webSocketServer<span class="token punctuation">.</span>implementation<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">&quot;connection&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">client<span class="token punctuation">,</span> request</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>因此，服务端通过<code>express</code>为客户端提供<code>api</code>服务，并通过<code>WebSocket</code>给客户端发送信息。</p><h2 id="webpack-dev-middleware" tabindex="-1">webpack-dev-middleware <a class="header-anchor" href="#webpack-dev-middleware" aria-hidden="true">#</a></h2><p>在向<code>express</code>发送请求时，会经过<code>webpack-dev-middleware</code>中间件，它的调用在<code>setupDevMiddleware</code>中：</p><div class="language-javascript"><pre><code><span class="token function">setupDevMiddleware</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> webpackDevMiddleware <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;webpack-dev-middleware&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>middleware <span class="token operator">=</span> <span class="token function">webpackDevMiddleware</span><span class="token punctuation">(</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>compiler<span class="token punctuation">,</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>options<span class="token punctuation">.</span>devMiddleware
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p><code>webpackDevMiddleware</code>方法核心如下：</p><div class="language-javascript"><pre><code>context<span class="token punctuation">.</span>watching <span class="token operator">=</span> context<span class="token punctuation">.</span>compiler<span class="token punctuation">.</span><span class="token function">watch</span><span class="token punctuation">(</span>watchOptions<span class="token punctuation">,</span> <span class="token parameter">error</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> instance <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> _middleware<span class="token punctuation">.</span>default<span class="token punctuation">)</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// API</span>
</code></pre></div><p>一是调用<code>compiler.watch</code>方法进行编译并监听文件变化，二是应用<code>webpack-dev-middleware</code>中间件。</p><p>在编译的过程中会调用前面提到的<code>HotModuleReplacementPlugin</code>，并且编译完成后触发<code>hooks.done</code>钩子。而在<code>webpack-dev-server</code>中，监听了<code>hooks.done</code>钩子：</p><div class="language-javascript"><pre><code><span class="token function">setupHooks</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>compiler<span class="token punctuation">.</span>hooks<span class="token punctuation">.</span>done<span class="token punctuation">.</span><span class="token function">tap</span><span class="token punctuation">(</span><span class="token string">&quot;webpack-dev-server&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">stats</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// 编译完成，发送给 server websocket</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>webSocketServer<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">sendStats</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>webSocketServer<span class="token punctuation">.</span>clients<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">getStats</span><span class="token punctuation">(</span>stats<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>stats <span class="token operator">=</span> stats<span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>此时会通过服务端<code>server</code>向所有客户端发送编译完成的消息，如<code>&quot;ok&quot;</code>。</p><p>来到<code>webpack-dev-server/client/index.js</code>，有接收消息的回调：</p><div class="language-javascript"><pre><code><span class="token function-variable function">ok</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token function">ok</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">sendMessage</span><span class="token punctuation">(</span><span class="token string">&quot;Ok&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">if</span> <span class="token punctuation">(</span>options<span class="token punctuation">.</span>overlay<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">hide</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token function">reloadApp</span><span class="token punctuation">(</span>options<span class="token punctuation">,</span> status<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span>
</code></pre></div><p>此时触发<code>reloadApp</code>方法：</p><div class="language-javascript"><pre><code><span class="token keyword">if</span> <span class="token punctuation">(</span>hot <span class="token operator">&amp;&amp;</span> allowToHot<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  hotEmitter<span class="token punctuation">.</span><span class="token function">emit</span><span class="token punctuation">(</span><span class="token string">&quot;webpackHotUpdate&quot;</span><span class="token punctuation">,</span> status<span class="token punctuation">.</span>currentHash<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> 
</code></pre></div><p>最终触发<code>webpackHotUpdate</code>事件，而在<code>webpack/hot/dev-server.js</code>文件中，监听了该事件：</p><div class="language-javascript"><pre><code><span class="token keyword">if</span> <span class="token punctuation">(</span>module<span class="token punctuation">.</span>hot<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> <span class="token function-variable function">check</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token function">check</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    module<span class="token punctuation">.</span>hot
      <span class="token punctuation">.</span><span class="token function">check</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">updatedModules</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">catch</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">err</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token keyword">var</span> hotEmitter <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;./emitter&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  hotEmitter<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">&quot;webpackHotUpdate&quot;</span><span class="token punctuation">,</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">currentHash</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">upToDate</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> module<span class="token punctuation">.</span>hot<span class="token punctuation">.</span><span class="token function">status</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token string">&quot;idle&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">check</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> 
</code></pre></div><p>此时会调用<code>module.hot.check(true)</code>方法。</p><h2 id="hotcheck" tabindex="-1">hotCheck <a class="header-anchor" href="#hotcheck" aria-hidden="true">#</a></h2><p><code>module.hot.check(true)</code>方法对应于<code>webpack/lib/hmr/HotModuleReplacement.runtime.js</code>文件中的<code>hotCheck</code>方法，实际编译后的代码类似如下：</p><div class="language-javascript"><pre><code><span class="token keyword">function</span> <span class="token function">hotCheck</span><span class="token punctuation">(</span><span class="token parameter">applyOnUpdate</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token keyword">return</span> <span class="token function">setStatus</span><span class="token punctuation">(</span><span class="token string">&quot;check&quot;</span><span class="token punctuation">)</span>
  	<span class="token comment">// 1. 请求 xxx-hot-update.json 文件</span>
		<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>__webpack_require__<span class="token punctuation">.</span>hmrM<span class="token punctuation">)</span>
		<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">update</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token keyword">return</span> <span class="token function">setStatus</span><span class="token punctuation">(</span><span class="token string">&quot;prepare&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
				<span class="token keyword">var</span> updatedModules <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
				blockingPromises <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
				currentUpdateApplyHandlers <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
				<span class="token comment">// 2. 请求变更后的 chunks</span>
				<span class="token keyword">return</span> Promise<span class="token punctuation">.</span><span class="token function">all</span><span class="token punctuation">(</span>
					Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>__webpack_require__<span class="token punctuation">.</span>hmrC<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">reduce</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span>
						<span class="token parameter">promises<span class="token punctuation">,</span>
						key</span>
					<span class="token punctuation">)</span> <span class="token punctuation">{</span>
						__webpack_require__<span class="token punctuation">.</span>hmrC<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">(</span>
							update<span class="token punctuation">.</span>c<span class="token punctuation">,</span>
							update<span class="token punctuation">.</span>r<span class="token punctuation">,</span>
							update<span class="token punctuation">.</span>m<span class="token punctuation">,</span>
							promises<span class="token punctuation">,</span>
							currentUpdateApplyHandlers<span class="token punctuation">,</span>
							updatedModules
						<span class="token punctuation">)</span><span class="token punctuation">;</span>
						<span class="token keyword">return</span> promises<span class="token punctuation">;</span>
					<span class="token punctuation">}</span><span class="token punctuation">,</span>
					<span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
				<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
					<span class="token keyword">return</span> <span class="token function">waitForBlockingPromises</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
						<span class="token keyword">if</span> <span class="token punctuation">(</span>applyOnUpdate<span class="token punctuation">)</span> <span class="token punctuation">{</span>
              <span class="token comment">// 3. 进行热更新应用</span>
							<span class="token keyword">return</span> <span class="token function">internalApply</span><span class="token punctuation">(</span>applyOnUpdate<span class="token punctuation">)</span><span class="token punctuation">;</span>
						<span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
							<span class="token keyword">return</span> <span class="token function">setStatus</span><span class="token punctuation">(</span><span class="token string">&quot;ready&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
								<span class="token keyword">return</span> updatedModules<span class="token punctuation">;</span>
							<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
						<span class="token punctuation">}</span>
					<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="fullhash-hot-update-json" tabindex="-1">[fullhash].hot-update.json <a class="header-anchor" href="#fullhash-hot-update-json" aria-hidden="true">#</a></h3><p><code>__webpack_require__.hmrM</code>对应的代码如下：</p><div class="language-javascript"><pre><code><span class="token comment">/* webpack/runtime/getFullHash */</span>
<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
	__webpack_require__<span class="token punctuation">.</span><span class="token function-variable function">h</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">(</span><span class="token string">&quot;a4c01381c6f871e5f847&quot;</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">/* webpack/runtime/get update manifest filename */</span>
<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
	__webpack_require__<span class="token punctuation">.</span><span class="token function-variable function">hmrF</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">(</span><span class="token string">&quot;index.&quot;</span> <span class="token operator">+</span> __webpack_require__<span class="token punctuation">.</span><span class="token function">h</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;.hot-update.json&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

__webpack_require__<span class="token punctuation">.</span><span class="token function-variable function">hmrM</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> fetch <span class="token operator">===</span> <span class="token string">&quot;undefined&quot;</span><span class="token punctuation">)</span> <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">&quot;No browser support: need fetch API&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token function">fetch</span><span class="token punctuation">(</span>__webpack_require__<span class="token punctuation">.</span>p <span class="token operator">+</span> __webpack_require__<span class="token punctuation">.</span><span class="token function">hmrF</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">response</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span>response<span class="token punctuation">.</span>status <span class="token operator">===</span> <span class="token number">404</span><span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span> <span class="token comment">// no update available</span>
    <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token operator">!</span>response<span class="token punctuation">.</span>ok<span class="token punctuation">)</span> <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">&quot;Failed to fetch update manifest &quot;</span> <span class="token operator">+</span> response<span class="token punctuation">.</span>statusText<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> response<span class="token punctuation">.</span><span class="token function">json</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>	
</code></pre></div><p>实际上它是根据<code>fullhash</code>来拼接更新信息的请求地址，然后发送请求。此时<code>express</code>接收到请求，通过<code>webpack-dev-middleware</code>中间件，在内存中读取<code>[fullhash].hot-update.json</code>文件，并返回给客户端。</p><h3 id="fullhash-hot-update-js" tabindex="-1">[fullhash].hot-update.js <a class="header-anchor" href="#fullhash-hot-update-js" aria-hidden="true">#</a></h3><p>拿到更新信息后，通过<code>__webpack_require__.hmrC</code>方法加载更新后的<code>chunk</code>：</p><div class="language-javascript"><pre><code>__webpack_require__<span class="token punctuation">.</span>hmrC<span class="token punctuation">.</span><span class="token function-variable function">jsonp</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>
 <span class="token parameter">chunkIds<span class="token punctuation">,</span>
 removedChunks<span class="token punctuation">,</span>
 removedModules<span class="token punctuation">,</span>
 promises<span class="token punctuation">,</span>
 applyHandlers<span class="token punctuation">,</span>
 updatedModulesList</span>
<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  applyHandlers<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>applyHandler<span class="token punctuation">)</span><span class="token punctuation">;</span>
  currentUpdateChunks <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
  currentUpdateRemovedChunks <span class="token operator">=</span> removedChunks<span class="token punctuation">;</span>
  currentUpdate <span class="token operator">=</span> removedModules<span class="token punctuation">.</span><span class="token function">reduce</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">obj<span class="token punctuation">,</span> key</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    obj<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> obj<span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  currentUpdateRuntime <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  chunkIds<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">chunkId</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>
      __webpack_require__<span class="token punctuation">.</span><span class="token function">o</span><span class="token punctuation">(</span>installedChunks<span class="token punctuation">,</span> chunkId<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span>
      installedChunks<span class="token punctuation">[</span>chunkId<span class="token punctuation">]</span> <span class="token operator">!==</span> <span class="token keyword">undefined</span>
    <span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 根据 chunkId, 加载最新的 chunk</span>
      promises<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token function">loadUpdateChunk</span><span class="token punctuation">(</span>chunkId<span class="token punctuation">,</span> updatedModulesList<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      currentUpdateChunks<span class="token punctuation">[</span>chunkId<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p>其中<code>loadUpdateChunk</code>如下：</p><div class="language-javascript"><pre><code><span class="token comment">/* webpack/runtime/get javascript update chunk filename */</span>
<span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// This function allow to reference all chunks</span>
  __webpack_require__<span class="token punctuation">.</span><span class="token function-variable function">hu</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">chunkId</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// return url for filenames based on template</span>
    <span class="token keyword">return</span> <span class="token string">&quot;&quot;</span> <span class="token operator">+</span> chunkId <span class="token operator">+</span> <span class="token string">&quot;.&quot;</span> <span class="token operator">+</span> __webpack_require__<span class="token punctuation">.</span><span class="token function">h</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;.hot-update.js&quot;</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">function</span> <span class="token function">loadUpdateChunk</span><span class="token punctuation">(</span><span class="token parameter">chunkId</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">resolve<span class="token punctuation">,</span> reject</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> url <span class="token operator">=</span> __webpack_require__<span class="token punctuation">.</span>p <span class="token operator">+</span> __webpack_require__<span class="token punctuation">.</span><span class="token function">hu</span><span class="token punctuation">(</span>chunkId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// ...</span>
    __webpack_require__<span class="token punctuation">.</span><span class="token function">l</span><span class="token punctuation">(</span>url<span class="token punctuation">,</span> loadingEnded<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>根据<code>hot-update.json</code>文件中的<code>chunkId</code>加载最新的<code>chunk</code>。加载完成后，实际是加载的变更后的<code>module</code>代码，类似如下：</p><div class="language-javascript"><pre><code>self<span class="token punctuation">[</span><span class="token string">&quot;webpackHotUpdatestudy_webpack&quot;</span><span class="token punctuation">]</span><span class="token punctuation">(</span>
  <span class="token comment">// chunk id</span>
  <span class="token string">&quot;index&quot;</span><span class="token punctuation">,</span>
  <span class="token comment">// 更新的 module</span>
  <span class="token punctuation">{</span>
    <span class="token string-property property">&quot;./src/moduleB.js&quot;</span><span class="token operator">:</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">module<span class="token punctuation">,</span> __webpack_exports__<span class="token punctuation">,</span> __webpack_require__</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token function">eval</span><span class="token punctuation">(</span><span class="token string">&quot;xxxxx省略xxxxx&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token comment">// 更新的 runtime</span>
  <span class="token keyword">function</span><span class="token punctuation">(</span><span class="token parameter">__webpack_require__</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      __webpack_require__<span class="token punctuation">.</span><span class="token function-variable function">h</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">(</span><span class="token string">&quot;23e988120ea958e8108f&quot;</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>而在入口文件中，定义了<code>webpackHotUpdatestudy_webpack</code>（该变量名称是根据项目名称定的）：</p><div class="language-javascript"><pre><code>self<span class="token punctuation">[</span><span class="token string">&quot;webpackHotUpdatestudy_webpack&quot;</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">chunkId<span class="token punctuation">,</span> moreModules<span class="token punctuation">,</span> runtime</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> moduleId <span class="token keyword">in</span> moreModules<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>__webpack_require__<span class="token punctuation">.</span><span class="token function">o</span><span class="token punctuation">(</span>moreModules<span class="token punctuation">,</span> moduleId<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      currentUpdate<span class="token punctuation">[</span>moduleId<span class="token punctuation">]</span> <span class="token operator">=</span> moreModules<span class="token punctuation">[</span>moduleId<span class="token punctuation">]</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>currentUpdatedModulesList<span class="token punctuation">)</span> currentUpdatedModulesList<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>moduleId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>runtime<span class="token punctuation">)</span> currentUpdateRuntime<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>runtime<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>waitingUpdateResolves<span class="token punctuation">[</span>chunkId<span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    waitingUpdateResolves<span class="token punctuation">[</span>chunkId<span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    waitingUpdateResolves<span class="token punctuation">[</span>chunkId<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">undefined</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p>最终更新的<code>module</code>和<code>runtime</code>会记录到<code>currentUpdate</code>和<code>currentUpdateRuntime</code>变量当中。</p><h2 id="hotapply" tabindex="-1">hotApply <a class="header-anchor" href="#hotapply" aria-hidden="true">#</a></h2><p>得到更新后的代码后，接下来就需要根据用户定义的<code>module.hot.xxx</code>等<code>api</code>来进行热更新了。</p><h3 id="module-hot相关api定义" tabindex="-1">module.hot相关api定义 <a class="header-anchor" href="#module-hot相关api定义" aria-hidden="true">#</a></h3><div class="language-javascript"><pre><code><span class="token comment">// HotModuleReplacement.runtime.js 打包后</span>
__webpack_require__<span class="token punctuation">.</span>i<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">options</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> module <span class="token operator">=</span> options<span class="token punctuation">.</span>module<span class="token punctuation">;</span>
  <span class="token keyword">var</span> require <span class="token operator">=</span> <span class="token function">createRequire</span><span class="token punctuation">(</span>options<span class="token punctuation">.</span>require<span class="token punctuation">,</span> options<span class="token punctuation">.</span>id<span class="token punctuation">)</span><span class="token punctuation">;</span>
  module<span class="token punctuation">.</span>hot <span class="token operator">=</span> <span class="token function">createModuleHotObject</span><span class="token punctuation">(</span>options<span class="token punctuation">.</span>id<span class="token punctuation">,</span> module<span class="token punctuation">)</span><span class="token punctuation">;</span>
  module<span class="token punctuation">.</span>parents <span class="token operator">=</span> currentParents<span class="token punctuation">;</span>
  module<span class="token punctuation">.</span>children <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  currentParents <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  options<span class="token punctuation">.</span>require <span class="token operator">=</span> require<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 加载模块时，会执行 __webpack_require__.i，为 module.hot 赋值。</span>
<span class="token keyword">function</span> <span class="token function">__webpack_require__</span><span class="token punctuation">(</span><span class="token parameter">moduleId</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> module <span class="token operator">=</span> __webpack_module_cache__<span class="token punctuation">[</span>moduleId<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">id</span><span class="token operator">:</span> moduleId<span class="token punctuation">,</span>
    <span class="token literal-property property">loaded</span><span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
    <span class="token literal-property property">exports</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">var</span> execOptions <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token literal-property property">id</span><span class="token operator">:</span> moduleId<span class="token punctuation">,</span> <span class="token literal-property property">module</span><span class="token operator">:</span> module<span class="token punctuation">,</span> <span class="token literal-property property">factory</span><span class="token operator">:</span> __webpack_modules__<span class="token punctuation">[</span>moduleId<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token literal-property property">require</span><span class="token operator">:</span> __webpack_require__ <span class="token punctuation">}</span><span class="token punctuation">;</span>
  __webpack_require__<span class="token punctuation">.</span>i<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">handler</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token function">handler</span><span class="token punctuation">(</span>execOptions<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  module <span class="token operator">=</span> execOptions<span class="token punctuation">.</span>module<span class="token punctuation">;</span>
  execOptions<span class="token punctuation">.</span><span class="token function">factory</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>module<span class="token punctuation">.</span>exports<span class="token punctuation">,</span> module<span class="token punctuation">,</span> module<span class="token punctuation">.</span>exports<span class="token punctuation">,</span> execOptions<span class="token punctuation">.</span>require<span class="token punctuation">)</span><span class="token punctuation">;</span>

  module<span class="token punctuation">.</span>loaded <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> module<span class="token punctuation">.</span>exports<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>在模块加载时，执行<code>__webpack_require__.i</code>，此时会通过<code>createModuleHotObject</code>函数创建<code>module.hot</code>对象。因此可以正常访问到<code>module.hot.xxx</code>属性。</p><h3 id="applyinvalidatedmodules" tabindex="-1">applyInvalidatedModules <a class="header-anchor" href="#applyinvalidatedmodules" aria-hidden="true">#</a></h3><p>首先是调用<code>applyInvalidatedModules</code>方法：</p><div class="language-javascript"><pre><code><span class="token keyword">function</span> <span class="token function">applyInvalidatedModules</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>queuedInvalidatedModules<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>currentUpdateApplyHandlers<span class="token punctuation">)</span> currentUpdateApplyHandlers <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>__webpack_require__<span class="token punctuation">.</span>hmrI<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">key</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      queuedInvalidatedModules<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">moduleId</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        __webpack_require__<span class="token punctuation">.</span>hmrI<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">(</span>
          moduleId<span class="token punctuation">,</span>
          currentUpdateApplyHandlers
        <span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    queuedInvalidatedModules <span class="token operator">=</span> <span class="token keyword">undefined</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p><code>queuedInvalidatedModules</code>是在调用<code>module.hot.invalidate</code>方法时收集到的<code>module</code>：</p><div class="language-javascript"><pre><code><span class="token comment">// invalidate 方法调用时，收集 moduleId</span>
<span class="token function-variable function">invalidate</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">switch</span> <span class="token punctuation">(</span>currentStatus<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">case</span> <span class="token string">&quot;apply&quot;</span><span class="token operator">:</span>
      <span class="token punctuation">(</span>queuedInvalidatedModules <span class="token operator">=</span> queuedInvalidatedModules <span class="token operator">||</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>
        moduleId
      <span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">break</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span>
</code></pre></div><p>循环后调用的是<code>__webpack_require__.hmrI.jsonp</code>：</p><div class="language-javascript"><pre><code>__webpack_require__<span class="token punctuation">.</span>hmrI<span class="token punctuation">.</span><span class="token function-variable function">jsonp</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">moduleId<span class="token punctuation">,</span> applyHandlers</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 如果模块没有更新</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>currentUpdate<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    currentUpdate <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
    currentUpdateRuntime <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    currentUpdateRemovedChunks <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    applyHandlers<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>applyHandler<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// 如果更新的模块中不包含当前模块，那么将该模块添加到更新模块中</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>__webpack_require__<span class="token punctuation">.</span><span class="token function">o</span><span class="token punctuation">(</span>currentUpdate<span class="token punctuation">,</span> moduleId<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    currentUpdate<span class="token punctuation">[</span>moduleId<span class="token punctuation">]</span> <span class="token operator">=</span> __webpack_require__<span class="token punctuation">.</span>m<span class="token punctuation">[</span>moduleId<span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="applyhandler" tabindex="-1">applyHandler <a class="header-anchor" href="#applyhandler" aria-hidden="true">#</a></h3><p>接下来是调用<code>applyHandle</code>，用于解析</p><div class="language-javascript"><pre><code><span class="token keyword">var</span> results <span class="token operator">=</span> currentUpdateApplyHandlers<span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">handler</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token function">handler</span><span class="token punctuation">(</span>options<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p><code>applayHandle</code>的定义是在<code>webpack/lib/hmr/JavascriptHotModuleReplacement.runtime.js</code>文件中：</p><div class="language-javascript"><pre><code><span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> moduleId <span class="token keyword">in</span> currentUpdate<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>__webpack_require__<span class="token punctuation">.</span><span class="token function">o</span><span class="token punctuation">(</span>currentUpdate<span class="token punctuation">,</span> moduleId<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> newModuleFactory <span class="token operator">=</span> currentUpdate<span class="token punctuation">[</span>moduleId<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">var</span> result<span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>newModuleFactory<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      result <span class="token operator">=</span> <span class="token function">getAffectedModuleEffects</span><span class="token punctuation">(</span>moduleId<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      result <span class="token operator">=</span> <span class="token punctuation">{</span>
        <span class="token literal-property property">type</span><span class="token operator">:</span> <span class="token string">&quot;disposed&quot;</span><span class="token punctuation">,</span>
        <span class="token literal-property property">moduleId</span><span class="token operator">:</span> moduleId
      <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    
    <span class="token comment">// ...</span>
  <span class="token punctuation">}</span>
</code></pre></div><p>该函数会遍历更新的<code>module</code>，然后通过<code>getAffectedModuleEffects</code>方法找到该<code>module</code>调用了<code>module.hot</code>的具体<code>api</code>。最后用<code>outdatedModules</code>记录所有需要更新的<code>module</code>，用<code>outdatedDependencies</code>记录<code>parent</code>和<code>children</code>之间需要更新的关系，如：</p><div class="language-javascript"><pre><code><span class="token comment">// outdatedModules</span>
<span class="token punctuation">[</span><span class="token string">&quot;./src/moduleB.js&quot;</span><span class="token punctuation">]</span>

<span class="token comment">// outdatedDependencies</span>
<span class="token punctuation">{</span>
  <span class="token string-property property">&quot;./src/index.js&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&quot;./src/moduleB.js&quot;</span><span class="token punctuation">]</span>
<span class="token punctuation">}</span> 
</code></pre></div><h3 id="dispose" tabindex="-1">dispose <a class="header-anchor" href="#dispose" aria-hidden="true">#</a></h3><p>接着通过<code>dispose</code>方法移除旧的<code>module</code>或<code>chunk</code>：</p><div class="language-javascript"><pre><code>results<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">result</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>result<span class="token punctuation">.</span>dispose<span class="token punctuation">)</span> result<span class="token punctuation">.</span><span class="token function">dispose</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>类似如下操作：</p><div class="language-javascript"><pre><code><span class="token function-variable function">dispose</span><span class="token operator">:</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 省略其他内容的删除</span>
  <span class="token keyword">while</span> <span class="token punctuation">(</span>queue<span class="token punctuation">.</span>length <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// ....</span>
    <span class="token keyword">delete</span> __webpack_require__<span class="token punctuation">.</span>c<span class="token punctuation">[</span>moduleId<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">delete</span> outdatedDependencies<span class="token punctuation">[</span>moduleId<span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// ....</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="apply" tabindex="-1">apply <a class="header-anchor" href="#apply" aria-hidden="true">#</a></h3><p>最后调用<code>apply</code>方法更新内容：</p><div class="language-javascript"><pre><code><span class="token comment">// 更新 module</span>
<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> updateModuleId <span class="token keyword">in</span> appliedUpdate<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>__webpack_require__<span class="token punctuation">.</span><span class="token function">o</span><span class="token punctuation">(</span>appliedUpdate<span class="token punctuation">,</span> updateModuleId<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    __webpack_require__<span class="token punctuation">.</span>m<span class="token punctuation">[</span>updateModuleId<span class="token punctuation">]</span> <span class="token operator">=</span> appliedUpdate<span class="token punctuation">[</span>updateModuleId<span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// 更新 runtime</span>
<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> currentUpdateRuntime<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  currentUpdateRuntime<span class="token punctuation">[</span>i<span class="token punctuation">]</span><span class="token punctuation">(</span>__webpack_require__<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">// 调用 accept 的回调</span>
<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> outdatedModuleId <span class="token keyword">in</span> outdatedDependencies<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>__webpack_require__<span class="token punctuation">.</span><span class="token function">o</span><span class="token punctuation">(</span>outdatedDependencies<span class="token punctuation">,</span> outdatedModuleId<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> module <span class="token operator">=</span> __webpack_require__<span class="token punctuation">.</span>c<span class="token punctuation">[</span>outdatedModuleId<span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>module<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      moduleOutdatedDependencies <span class="token operator">=</span>
        outdatedDependencies<span class="token punctuation">[</span>outdatedModuleId<span class="token punctuation">]</span><span class="token punctuation">;</span>
      <span class="token keyword">var</span> dependenciesForCallbacks <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
      <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> j <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> j <span class="token operator">&lt;</span> moduleOutdatedDependencies<span class="token punctuation">.</span>length<span class="token punctuation">;</span> j<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">var</span> dependency <span class="token operator">=</span> moduleOutdatedDependencies<span class="token punctuation">[</span>j<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">var</span> acceptCallback <span class="token operator">=</span>
            module<span class="token punctuation">.</span>hot<span class="token punctuation">.</span>_acceptedDependencies<span class="token punctuation">[</span>dependency<span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>acceptCallback<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>callbacks<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span>acceptCallback<span class="token punctuation">)</span> <span class="token operator">!==</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token keyword">continue</span><span class="token punctuation">;</span>
          callbacks<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>acceptCallback<span class="token punctuation">)</span><span class="token punctuation">;</span>
          dependenciesForCallbacks<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>dependency<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> k <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> k <span class="token operator">&lt;</span> callbacks<span class="token punctuation">.</span>length<span class="token punctuation">;</span> k<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 触发回调</span>
        callbacks<span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> moduleOutdatedDependencies<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// module.hot.accept() =&gt; 重新加载自身 module</span>
<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">var</span> o <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>o <span class="token operator">&lt;</span> outdatedSelfAcceptedModules<span class="token punctuation">.</span>length<span class="token punctuation">;</span>o<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">var</span> item <span class="token operator">=</span> outdatedSelfAcceptedModules<span class="token punctuation">[</span>o<span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token keyword">var</span> moduleId <span class="token operator">=</span> item<span class="token punctuation">.</span>module<span class="token punctuation">;</span>
  item<span class="token punctuation">.</span><span class="token function">require</span><span class="token punctuation">(</span>moduleId<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="hash-更新" tabindex="-1">hash 更新 <a class="header-anchor" href="#hash-更新" aria-hidden="true">#</a></h2><p>每次请求的<code>json</code>文件都是之前编译的<code>hash</code>。等到模块加载完毕，根据<code>runtime</code>更新对应的<code>hash</code>值。 <img src="/assets/hot-replacement-runtime.2b6259be.jpg" alt=""></p><h2 id="总结" tabindex="-1">总结 <a class="header-anchor" href="#总结" aria-hidden="true">#</a></h2><p>热更新流程如下：</p><ol><li><p><code>compiler.watch</code>监听文件变化，如果变化，开始重新编译。</p></li><li><p>编译过程中：</p><ol><li>首先新增两个<code>entry</code>：一是<code>WebSocket</code>的客户端，用于接收服务端的通知；二是<code>webpack</code>的<code>dev-server</code>，用于监听<code>webpackHotUpdate</code>事件。</li><li>通过<code>HotModuleReplacementPlugin</code>插件，对比编译后的<code>chunk</code>和<code>module</code>，将更新后的<code>module</code>和<code>runtime</code>形成新的<code>HotUpdateChunk</code>。最终将该<code>chunk</code>输出到<code>hot-update.js</code>文件中，而将变化的信息输出到<code>hot-update.json</code>文件中（都在内存中）。</li><li>. <code>HotModuleReplacementPlugin</code>插件还会为<code>&quot;bundle&quot;</code>添加处理更新的代码 —— <code>HotModuleReplacement.runtime.js</code>和<code>JavascriptHotModuleReplacement.runtime.js</code>文件。<code>module.hot</code>等<code>api</code>均在这里定义。</li></ol></li><li><p>编译完成后，触发<code>hooks.done</code>钩子。<code>webpack-dev-server</code>接收到编译完成事件，通过服务端<code>server</code>向客户端发送更新通知。</p></li><li><p>客户端接收到服务端通知，调用<code>reloadApp</code>方法触发<code>webpackHotUpdate</code>事件，<code>webpack</code>的<code>dev-server</code>监听到该事件。</p></li><li><p>客户端开始进行<code>hotCheck</code>：</p><ol><li>根据<code>fullhash</code>通过<code>fetch</code>向<code>express</code>请求<code>hot-update.json</code>文件。</li><li>根据<code>hot-update.json</code>中改变的<code>chunk</code>的<code>id</code>，请求对应的<code>hot-update.js</code>文件。</li><li>执行<code>hot-update.js</code>文件中的代码，将更新后的<code>module</code>和<code>runtime</code>存到<code>currentUpdate</code>和<code>currentUpdateRuntime</code>中。</li></ol></li><li><p>客户端开始进行<code>hotApply</code>：</p><ol><li>遍历<code>currentUpdate</code>，根据用户定义的<code>module.hot</code>相关的<code>api</code>，确认更新的<code>module</code>和<code>runtime</code>。</li><li>调用<code>dispose</code>方法，遍历待更新的<code>module</code>，移除原有的<code>module</code>定义。</li><li>调用<code>apply</code>方法，添加待更新的<code>module</code>的最新定义，并触发<code>module.hot.accept</code>回调。</li></ol></li></ol></div></div><footer class="page-footer" data-v-7eddb2c4 data-v-07c132fc><div class="edit" data-v-07c132fc><div class="edit-link" data-v-07c132fc data-v-1ed99556><!----></div></div><div class="updated" data-v-07c132fc><p class="last-updated" data-v-07c132fc data-v-abce3432><span class="prefix" data-v-abce3432>最近更新:</span><span class="datetime" data-v-abce3432></span></p></div></footer><div class="next-and-prev-link" data-v-7eddb2c4 data-v-38ede35f><div class="container" data-v-38ede35f><div class="prev" data-v-38ede35f><a class="link" href="/webpack/vue-loader实现" data-v-38ede35f><svg xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" class="icon icon-prev" data-v-38ede35f><path d="M19,11H7.4l5.3-5.3c0.4-0.4,0.4-1,0-1.4s-1-0.4-1.4,0l-7,7c-0.1,0.1-0.2,0.2-0.2,0.3c-0.1,0.2-0.1,0.5,0,0.8c0.1,0.1,0.1,0.2,0.2,0.3l7,7c0.2,0.2,0.5,0.3,0.7,0.3s0.5-0.1,0.7-0.3c0.4-0.4,0.4-1,0-1.4L7.4,13H19c0.6,0,1-0.4,1-1S19.6,11,19,11z"></path></svg><span class="text" data-v-38ede35f>vue-loader实现</span></a></div><div class="next" data-v-38ede35f><a class="link" href="/webpack/Tapable" data-v-38ede35f><span class="text" data-v-38ede35f>Tapable</span><svg xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" class="icon icon-next" data-v-38ede35f><path d="M19.9,12.4c0.1-0.2,0.1-0.5,0-0.8c-0.1-0.1-0.1-0.2-0.2-0.3l-7-7c-0.4-0.4-1-0.4-1.4,0s-0.4,1,0,1.4l5.3,5.3H5c-0.6,0-1,0.4-1,1s0.4,1,1,1h11.6l-5.3,5.3c-0.4,0.4-0.4,1,0,1.4c0.2,0.2,0.5,0.3,0.7,0.3s0.5-0.1,0.7-0.3l7-7C19.8,12.6,19.9,12.5,19.9,12.4z"></path></svg></a></div></div></div><!--[--><!--]--></div></main></div><!----><!--]--></div>
    <script>__VP_HASH_MAP__ = JSON.parse("{\"about_readme.md\":\"c49b91ad\",\"about_index.md\":\"6ec5cf0d\",\"about_plan.md\":\"c37633c9\",\"algorithms_index.md\":\"3abe7060\",\"algorithms_二叉树.md\":\"01eefa68\",\"algorithms_动态规划.md\":\"6ba1112f\",\"algorithms_回溯法.md\":\"cafd40d0\",\"algorithms_字符串.md\":\"cbd8c571\",\"algorithms_排序汇总.md\":\"b6acd5b6\",\"algorithms_数组.md\":\"56b32dad\",\"algorithms_树结构遍历.md\":\"f4b1de9d\",\"articles_index.md\":\"f600cf0b\",\"articles_react-concurrency.md\":\"3eb8fde1\",\"articles_todo.md\":\"c72de05b\",\"babel_index.md\":\"c877221e\",\"computer_index.md\":\"5e78aefe\",\"daily_2022_05.md\":\"1a7f7a62\",\"daily_2022_06.md\":\"698d2d0c\",\"daily_2022_07.md\":\"9a415c1b\",\"daily_2022_08.md\":\"432216eb\",\"daily_2022_09.md\":\"ed44a93b\",\"daily_index.md\":\"16686dd7\",\"data-structures_index.md\":\"9ee6239a\",\"data-structures_二叉查找树.md\":\"729dfcc6\",\"data-structures_哈希表.md\":\"13e6823d\",\"data-structures_堆.md\":\"b7f7dd59\",\"data-structures_字典树.md\":\"26aa6330\",\"data-structures_布隆过滤器.md\":\"bd911460\",\"data-structures_平衡二叉树.md\":\"a7ddb2f8\",\"data-structures_并查集.md\":\"59a5cff2\",\"data-structures_树状数组.md\":\"ad91b7f5\",\"data-structures_红黑树.md\":\"f1e3f69d\",\"data-structures_线段树.md\":\"db11d921\",\"design-pattern_index.md\":\"a3ff5d99\",\"design-pattern_创建型模式.md\":\"5675189c\",\"design-pattern_结构型模式.md\":\"4d1da701\",\"design-pattern_行为型模式.md\":\"038f90ae\",\"design-pattern_阅读资料.md\":\"88b3cb74\",\"index.md\":\"ccbcb43a\",\"javascript_typescript.md\":\"782741fb\",\"javascript_co库.md\":\"47d7240d\",\"javascript_es6.md\":\"eaa4bc92\",\"javascript_index.md\":\"e6f12402\",\"javascript_js方法实现.md\":\"baa3a772\",\"javascript_js继承.md\":\"e43bdff4\",\"javascript_事件循环机制.md\":\"afaca2ed\",\"javascript_函数式编程.md\":\"930b9962\",\"javascript_手写promise.md\":\"93cea2fc\",\"leetcode_1-20.md\":\"c2f7f6e6\",\"leetcode_21-40.md\":\"1b0dc38e\",\"leetcode_index.md\":\"4b208a09\",\"leetcode_leetcode.md\":\"b6985035\",\"linux_bash.md\":\"40d3e353\",\"linux_index.md\":\"7832d7d4\",\"linux_ssh.md\":\"c457bf19\",\"linux_vim.md\":\"bc7d4466\",\"network_index.md\":\"c591ab7b\",\"network_应用层.md\":\"c17db2b8\",\"network_缓存.md\":\"950cad76\",\"network_运输层.md\":\"533e9fec\",\"node_compose.md\":\"fbd3527d\",\"node_index.md\":\"aac9656c\",\"node_手写简版express.md\":\"5c8ea557\",\"node_资料.md\":\"876c37c2\",\"node_进程与线程.md\":\"b8a4bf4e\",\"project_css-background-img.md\":\"5edf88dd\",\"project_css-hack.md\":\"6ad8bfba\",\"project_css-media.md\":\"55c6b82a\",\"project_drawer.md\":\"3aa0f4a3\",\"project_index.md\":\"3ed921d2\",\"project_space.md\":\"59f585b0\",\"react_fiber.md\":\"26448515\",\"react_lanes模型.md\":\"2877b272\",\"react_suspense实现.md\":\"b7d0f5f9\",\"react_updatequeue.md\":\"9c6a1822\",\"react_beginwork-fiber创建.md\":\"c9160c57\",\"react_beginwork-fiber更新.md\":\"020540d9\",\"react_commitwork.md\":\"30eb82f6\",\"react_completework.md\":\"b9bc1a34\",\"react_hooks实现.md\":\"d78175f2\",\"react_index.md\":\"176bdd2f\",\"react_react源码调试-next.md\":\"c69bcb53\",\"react_react源码调试.md\":\"a69db803\",\"react_react源码起始篇.md\":\"c502ee95\",\"react_react热更新实现原理.md\":\"5706b12f\",\"react_tmp.md\":\"41f62a6b\",\"react_事件系统.md\":\"9bd35585\",\"react_任务调度.md\":\"1b8f995e\",\"react_学习计划.md\":\"808c8c42\",\"react_手写简版react-redux.md\":\"31c6d174\",\"react_手写简版redux.md\":\"039cde69\",\"react_浏览器一帧里做了什么.md\":\"280ab221\",\"react_渲染.md\":\"323024bf\",\"react_阅读资料.md\":\"1af4ce52\",\"resources_index.md\":\"633b5de9\",\"resources_js.md\":\"23a8694d\",\"resources_前端博客.md\":\"29d7108b\",\"resources_小程序.md\":\"0d20ccc4\",\"resources_算法.md\":\"c130d5dc\",\"resources_网络协议.md\":\"7e253715\",\"rollup_plugin.md\":\"4f00e1f3\",\"rollup_scopehoist.md\":\"c3ce7363\",\"rollup_splitcode.md\":\"d25e9d50\",\"rollup_treeshaking.md\":\"06061acf\",\"rollup_index.md\":\"7cad7e50\",\"rollup_todo.md\":\"f2ad5469\",\"rollup_源码调试.md\":\"3849dc76\",\"static_index.md\":\"7e41aacf\",\"tools_github-workflow.md\":\"c2f0be6c\",\"tools_img-library.md\":\"2e7df031\",\"tools_index.md\":\"239da11b\",\"tools_iterm2-ohmyzsh.md\":\"ca672cc2\",\"tools_jinkins.md\":\"edaaa065\",\"tools_software.md\":\"bab84f7f\",\"trend_bundleless.md\":\"3f970d8e\",\"trend_index.md\":\"ba2352c2\",\"trend_jiti.md\":\"098c53d5\",\"typescript_index.md\":\"061cfd5b\",\"typescript_utility-types.md\":\"6ca9f96b\",\"vite_index.md\":\"63ee344e\",\"vite_源码调试.md\":\"cd7cd6a8\",\"vue_index.md\":\"05b1d218\",\"vue_一些原理汇总.md\":\"61dea610\",\"vue_响应式原理上篇.md\":\"012bc637\",\"vue_响应式原理下篇.md\":\"3a5fed4c\",\"vue_响应式原理中篇.md\":\"91b9fc8e\",\"vue_手写简版vuerouter.md\":\"8126a617\",\"vue_手写简版vuex.md\":\"fbe76733\",\"vue_插槽实现原理.md\":\"3cb29f34\",\"vue_最长递增子序列.md\":\"34e0fd02\",\"vue_组件实现原理.md\":\"38dfa62b\",\"vue_组成与设计.md\":\"e19f4794\",\"vue_编译原理上篇.md\":\"01172efa\",\"vue_编译原理下篇.md\":\"7364ef5e\",\"vue_编译原理中篇.md\":\"871bb83d\",\"vue_选项合并.md\":\"0a1e1378\",\"vue_阅读资料.md\":\"1c0a329e\",\"vue3_index.md\":\"76fa0061\",\"vue3_源码调试.md\":\"7c2038d8\",\"webpack_splitchunksplugin.md\":\"e25e2fff\",\"webpack_tapable.md\":\"bac3f770\",\"webpack_treeshaking原理.md\":\"50bc4950\",\"webpack_addmodule.md\":\"e4f24747\",\"webpack_buildmodule.md\":\"e8f8320f\",\"webpack_emit阶段.md\":\"8e7835ef\",\"webpack_factorizemodule.md\":\"68741afb\",\"webpack_import.md\":\"f1a4792e\",\"webpack_index.md\":\"5f8fed28\",\"webpack_make阶段.md\":\"fde044d7\",\"webpack_seal阶段.md\":\"b9816651\",\"webpack_vue-loader实现.md\":\"f9ade47b\",\"webpack_watch实现.md\":\"05961452\",\"webpack_webpack优化.md\":\"f49735ed\",\"webpack_webpack官方文档.md\":\"aa9ee1f4\",\"webpack_webpack源码调试.md\":\"060d784b\",\"webpack_官方文档.md\":\"8887dca3\",\"webpack_流程开始.md\":\"e6338b09\",\"webpack_热更新实现原理.md\":\"bfd2e8bb\"}")</script>
    <script type="module" async src="/assets/app.943409a9.js"></script>
    
  </body>
</html>