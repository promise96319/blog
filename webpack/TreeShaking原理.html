<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Tree Shaking 原理 | 秦光辉</title>
    <meta name="description" content="专注于前端开发，关注新技术，坚持学习。">
    <link rel="stylesheet" href="/assets/style.9d0d35a4.css">
    <link rel="modulepreload" href="/assets/app.d322b2e6.js">
    <link rel="modulepreload" href="/assets/webpack_TreeShaking原理.md.eb384a45.lean.js">
    
    <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no, minimal-ui">
  <script>var _hmt=_hmt||[];(function(){var e=document.createElement("script");e.src="https://hm.baidu.com/hm.js?41a9a03811977ee15c69366a880d1296";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)})();</script>
  <meta name="twitter:title" content="Tree Shaking 原理 | 秦光辉">
  <meta property="og:title" content="Tree Shaking 原理 | 秦光辉">
  </head>
  <body>
    <div id="app"><!--[--><div class="theme"><header class="nav-bar" data-v-675d8756><div class="sidebar-button" data-v-675d8756><svg class="icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z" class></path></svg></div><a class="nav-bar-title" href="/" aria-label="秦光辉, back to home" data-v-675d8756 data-v-cc01ef16><img class="logo" src="/logo.png" alt="Logo" data-v-cc01ef16> 秦光辉</a><div class="flex-grow" data-v-675d8756></div><div class="nav" data-v-675d8756><nav class="nav-links" data-v-675d8756 data-v-eab3edfe><!--[--><div class="item" data-v-eab3edfe><div class="nav-link" data-v-eab3edfe data-v-b8818f8c><a class="item" href="/daily/index" data-v-b8818f8c>日常 <!----></a></div></div><div class="item" data-v-eab3edfe><div class="nav-link" data-v-eab3edfe data-v-b8818f8c><a class="item" href="/articles/index" data-v-b8818f8c>文章 <!----></a></div></div><div class="item" data-v-eab3edfe><div class="nav-dropdown-link" data-v-eab3edfe data-v-56bf3a3f><button class="button" data-v-56bf3a3f><span class="button-text" data-v-56bf3a3f>前端框架</span><span class="right button-arrow" data-v-56bf3a3f></span></button><ul class="dialog" data-v-56bf3a3f><!--[--><li class="dialog-item" data-v-56bf3a3f><div class="nav-dropdown-link-item" data-v-56bf3a3f data-v-bbc27490><a class="item" href="/vue/" data-v-bbc27490><span class="arrow" data-v-bbc27490></span><span class="text" data-v-bbc27490>Vue v2 源码解析</span><span class="icon" data-v-bbc27490><!----></span></a></div></li><li class="dialog-item" data-v-56bf3a3f><div class="nav-dropdown-link-item" data-v-56bf3a3f data-v-bbc27490><a class="item" href="/vue3/" data-v-bbc27490><span class="arrow" data-v-bbc27490></span><span class="text" data-v-bbc27490>Vue v3 源码</span><span class="icon" data-v-bbc27490><!----></span></a></div></li><li class="dialog-item" data-v-56bf3a3f><div class="nav-dropdown-link-item" data-v-56bf3a3f data-v-bbc27490><a class="item" href="/react/" data-v-bbc27490><span class="arrow" data-v-bbc27490></span><span class="text" data-v-bbc27490>React v17 源码</span><span class="icon" data-v-bbc27490><!----></span></a></div></li><!--]--></ul></div></div><div class="item" data-v-eab3edfe><div class="nav-dropdown-link" data-v-eab3edfe data-v-56bf3a3f><button class="button" data-v-56bf3a3f><span class="button-text" data-v-56bf3a3f>构建工具</span><span class="right button-arrow" data-v-56bf3a3f></span></button><ul class="dialog" data-v-56bf3a3f><!--[--><li class="dialog-item" data-v-56bf3a3f><div class="nav-dropdown-link-item" data-v-56bf3a3f data-v-bbc27490><a class="item active" href="/webpack/" data-v-bbc27490><span class="arrow" data-v-bbc27490></span><span class="text" data-v-bbc27490>Webpack</span><span class="icon" data-v-bbc27490><!----></span></a></div></li><li class="dialog-item" data-v-56bf3a3f><div class="nav-dropdown-link-item" data-v-56bf3a3f data-v-bbc27490><a class="item" href="/rollup/" data-v-bbc27490><span class="arrow" data-v-bbc27490></span><span class="text" data-v-bbc27490>Rollup</span><span class="icon" data-v-bbc27490><!----></span></a></div></li><li class="dialog-item" data-v-56bf3a3f><div class="nav-dropdown-link-item" data-v-56bf3a3f data-v-bbc27490><a class="item" href="/vite/" data-v-bbc27490><span class="arrow" data-v-bbc27490></span><span class="text" data-v-bbc27490>Vite</span><span class="icon" data-v-bbc27490><!----></span></a></div></li><li class="dialog-item" data-v-56bf3a3f><div class="nav-dropdown-link-item" data-v-56bf3a3f data-v-bbc27490><a class="item" href="/babel/" data-v-bbc27490><span class="arrow" data-v-bbc27490></span><span class="text" data-v-bbc27490>Babel</span><span class="icon" data-v-bbc27490><!----></span></a></div></li><!--]--></ul></div></div><div class="item" data-v-eab3edfe><div class="nav-dropdown-link" data-v-eab3edfe data-v-56bf3a3f><button class="button" data-v-56bf3a3f><span class="button-text" data-v-56bf3a3f>js</span><span class="right button-arrow" data-v-56bf3a3f></span></button><ul class="dialog" data-v-56bf3a3f><!--[--><li class="dialog-item" data-v-56bf3a3f><div class="nav-dropdown-link-item" data-v-56bf3a3f data-v-bbc27490><a class="item" href="/javascript/" data-v-bbc27490><span class="arrow" data-v-bbc27490></span><span class="text" data-v-bbc27490>ES6</span><span class="icon" data-v-bbc27490><!----></span></a></div></li><li class="dialog-item" data-v-56bf3a3f><div class="nav-dropdown-link-item" data-v-56bf3a3f data-v-bbc27490><a class="item" href="/node/" data-v-bbc27490><span class="arrow" data-v-bbc27490></span><span class="text" data-v-bbc27490>Node</span><span class="icon" data-v-bbc27490><!----></span></a></div></li><li class="dialog-item" data-v-56bf3a3f><div class="nav-dropdown-link-item" data-v-56bf3a3f data-v-bbc27490><a class="item" href="/typescript/" data-v-bbc27490><span class="arrow" data-v-bbc27490></span><span class="text" data-v-bbc27490>Typescript</span><span class="icon" data-v-bbc27490><!----></span></a></div></li><!--]--></ul></div></div><div class="item" data-v-eab3edfe><div class="nav-dropdown-link" data-v-eab3edfe data-v-56bf3a3f><button class="button" data-v-56bf3a3f><span class="button-text" data-v-56bf3a3f>基础</span><span class="right button-arrow" data-v-56bf3a3f></span></button><ul class="dialog" data-v-56bf3a3f><!--[--><li class="dialog-item" data-v-56bf3a3f><div class="nav-dropdown-link-item" data-v-56bf3a3f data-v-bbc27490><a class="item" href="/algorithms/" data-v-bbc27490><span class="arrow" data-v-bbc27490></span><span class="text" data-v-bbc27490>算法</span><span class="icon" data-v-bbc27490><!----></span></a></div></li><li class="dialog-item" data-v-56bf3a3f><div class="nav-dropdown-link-item" data-v-56bf3a3f data-v-bbc27490><a class="item" href="/data-structures/" data-v-bbc27490><span class="arrow" data-v-bbc27490></span><span class="text" data-v-bbc27490>数据结构</span><span class="icon" data-v-bbc27490><!----></span></a></div></li><li class="dialog-item" data-v-56bf3a3f><div class="nav-dropdown-link-item" data-v-56bf3a3f data-v-bbc27490><a class="item" href="/design-pattern/" data-v-bbc27490><span class="arrow" data-v-bbc27490></span><span class="text" data-v-bbc27490>设计模式</span><span class="icon" data-v-bbc27490><!----></span></a></div></li><li class="dialog-item" data-v-56bf3a3f><div class="nav-dropdown-link-item" data-v-56bf3a3f data-v-bbc27490><a class="item" href="/leetcode/" data-v-bbc27490><span class="arrow" data-v-bbc27490></span><span class="text" data-v-bbc27490>LeetCode</span><span class="icon" data-v-bbc27490><!----></span></a></div></li><li class="dialog-item" data-v-56bf3a3f><div class="nav-dropdown-link-item" data-v-56bf3a3f data-v-bbc27490><a class="item" href="/network/" data-v-bbc27490><span class="arrow" data-v-bbc27490></span><span class="text" data-v-bbc27490>网络</span><span class="icon" data-v-bbc27490><!----></span></a></div></li><li class="dialog-item" data-v-56bf3a3f><div class="nav-dropdown-link-item" data-v-56bf3a3f data-v-bbc27490><a class="item" href="/linux/" data-v-bbc27490><span class="arrow" data-v-bbc27490></span><span class="text" data-v-bbc27490>linux</span><span class="icon" data-v-bbc27490><!----></span></a></div></li><!--]--></ul></div></div><div class="item" data-v-eab3edfe><div class="nav-dropdown-link" data-v-eab3edfe data-v-56bf3a3f><button class="button" data-v-56bf3a3f><span class="button-text" data-v-56bf3a3f>资源</span><span class="right button-arrow" data-v-56bf3a3f></span></button><ul class="dialog" data-v-56bf3a3f><!--[--><li class="dialog-item" data-v-56bf3a3f><div class="nav-dropdown-link-item" data-v-56bf3a3f data-v-bbc27490><a class="item" href="/tools/" data-v-bbc27490><span class="arrow" data-v-bbc27490></span><span class="text" data-v-bbc27490>工具</span><span class="icon" data-v-bbc27490><!----></span></a></div></li><li class="dialog-item" data-v-56bf3a3f><div class="nav-dropdown-link-item" data-v-56bf3a3f data-v-bbc27490><a class="item" href="/resources/" data-v-bbc27490><span class="arrow" data-v-bbc27490></span><span class="text" data-v-bbc27490>资料</span><span class="icon" data-v-bbc27490><!----></span></a></div></li><!--]--></ul></div></div><div class="item" data-v-eab3edfe><div class="nav-link" data-v-eab3edfe data-v-b8818f8c><a class="item" href="/project/" data-v-b8818f8c>项目 <!----></a></div></div><!--]--><!----><div class="item" data-v-eab3edfe><div class="nav-link" data-v-eab3edfe data-v-b8818f8c><a class="item isExternal" href="https://github.com/promise96319" target="_blank" rel="noopener noreferrer" data-v-b8818f8c>GitHub <svg class="icon outbound" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15" data-v-b8818f8c><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div></div></nav></div><!--[--><!--]--></header><aside class="sidebar" data-v-83e92a68><nav class="nav-links nav" data-v-83e92a68 data-v-eab3edfe><!--[--><div class="item" data-v-eab3edfe><div class="nav-link" data-v-eab3edfe data-v-b8818f8c><a class="item" href="/daily/index" data-v-b8818f8c>日常 <!----></a></div></div><div class="item" data-v-eab3edfe><div class="nav-link" data-v-eab3edfe data-v-b8818f8c><a class="item" href="/articles/index" data-v-b8818f8c>文章 <!----></a></div></div><div class="item" data-v-eab3edfe><div class="nav-dropdown-link" data-v-eab3edfe data-v-56bf3a3f><button class="button" data-v-56bf3a3f><span class="button-text" data-v-56bf3a3f>前端框架</span><span class="right button-arrow" data-v-56bf3a3f></span></button><ul class="dialog" data-v-56bf3a3f><!--[--><li class="dialog-item" data-v-56bf3a3f><div class="nav-dropdown-link-item" data-v-56bf3a3f data-v-bbc27490><a class="item" href="/vue/" data-v-bbc27490><span class="arrow" data-v-bbc27490></span><span class="text" data-v-bbc27490>Vue v2 源码解析</span><span class="icon" data-v-bbc27490><!----></span></a></div></li><li class="dialog-item" data-v-56bf3a3f><div class="nav-dropdown-link-item" data-v-56bf3a3f data-v-bbc27490><a class="item" href="/vue3/" data-v-bbc27490><span class="arrow" data-v-bbc27490></span><span class="text" data-v-bbc27490>Vue v3 源码</span><span class="icon" data-v-bbc27490><!----></span></a></div></li><li class="dialog-item" data-v-56bf3a3f><div class="nav-dropdown-link-item" data-v-56bf3a3f data-v-bbc27490><a class="item" href="/react/" data-v-bbc27490><span class="arrow" data-v-bbc27490></span><span class="text" data-v-bbc27490>React v17 源码</span><span class="icon" data-v-bbc27490><!----></span></a></div></li><!--]--></ul></div></div><div class="item" data-v-eab3edfe><div class="nav-dropdown-link" data-v-eab3edfe data-v-56bf3a3f><button class="button" data-v-56bf3a3f><span class="button-text" data-v-56bf3a3f>构建工具</span><span class="right button-arrow" data-v-56bf3a3f></span></button><ul class="dialog" data-v-56bf3a3f><!--[--><li class="dialog-item" data-v-56bf3a3f><div class="nav-dropdown-link-item" data-v-56bf3a3f data-v-bbc27490><a class="item active" href="/webpack/" data-v-bbc27490><span class="arrow" data-v-bbc27490></span><span class="text" data-v-bbc27490>Webpack</span><span class="icon" data-v-bbc27490><!----></span></a></div></li><li class="dialog-item" data-v-56bf3a3f><div class="nav-dropdown-link-item" data-v-56bf3a3f data-v-bbc27490><a class="item" href="/rollup/" data-v-bbc27490><span class="arrow" data-v-bbc27490></span><span class="text" data-v-bbc27490>Rollup</span><span class="icon" data-v-bbc27490><!----></span></a></div></li><li class="dialog-item" data-v-56bf3a3f><div class="nav-dropdown-link-item" data-v-56bf3a3f data-v-bbc27490><a class="item" href="/vite/" data-v-bbc27490><span class="arrow" data-v-bbc27490></span><span class="text" data-v-bbc27490>Vite</span><span class="icon" data-v-bbc27490><!----></span></a></div></li><li class="dialog-item" data-v-56bf3a3f><div class="nav-dropdown-link-item" data-v-56bf3a3f data-v-bbc27490><a class="item" href="/babel/" data-v-bbc27490><span class="arrow" data-v-bbc27490></span><span class="text" data-v-bbc27490>Babel</span><span class="icon" data-v-bbc27490><!----></span></a></div></li><!--]--></ul></div></div><div class="item" data-v-eab3edfe><div class="nav-dropdown-link" data-v-eab3edfe data-v-56bf3a3f><button class="button" data-v-56bf3a3f><span class="button-text" data-v-56bf3a3f>js</span><span class="right button-arrow" data-v-56bf3a3f></span></button><ul class="dialog" data-v-56bf3a3f><!--[--><li class="dialog-item" data-v-56bf3a3f><div class="nav-dropdown-link-item" data-v-56bf3a3f data-v-bbc27490><a class="item" href="/javascript/" data-v-bbc27490><span class="arrow" data-v-bbc27490></span><span class="text" data-v-bbc27490>ES6</span><span class="icon" data-v-bbc27490><!----></span></a></div></li><li class="dialog-item" data-v-56bf3a3f><div class="nav-dropdown-link-item" data-v-56bf3a3f data-v-bbc27490><a class="item" href="/node/" data-v-bbc27490><span class="arrow" data-v-bbc27490></span><span class="text" data-v-bbc27490>Node</span><span class="icon" data-v-bbc27490><!----></span></a></div></li><li class="dialog-item" data-v-56bf3a3f><div class="nav-dropdown-link-item" data-v-56bf3a3f data-v-bbc27490><a class="item" href="/typescript/" data-v-bbc27490><span class="arrow" data-v-bbc27490></span><span class="text" data-v-bbc27490>Typescript</span><span class="icon" data-v-bbc27490><!----></span></a></div></li><!--]--></ul></div></div><div class="item" data-v-eab3edfe><div class="nav-dropdown-link" data-v-eab3edfe data-v-56bf3a3f><button class="button" data-v-56bf3a3f><span class="button-text" data-v-56bf3a3f>基础</span><span class="right button-arrow" data-v-56bf3a3f></span></button><ul class="dialog" data-v-56bf3a3f><!--[--><li class="dialog-item" data-v-56bf3a3f><div class="nav-dropdown-link-item" data-v-56bf3a3f data-v-bbc27490><a class="item" href="/algorithms/" data-v-bbc27490><span class="arrow" data-v-bbc27490></span><span class="text" data-v-bbc27490>算法</span><span class="icon" data-v-bbc27490><!----></span></a></div></li><li class="dialog-item" data-v-56bf3a3f><div class="nav-dropdown-link-item" data-v-56bf3a3f data-v-bbc27490><a class="item" href="/data-structures/" data-v-bbc27490><span class="arrow" data-v-bbc27490></span><span class="text" data-v-bbc27490>数据结构</span><span class="icon" data-v-bbc27490><!----></span></a></div></li><li class="dialog-item" data-v-56bf3a3f><div class="nav-dropdown-link-item" data-v-56bf3a3f data-v-bbc27490><a class="item" href="/design-pattern/" data-v-bbc27490><span class="arrow" data-v-bbc27490></span><span class="text" data-v-bbc27490>设计模式</span><span class="icon" data-v-bbc27490><!----></span></a></div></li><li class="dialog-item" data-v-56bf3a3f><div class="nav-dropdown-link-item" data-v-56bf3a3f data-v-bbc27490><a class="item" href="/leetcode/" data-v-bbc27490><span class="arrow" data-v-bbc27490></span><span class="text" data-v-bbc27490>LeetCode</span><span class="icon" data-v-bbc27490><!----></span></a></div></li><li class="dialog-item" data-v-56bf3a3f><div class="nav-dropdown-link-item" data-v-56bf3a3f data-v-bbc27490><a class="item" href="/network/" data-v-bbc27490><span class="arrow" data-v-bbc27490></span><span class="text" data-v-bbc27490>网络</span><span class="icon" data-v-bbc27490><!----></span></a></div></li><li class="dialog-item" data-v-56bf3a3f><div class="nav-dropdown-link-item" data-v-56bf3a3f data-v-bbc27490><a class="item" href="/linux/" data-v-bbc27490><span class="arrow" data-v-bbc27490></span><span class="text" data-v-bbc27490>linux</span><span class="icon" data-v-bbc27490><!----></span></a></div></li><!--]--></ul></div></div><div class="item" data-v-eab3edfe><div class="nav-dropdown-link" data-v-eab3edfe data-v-56bf3a3f><button class="button" data-v-56bf3a3f><span class="button-text" data-v-56bf3a3f>资源</span><span class="right button-arrow" data-v-56bf3a3f></span></button><ul class="dialog" data-v-56bf3a3f><!--[--><li class="dialog-item" data-v-56bf3a3f><div class="nav-dropdown-link-item" data-v-56bf3a3f data-v-bbc27490><a class="item" href="/tools/" data-v-bbc27490><span class="arrow" data-v-bbc27490></span><span class="text" data-v-bbc27490>工具</span><span class="icon" data-v-bbc27490><!----></span></a></div></li><li class="dialog-item" data-v-56bf3a3f><div class="nav-dropdown-link-item" data-v-56bf3a3f data-v-bbc27490><a class="item" href="/resources/" data-v-bbc27490><span class="arrow" data-v-bbc27490></span><span class="text" data-v-bbc27490>资料</span><span class="icon" data-v-bbc27490><!----></span></a></div></li><!--]--></ul></div></div><div class="item" data-v-eab3edfe><div class="nav-link" data-v-eab3edfe data-v-b8818f8c><a class="item" href="/project/" data-v-b8818f8c>项目 <!----></a></div></div><!--]--><!----><div class="item" data-v-eab3edfe><div class="nav-link" data-v-eab3edfe data-v-b8818f8c><a class="item isExternal" href="https://github.com/promise96319" target="_blank" rel="noopener noreferrer" data-v-b8818f8c>GitHub <svg class="icon outbound" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15" data-v-b8818f8c><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div></div></nav><!--[--><!--]--><ul class="sidebar-links" data-v-83e92a68><!--[--><li class="sidebar-link"><a class="sidebar-link-item" href="/webpack/index">原理</a><ul class="sidebar-links"><li class="sidebar-link"><a class="sidebar-link-item" href="/webpack/webpack源码调试">webpack源码调试</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="/webpack/流程开始">流程开始</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="/webpack/make阶段">make阶段</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="/webpack/factorizeModule">factorizeModule</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="/webpack/addModule">addModule</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="/webpack/buildModule">buildModule</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="/webpack/seal阶段">seal阶段</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="/webpack/emit阶段">emit阶段</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="/webpack/import">import</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item active" href="/webpack/TreeShaking原理">TreeShaking原理</a><ul class="sidebar-links"><li class="sidebar-link"><a class="sidebar-link-item" href="#使用">使用</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="#初始化">初始化</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="#export解析为dependency">export解析为Dependency</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="#flagdependencyexportsplugin分析exportsinfo">FlagDependencyExportsPlugin分析exportsInfo</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="#flagdependencyusageplugin标记使用">FlagDependencyUsagePlugin标记使用</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="#导入了但是未被使用怎么办？">导入了但是未被使用怎么办？</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="#去除没有使用的export">去除没有使用的export</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="#terser-webpack-plugin">terser-webpack-plugin</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="#总结">总结</a><!----></li></ul></li><li class="sidebar-link"><a class="sidebar-link-item" href="/webpack/SplitChunksPlugin">SplitChunksPlugin</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="/webpack/watch实现">watch实现</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="/webpack/vue-loader实现">vue-loader实现</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="/webpack/热更新实现原理">热更新实现原理</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="/webpack/Tapable">Tapable</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="/webpack/webpack优化">webpack优化</a><!----></li><li class="sidebar-link"><a class="sidebar-link-item" href="/webpack/webpack官方文档">webpack官方文档</a><!----></li></ul></li><!--]--></ul><!--[--><!--]--></aside><div class="sidebar-mask"></div><main class="page" data-v-7eddb2c4><div class="container" data-v-7eddb2c4><!--[--><!--]--><div style="position:relative;" class="content" data-v-7eddb2c4><div><h1 id="tree-shaking-原理" tabindex="-1">Tree Shaking 原理 <a class="header-anchor" href="#tree-shaking-原理" aria-hidden="true">#</a></h1><h2 id="使用" tabindex="-1">使用 <a class="header-anchor" href="#使用" aria-hidden="true">#</a></h2><p>在 Webpack 中，启动 Tree Shaking 功能必须同时满足三个条件：</p><ul><li>使用 ESM 规范编写模块代码。</li><li>配置 optimization.usedExports 为 true，启动标记功能。（默认为true）</li><li>启动代码优化功能，可以通过如下方式实现： <ul><li>配置 mode = production</li><li>配置 optimization.minimize = true（默认为true）</li><li>提供 optimization.minimizer 数组</li></ul></li></ul><h2 id="初始化" tabindex="-1">初始化 <a class="header-anchor" href="#初始化" aria-hidden="true">#</a></h2><p><code>applyWebpackOptionsDefaults</code>中调用<code>applyOptimizationDefaults</code>方法，设置两个变量：</p><div class="language-javascript"><pre><code><span class="token constant">D</span><span class="token punctuation">(</span>optimization<span class="token punctuation">,</span> <span class="token string">&quot;providedExports&quot;</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token constant">D</span><span class="token punctuation">(</span>optimization<span class="token punctuation">,</span> <span class="token string">&quot;usedExports&quot;</span><span class="token punctuation">,</span> production<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>紧接着<code>WebpackOptionsApply</code>中根据这两个变量应用两个插件：</p><div class="language-javascript"><pre><code><span class="token keyword">if</span> <span class="token punctuation">(</span>options<span class="token punctuation">.</span>optimization<span class="token punctuation">.</span>providedExports<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> FlagDependencyExportsPlugin <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;./FlagDependencyExportsPlugin&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">new</span> <span class="token class-name">FlagDependencyExportsPlugin</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span>compiler<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>options<span class="token punctuation">.</span>optimization<span class="token punctuation">.</span>usedExports<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> FlagDependencyUsagePlugin <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;./FlagDependencyUsagePlugin&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">new</span> <span class="token class-name">FlagDependencyUsagePlugin</span><span class="token punctuation">(</span>
    options<span class="token punctuation">.</span>optimization<span class="token punctuation">.</span>usedExports <span class="token operator">===</span> <span class="token string">&quot;global&quot;</span>
  <span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">apply</span><span class="token punctuation">(</span>compiler<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="export解析为dependency" tabindex="-1">export解析为Dependency <a class="header-anchor" href="#export解析为dependency" aria-hidden="true">#</a></h2><p>通常来讲导出分为三种情况：</p><ul><li>具名导出<code>export const a = 1</code></li><li>默认导出<code>export default const b = 2</code></li><li>全部导出<code>export * from &#39;./xxx.js&#39;</code></li></ul><p>在<code>make</code>阶段对源码进行编译得到<code>ast</code>时，会对以上三种情况进行分析：</p><div class="language-javascript"><pre><code><span class="token function">blockPreWalkStatement</span><span class="token punctuation">(</span><span class="token parameter">statement</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// ...</span>
  <span class="token keyword">switch</span> <span class="token punctuation">(</span>statement<span class="token punctuation">.</span>type<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">case</span> <span class="token string">&quot;ExportAllDeclaration&quot;</span><span class="token operator">:</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">blockPreWalkExportAllDeclaration</span><span class="token punctuation">(</span>statement<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token keyword">case</span> <span class="token string">&quot;ExportDefaultDeclaration&quot;</span><span class="token operator">:</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">blockPreWalkExportDefaultDeclaration</span><span class="token punctuation">(</span>statement<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">break</span><span class="token punctuation">;</span>
    <span class="token keyword">case</span> <span class="token string">&quot;ExportNamedDeclaration&quot;</span><span class="token operator">:</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">blockPreWalkExportNamedDeclaration</span><span class="token punctuation">(</span>statement<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">break</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>最终触发<code>HarmonyExportDependencyParserPlugin</code>插件对应的钩子形成三种不同的<code>dependency</code>，精简代码如下：</p><div class="language-javascript"><pre><code>parser<span class="token punctuation">.</span>hooks<span class="token punctuation">.</span>exportExpression<span class="token punctuation">.</span><span class="token function">tap</span><span class="token punctuation">(</span>
  <span class="token string">&quot;HarmonyExportDependencyParserPlugin&quot;</span><span class="token punctuation">,</span>
  <span class="token punctuation">(</span><span class="token parameter">statement<span class="token punctuation">,</span> expr</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> dep <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HarmonyExportExpressionDependency</span><span class="token punctuation">(</span>）
    parser<span class="token punctuation">.</span>state<span class="token punctuation">.</span>current<span class="token punctuation">.</span><span class="token function">addDependency</span><span class="token punctuation">(</span>dep<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
parser<span class="token punctuation">.</span>hooks<span class="token punctuation">.</span>exportSpecifier<span class="token punctuation">.</span><span class="token function">tap</span><span class="token punctuation">(</span>
  <span class="token string">&quot;HarmonyExportDependencyParserPlugin&quot;</span><span class="token punctuation">,</span>
  <span class="token punctuation">(</span><span class="token parameter">statement<span class="token punctuation">,</span> id<span class="token punctuation">,</span> name<span class="token punctuation">,</span> idx</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>settings<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      dep <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HarmonyExportImportedSpecifierDependency</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      dep <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HarmonyExportSpecifierDependency</span><span class="token punctuation">(</span>id<span class="token punctuation">,</span> name<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    parser<span class="token punctuation">.</span>state<span class="token punctuation">.</span>current<span class="token punctuation">.</span><span class="token function">addDependency</span><span class="token punctuation">(</span>dep<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
parser<span class="token punctuation">.</span>hooks<span class="token punctuation">.</span>exportImportSpecifier<span class="token punctuation">.</span><span class="token function">tap</span><span class="token punctuation">(</span>
  <span class="token string">&quot;HarmonyExportDependencyParserPlugin&quot;</span><span class="token punctuation">,</span>
  <span class="token punctuation">(</span><span class="token parameter">statement<span class="token punctuation">,</span> source<span class="token punctuation">,</span> id<span class="token punctuation">,</span> name<span class="token punctuation">,</span> idx</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> dep <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HarmonyExportImportedSpecifierDependency</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    parser<span class="token punctuation">.</span>state<span class="token punctuation">.</span>current<span class="token punctuation">.</span><span class="token function">addDependency</span><span class="token punctuation">(</span>dep<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h2 id="flagdependencyexportsplugin分析exportsinfo" tabindex="-1">FlagDependencyExportsPlugin分析exportsInfo <a class="header-anchor" href="#flagdependencyexportsplugin分析exportsinfo" aria-hidden="true">#</a></h2><p><code>FlagDependencyExportsPlugin</code>插件在<code>compilation</code>实例化时监听了<code>hooks.finishModules</code>钩子：</p><div class="language-javascript"><pre><code>compiler<span class="token punctuation">.</span>hooks<span class="token punctuation">.</span>compilation<span class="token punctuation">.</span><span class="token function">tap</span><span class="token punctuation">(</span>
  <span class="token string">&quot;FlagDependencyExportsPlugin&quot;</span><span class="token punctuation">,</span>
  <span class="token parameter">compilation</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    compilation<span class="token punctuation">.</span>hooks<span class="token punctuation">.</span>finishModules<span class="token punctuation">.</span><span class="token function">tapAsync</span><span class="token punctuation">(</span>
      <span class="token string">&quot;FlagDependencyExportsPlugin&quot;</span><span class="token punctuation">,</span>
      <span class="token punctuation">(</span><span class="token parameter">modules<span class="token punctuation">,</span> callback</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
    <span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">)</span>
</code></pre></div><p>也就是说在<code>make</code>阶段当所有<code>modules</code>都<code>build</code>完毕后会触发该插件的回调函数。此时会遍历所有<code>module</code>，并分析他们有哪些导出项，其核心代码如下：</p><div class="language-javascript"><pre><code><span class="token keyword">while</span> <span class="token punctuation">(</span>queue<span class="token punctuation">.</span>length <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  module <span class="token operator">=</span> queue<span class="token punctuation">.</span><span class="token function">dequeue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  exportsInfo <span class="token operator">=</span> moduleGraph<span class="token punctuation">.</span><span class="token function">getExportsInfo</span><span class="token punctuation">(</span>module<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token function">processDependenciesBlock</span><span class="token punctuation">(</span>module<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token punctuation">[</span>
    dep<span class="token punctuation">,</span>
    exportsSpec
  <span class="token punctuation">]</span> <span class="token keyword">of</span> exportsSpecsFromDependencies<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">processExportsSpec</span><span class="token punctuation">(</span>dep<span class="token punctuation">,</span> exportsSpec<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>首先会获取<code>module</code>的<code>exportsInfo</code>，该变量会记录该模块所有的导出信息。</p><p>其次会调用<code>processDependenciesBlock</code>，该方法会遍历<code>dependencies</code>并调用<code>processDependency</code>方法：</p><div class="language-javascript"><pre><code><span class="token keyword">const</span> <span class="token function-variable function">processDependency</span> <span class="token operator">=</span> <span class="token parameter">dep</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> exportDesc <span class="token operator">=</span> dep<span class="token punctuation">.</span><span class="token function">getExports</span><span class="token punctuation">(</span>moduleGraph<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>exportDesc<span class="token punctuation">)</span> <span class="token keyword">return</span><span class="token punctuation">;</span>
  exportsSpecsFromDependencies<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>dep<span class="token punctuation">,</span> exportDesc<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p>通常来讲<code>export</code>相关的<code>dependency</code>，它们的<code>exportDesc</code>是存在的，如：</p><div class="language-javascript"><pre><code><span class="token function">getExports</span><span class="token punctuation">(</span><span class="token parameter">moduleGraph</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">exports</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token keyword">this</span><span class="token punctuation">.</span>name<span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token literal-property property">priority</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
    <span class="token literal-property property">terminalBinding</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    <span class="token literal-property property">dependencies</span><span class="token operator">:</span> <span class="token keyword">undefined</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token function">getExports</span><span class="token punctuation">(</span><span class="token parameter">moduleGraph</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">exports</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&quot;default&quot;</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    <span class="token literal-property property">priority</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
    <span class="token literal-property property">terminalBinding</span><span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
    <span class="token literal-property property">dependencies</span><span class="token operator">:</span> <span class="token keyword">undefined</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>最终会遍历这些具有<code>export</code>内容的<code>dependency</code>，并执行<code>processExportsSpec</code>，精简后的代码如下：</p><div class="language-javascript"><pre><code><span class="token keyword">const</span> <span class="token function-variable function">processExportsSpec</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">dep<span class="token punctuation">,</span> exportDesc</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> exports <span class="token operator">=</span> exportDesc<span class="token punctuation">.</span>exports<span class="token punctuation">;</span>

  <span class="token keyword">const</span> <span class="token function-variable function">mergeExports</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">exportsInfo<span class="token punctuation">,</span> exports</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> exportNameOrSpec <span class="token keyword">of</span> exports<span class="token punctuation">)</span> <span class="token punctuation">{</span>

      name <span class="token operator">=</span> exportNameOrSpec<span class="token punctuation">;</span>

      <span class="token keyword">const</span> exportInfo <span class="token operator">=</span> exportsInfo<span class="token punctuation">.</span><span class="token function">getExportInfo</span><span class="token punctuation">(</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token function">mergeExports</span><span class="token punctuation">(</span>exportsInfo<span class="token punctuation">,</span> exports<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>首先会获取所有导出的变量<code>exports</code>，然后遍历<code>exports</code>，对于每个<code>export</code>变量的<code>name</code>都会调用<code>exportsInfo.getExportInfo(name)</code>建立一个<code>exportInfo</code>：</p><div class="language-javascript"><pre><code><span class="token function">getExportInfo</span><span class="token punctuation">(</span><span class="token parameter">name</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> newInfo <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ExportInfo</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_otherExportsInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>_exports<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> newInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> newInfo<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>这样就在<code>exportsInfo</code>里可以通过<code>_exports</code>属性访问所有的导出变量信息。这里省略了<code>exportInfo</code>信息的一些要素。</p><h2 id="flagdependencyusageplugin标记使用" tabindex="-1">FlagDependencyUsagePlugin标记使用 <a class="header-anchor" href="#flagdependencyusageplugin标记使用" aria-hidden="true">#</a></h2><p>在<code>seal</code>阶段时，已经创建好了所有<code>module</code>，在生成<code>chunk</code>之前会先触发<code>hooks.optimizeDependencies</code>钩子：</p><div class="language-javascript"><pre><code><span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>hooks<span class="token punctuation">.</span><span class="token function">optimizeDependencies</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>modules<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">/* empty */</span>
<span class="token punctuation">}</span>
</code></pre></div><p>此时会调用<code>FlagDependencyUsagePlugin</code>插件的回调，核心代码如下：</p><div class="language-javascript"><pre><code><span class="token comment">// 遍历 entry dependency</span>
<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> dep <span class="token keyword">of</span> deps<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">processEntryDependency</span><span class="token punctuation">(</span>dep<span class="token punctuation">,</span> runtime<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token comment">// 处理完入口后，将遇到的 module 又加入到 queue 中进行处理</span>
<span class="token keyword">while</span> <span class="token punctuation">(</span>queue<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token punctuation">[</span>module<span class="token punctuation">,</span> runtime<span class="token punctuation">]</span> <span class="token operator">=</span> queue<span class="token punctuation">.</span><span class="token function">dequeue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">processModule</span><span class="token punctuation">(</span>module<span class="token punctuation">,</span> runtime<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>从入口开始遍历<code>module</code>，真正的执行者为<code>processModule</code>方法：</p><div class="language-javascript"><pre><code><span class="token keyword">const</span> <span class="token function-variable function">processModule</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">module<span class="token punctuation">,</span> runtime<span class="token punctuation">,</span> forceSideEffects</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> map <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Map</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">const</span> queue <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayQueue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  queue<span class="token punctuation">.</span><span class="token function">enqueue</span><span class="token punctuation">(</span>module<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span><span class="token punctuation">;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> block <span class="token operator">=</span> queue<span class="token punctuation">.</span><span class="token function">dequeue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> dep <span class="token keyword">of</span> block<span class="token punctuation">.</span>dependencies<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> connection <span class="token operator">=</span> moduleGraph<span class="token punctuation">.</span><span class="token function">getConnection</span><span class="token punctuation">(</span>dep<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// 1. 获取 dependency 对应的 module</span>
      <span class="token keyword">const</span> <span class="token punctuation">{</span> module <span class="token punctuation">}</span> <span class="token operator">=</span> connection<span class="token punctuation">;</span>

      <span class="token comment">// 2. 根据当前 dependency 分析引用了哪些变量</span>
      <span class="token keyword">const</span> referencedExports <span class="token operator">=</span>
            compilation<span class="token punctuation">.</span><span class="token function">getDependencyReferencedExports</span><span class="token punctuation">(</span>dep<span class="token punctuation">,</span> runtime<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>
        oldReferencedExports <span class="token operator">===</span> <span class="token keyword">undefined</span> <span class="token operator">||</span>
        oldReferencedExports <span class="token operator">===</span> <span class="token constant">NO_EXPORTS_REFERENCED</span> <span class="token operator">||</span>
        referencedExports <span class="token operator">===</span> <span class="token constant">EXPORTS_OBJECT_REFERENCED</span>
      <span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 3. 形成 map 结构</span>
        map<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>module<span class="token punctuation">,</span> referencedExports<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// ...</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p><code>processModule</code>前半部分代码是遍历<code>module.dependencies</code>。在遇到<code>import</code>相关的<code>dependency</code>时，通过<code>getDependencyReferencedExports</code>方法解析该<code>dependency</code>，获取所有引用到的变量，记做<code>referencedExports</code>，并添加到<code>map</code>中。</p><p>后半段代码则是遍历<code>map</code>，处理<code>import</code>与<code>export</code>之间的联系：</p><div class="language-javascript"><pre><code><span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token punctuation">[</span>module<span class="token punctuation">,</span> referencedExports<span class="token punctuation">]</span> <span class="token keyword">of</span> map<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>Array<span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span>referencedExports<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">processReferencedModule</span><span class="token punctuation">(</span>
      module<span class="token punctuation">,</span>
      referencedExports<span class="token punctuation">,</span>
      runtime<span class="token punctuation">,</span>
      forceSideEffects
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token function">processReferencedModule</span><span class="token punctuation">(</span>
      module<span class="token punctuation">,</span>
      Array<span class="token punctuation">.</span><span class="token function">from</span><span class="token punctuation">(</span>referencedExports<span class="token punctuation">.</span><span class="token function">values</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      runtime<span class="token punctuation">,</span>
      forceSideEffects
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p><code>processReferencedModule</code>传入参数中，<code>module</code>表示<code>dep</code>对应的模块（这里其实指被导入的模块），<code>referencedExports</code>表示当前模块<code>import</code>了哪些变量，为数组形式。<code>processReferencedModule</code>精简代码如下：</p><div class="language-javascript"><pre><code><span class="token keyword">const</span> <span class="token function-variable function">processReferencedModule</span> <span class="token operator">=</span> <span class="token punctuation">(</span>
  <span class="token parameter">module<span class="token punctuation">,</span>
  usedExports<span class="token punctuation">,</span>
  runtime<span class="token punctuation">,</span>
  forceSideEffects</span>
<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// 1. 获取导入模块 的导出信息</span>
  <span class="token keyword">const</span> exportsInfo <span class="token operator">=</span> moduleGraph<span class="token punctuation">.</span><span class="token function">getExportsInfo</span><span class="token punctuation">(</span>module<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>usedExports<span class="token punctuation">.</span>length <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 2. 遍历这个模块被使用到的变量</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> usedExportInfo <span class="token keyword">of</span> usedExports<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      usedExport <span class="token operator">=</span> usedExportInfo<span class="token punctuation">;</span>
      <span class="token keyword">let</span> currentExportsInfo <span class="token operator">=</span> exportsInfo<span class="token punctuation">;</span>
      <span class="token comment">// 3. 遍历这个模块被使用到的变量</span>

      <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">let</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> usedExport<span class="token punctuation">.</span>length<span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 4. 根据引用到的变量，获取到该变量在模块中导出的信息</span>
        <span class="token keyword">const</span> exportInfo <span class="token operator">=</span> currentExportsInfo<span class="token punctuation">.</span><span class="token function">getExportInfo</span><span class="token punctuation">(</span>
          usedExport<span class="token punctuation">[</span>i<span class="token punctuation">]</span>
        <span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 5.在该变量的exportInfo里标记被使用</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>
          exportInfo<span class="token punctuation">.</span><span class="token function">setUsedConditionally</span><span class="token punctuation">(</span>
            <span class="token parameter">v</span> <span class="token operator">=&gt;</span> v <span class="token operator">!==</span> UsageState<span class="token punctuation">.</span>Used<span class="token punctuation">,</span>
            UsageState<span class="token punctuation">.</span>Used<span class="token punctuation">,</span>
            runtime
          <span class="token punctuation">)</span>
        <span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">const</span> currentModule <span class="token operator">=</span>
                currentExportsInfo <span class="token operator">===</span> exportsInfo
          <span class="token operator">?</span> module
          <span class="token operator">:</span> exportInfoToModuleMap<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>currentExportsInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>currentModule<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// 6. 递归处理遇到的 module</span>
            queue<span class="token punctuation">.</span><span class="token function">enqueue</span><span class="token punctuation">(</span>currentModule<span class="token punctuation">,</span> runtime<span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p>其中标记发生在<code>setUsedConditionally</code>函数中：</p><div class="language-javascript"><pre><code><span class="token function">setUsedConditionally</span><span class="token punctuation">(</span><span class="token parameter">condition<span class="token punctuation">,</span> newValue<span class="token punctuation">,</span> runtime</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// ...</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>newValue <span class="token operator">!==</span> UsageState<span class="token punctuation">.</span>Unused <span class="token operator">&amp;&amp;</span> <span class="token function">condition</span><span class="token punctuation">(</span>UsageState<span class="token punctuation">.</span>Unused<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>_usedInRuntime <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Map</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">forEachRuntime</span><span class="token punctuation">(</span>
      runtime<span class="token punctuation">,</span>
      <span class="token parameter">runtime</span> <span class="token operator">=&gt;</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_usedInRuntime<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>runtime<span class="token punctuation">,</span> newValue<span class="token punctuation">)</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>此时会在<code>_usedInRuntime</code>属性中标记<code>UsageState.Used</code>，为已被使用。</p><h2 id="导入了但是未被使用怎么办？" tabindex="-1">导入了但是未被使用怎么办？ <a class="header-anchor" href="#导入了但是未被使用怎么办？" aria-hidden="true">#</a></h2><p>举一个简单例子如下：</p><div class="language-javascript"><pre><code><span class="token keyword">import</span> a <span class="token keyword">from</span> <span class="token string">&#39;./a.js&#39;</span>
<span class="token comment">// 如果不调用 a</span>
<span class="token comment">// a()</span>
</code></pre></div><p>正常情况下，<code>walkStatement</code>处理解析后的<code>ast</code>，会为<code>import</code>语法创建<code>HarmonyImportSideEffectDependency</code>，而当使用<code>a()</code>时，会创建<code>HarmonyImportSpecifierDependency</code>。前面提到回编译<code>dependencies</code>进行标记，但是在遍历之前会做一层处理：</p><div class="language-javascript"><pre><code><span class="token keyword">const</span> connection <span class="token operator">=</span> moduleGraph<span class="token punctuation">.</span><span class="token function">getConnection</span><span class="token punctuation">(</span>dep<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>connection <span class="token operator">||</span> <span class="token operator">!</span>connection<span class="token punctuation">.</span>module<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">continue</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">const</span> activeState <span class="token operator">=</span> connection<span class="token punctuation">.</span><span class="token function">getActiveState</span><span class="token punctuation">(</span>runtime<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>activeState <span class="token operator">===</span> <span class="token boolean">false</span><span class="token punctuation">)</span> <span class="token keyword">continue</span><span class="token punctuation">;</span>
</code></pre></div><p>获取<code>dep</code>的<code>connection</code>，然后调用<code>getActiveState</code>方法：</p><div class="language-javascript"><pre><code><span class="token comment">// ModuleGraphConnection 类方法</span>
<span class="token function">getActiveState</span><span class="token punctuation">(</span><span class="token parameter">runtime</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>conditional<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_active<span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">condition</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> runtime<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>这个<code>conditional</code>实际上是在建立<code>connection</code>时被赋值的：</p><div class="language-javascript"><pre><code><span class="token comment">// ModuleGraph 类方法</span>
<span class="token function">setResolvedModule</span><span class="token punctuation">(</span><span class="token parameter">originModule<span class="token punctuation">,</span> dependency<span class="token punctuation">,</span> module</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> connection <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ModuleGraphConnection</span><span class="token punctuation">(</span>
    originModule<span class="token punctuation">,</span>
    dependency<span class="token punctuation">,</span>
    module<span class="token punctuation">,</span>
    <span class="token keyword">undefined</span><span class="token punctuation">,</span>
    dependency<span class="token punctuation">.</span>weak<span class="token punctuation">,</span>
    dependency<span class="token punctuation">.</span><span class="token function">getCondition</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span>
  <span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>这里又通过<code>dependency.getCondition</code>来确认最终<code>conditional</code>是否为为<code>true</code>。对于<code>HarmonyImportSideEffectDependency</code>，<code>getCondition</code>最终返回的是一个函数，因此为<code>true</code>。但是<code>HarmonyImportSpecifierDependency</code>不一样，最终会返回<code>false</code>。因此，实际上标记时是根据<code>HarmonyImportSpecifierDependency</code>来进行标记的。所以，当只导入了变量，但是没有使用时，标记同样为未使用。</p><p>（但是在递归创建<code>module</code>的时候，使用的是<code>HarmonyImportSideEffectDependency</code>，而不是<code>HarmonyImportSpecifierDependency</code>）。</p><h2 id="去除没有使用的export" tabindex="-1">去除没有使用的export <a class="header-anchor" href="#去除没有使用的export" aria-hidden="true">#</a></h2><p>在<code>seal</code>阶段进行<code>code generate</code>的时候，此时需要遍历模块的<code>dependencies</code>，然后将其生成最终的代码。而<code>export</code>的处理也正是在这个时候，这里以<code>export const a = 1</code>为例，对应于<code>HarmonyExportSpecifierDependency</code>。当生成代码时，需要执行<code>HarmonyExportSpecifierDependency.Template.apply</code>方法：</p><div class="language-javascript"><pre><code>HarmonyExportSpecifierDependency<span class="token punctuation">.</span>Template <span class="token operator">=</span> <span class="token keyword">class</span> <span class="token class-name">HarmonyExportSpecifierDependencyTemplate</span> <span class="token keyword">extends</span> <span class="token punctuation">(</span>
	NullDependency<span class="token punctuation">.</span>Template
<span class="token punctuation">)</span> <span class="token punctuation">{</span>
	<span class="token function">apply</span><span class="token punctuation">(</span>
		<span class="token parameter">dependency<span class="token punctuation">,</span>
		source<span class="token punctuation">,</span>
		<span class="token punctuation">{</span> module<span class="token punctuation">,</span> moduleGraph<span class="token punctuation">,</span> initFragments<span class="token punctuation">,</span> runtime<span class="token punctuation">,</span> concatenationScope <span class="token punctuation">}</span></span>
	<span class="token punctuation">)</span> <span class="token punctuation">{</span>
		<span class="token keyword">const</span> dep <span class="token operator">=</span> <span class="token comment">/** @type {HarmonyExportSpecifierDependency} */</span> <span class="token punctuation">(</span>dependency<span class="token punctuation">)</span><span class="token punctuation">;</span>

		<span class="token keyword">const</span> used <span class="token operator">=</span> moduleGraph
			<span class="token punctuation">.</span><span class="token function">getExportsInfo</span><span class="token punctuation">(</span>module<span class="token punctuation">)</span>
			<span class="token punctuation">.</span><span class="token function">getUsedName</span><span class="token punctuation">(</span>dep<span class="token punctuation">.</span>name<span class="token punctuation">,</span> runtime<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>used<span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token keyword">const</span> set <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Set</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			set<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>dep<span class="token punctuation">.</span>name <span class="token operator">||</span> <span class="token string">&quot;namespace&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			initFragments<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>
				<span class="token keyword">new</span> <span class="token class-name">HarmonyExportInitFragment</span><span class="token punctuation">(</span>module<span class="token punctuation">.</span>exportsArgument<span class="token punctuation">,</span> <span class="token keyword">undefined</span><span class="token punctuation">,</span> set<span class="token punctuation">)</span>
			<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">return</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>

		<span class="token keyword">const</span> map <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Map</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		map<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>used<span class="token punctuation">,</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">/* binding */ </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>dep<span class="token punctuation">.</span>id<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		initFragments<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>
			<span class="token keyword">new</span> <span class="token class-name">HarmonyExportInitFragment</span><span class="token punctuation">(</span>module<span class="token punctuation">.</span>exportsArgument<span class="token punctuation">,</span> map<span class="token punctuation">,</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span>
		<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p>它会根据<code>getExportsInfo</code>和<code>dep.name</code>获取导出的变量的使用情况，如果没有使用，那么传入的<code>map</code>为<code>undefined</code>，这样在<code>HarmonyExportInitFragment</code>获取内容时就不会生成相应的<code>export</code>代码了：</p><div class="language-javascript"><pre><code><span class="token comment">// HarmonyExportInitFragment 类 getContent 方法</span>
<span class="token function">getContent</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> runtimeTemplate<span class="token punctuation">,</span> runtimeRequirements <span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> definitions <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
  <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">const</span> <span class="token punctuation">[</span>key<span class="token punctuation">,</span> value<span class="token punctuation">]</span> <span class="token keyword">of</span> <span class="token keyword">this</span><span class="token punctuation">.</span>exportMap<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    definitions<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>
      <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">\n/* harmony export */   </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>
        key
      <span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>runtimeTemplate<span class="token punctuation">.</span><span class="token function">returningFunction</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">const</span> definePart <span class="token operator">=</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>exportMap<span class="token punctuation">.</span>size <span class="token operator">&gt;</span> <span class="token number">0</span>
  <span class="token operator">?</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">/* harmony export */ </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>RuntimeGlobals<span class="token punctuation">.</span>definePropertyGetters<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">(</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>exportsArgument
  <span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">, {</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>definitions<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token string">&quot;,&quot;</span><span class="token punctuation">)</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">\n/* harmony export */ });\n</span><span class="token template-punctuation string">`</span></span>
  <span class="token operator">:</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">;</span>
  <span class="token keyword">return</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>definePart<span class="token interpolation-punctuation punctuation">}</span></span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>unusedPart<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>从而达到去除那些没有使用到的<code>export</code>等变量的目的。</p><h2 id="terser-webpack-plugin" tabindex="-1">terser-webpack-plugin <a class="header-anchor" href="#terser-webpack-plugin" aria-hidden="true">#</a></h2><p><a href="https://github.com/webpack-contrib/terser-webpack-plugin" target="_blank" rel="noopener noreferrer">github 地址</a></p><p>最后会通过<code>terser-webpack-plugin</code>删除无用代码，实现完整的<code>tree shaking</code>效果。</p><h2 id="总结" tabindex="-1">总结 <a class="header-anchor" href="#总结" aria-hidden="true">#</a></h2><p><code>tree shaking</code>的原理大致包括以下几个步骤：</p><ol><li><code>buildModule</code>阶段：当源码解析成<code>ast</code>树后，分析<code>export</code>语法，转变为对应的<code>dependency</code>。</li><li><code>hooks.finishModules</code>钩子：通过<code>FlagDependencyExportsPlugin</code>插件遍历所有<code>module</code>的<code>dependencies</code>，找到<code>export</code>相关的<code>dependencies</code>，然后分析出导出的变量名称。最后根据每个导出的变量名称创建一个<code>exportInfo</code>，最后将<code>exportInfo</code>与当前的<code>module</code>建立联系：通过<code>getExportsInfo</code>可以访问当前<code>module</code>所有的<code>exportInfo</code>。</li><li><code>hooks.optimizeDependencies</code>钩子：通过<code>FlagDependencyUsagePlugin</code>插件，也是遍历<code>dependencies</code>。 <ul><li>查找使用了模块变量的<code>dependency</code>，解析出具体使用了哪些变量。</li><li>根据该<code>dependency</code>和<code>moduleGraph</code>，获取该<code>dependency</code>对应的<code>module</code>。</li><li>获取<code>module</code>的<code>exportsInfo</code>，根据<code>name</code>获取对应的<code>exportInfo</code>。</li><li>将<code>exportInfo</code>，标记为已使用。（可通过<code>_usedInRuntime</code>属性访问是否使用过）。</li></ul></li><li><code>seal</code>阶段：在生成代码时，分析<code>export</code>相关的<code>dependency</code>，如果没有被使用，那么不生成相应的导出代码。</li><li><code>assets</code>阶段：生成的代码通过<code>terser-webpack-plugin</code>插件删除无用代码。</li></ol></div></div><footer class="page-footer" data-v-7eddb2c4 data-v-07c132fc><div class="edit" data-v-07c132fc><div class="edit-link" data-v-07c132fc data-v-1ed99556><!----></div></div><div class="updated" data-v-07c132fc><p class="last-updated" data-v-07c132fc data-v-abce3432><span class="prefix" data-v-abce3432>最近更新:</span><span class="datetime" data-v-abce3432></span></p></div></footer><div class="next-and-prev-link" data-v-7eddb2c4 data-v-38ede35f><div class="container" data-v-38ede35f><div class="prev" data-v-38ede35f><a class="link" href="/webpack/import" data-v-38ede35f><svg xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" class="icon icon-prev" data-v-38ede35f><path d="M19,11H7.4l5.3-5.3c0.4-0.4,0.4-1,0-1.4s-1-0.4-1.4,0l-7,7c-0.1,0.1-0.2,0.2-0.2,0.3c-0.1,0.2-0.1,0.5,0,0.8c0.1,0.1,0.1,0.2,0.2,0.3l7,7c0.2,0.2,0.5,0.3,0.7,0.3s0.5-0.1,0.7-0.3c0.4-0.4,0.4-1,0-1.4L7.4,13H19c0.6,0,1-0.4,1-1S19.6,11,19,11z"></path></svg><span class="text" data-v-38ede35f>import</span></a></div><div class="next" data-v-38ede35f><a class="link" href="/webpack/SplitChunksPlugin" data-v-38ede35f><span class="text" data-v-38ede35f>SplitChunksPlugin</span><svg xmlns="http://www.w3.org/2000/svg" viewbox="0 0 24 24" class="icon icon-next" data-v-38ede35f><path d="M19.9,12.4c0.1-0.2,0.1-0.5,0-0.8c-0.1-0.1-0.1-0.2-0.2-0.3l-7-7c-0.4-0.4-1-0.4-1.4,0s-0.4,1,0,1.4l5.3,5.3H5c-0.6,0-1,0.4-1,1s0.4,1,1,1h11.6l-5.3,5.3c-0.4,0.4-0.4,1,0,1.4c0.2,0.2,0.5,0.3,0.7,0.3s0.5-0.1,0.7-0.3l7-7C19.8,12.6,19.9,12.5,19.9,12.4z"></path></svg></a></div></div></div><!--[--><!--]--></div></main></div><!----><!--]--></div>
    <script>__VP_HASH_MAP__ = JSON.parse("{\"about_readme.md\":\"b9b622c9\",\"about_index.md\":\"30f10fe2\",\"about_plan.md\":\"ec14cada\",\"algorithms_index.md\":\"ab37b98d\",\"algorithms_二叉树.md\":\"96502f32\",\"algorithms_动态规划.md\":\"741c4dc8\",\"algorithms_回溯法.md\":\"1d0e3a8e\",\"algorithms_字符串.md\":\"7be1eb44\",\"algorithms_排序汇总.md\":\"1494a6b8\",\"algorithms_数组.md\":\"4bdd27d6\",\"algorithms_树结构遍历.md\":\"a39de491\",\"articles_index.md\":\"e17c6869\",\"articles_react-concurrency.md\":\"d595299d\",\"articles_todo.md\":\"acca2846\",\"babel_index.md\":\"3b1a418f\",\"computer_index.md\":\"53becf92\",\"daily_2022_05.md\":\"24c2dcae\",\"daily_2022_06.md\":\"8052e01a\",\"daily_2022_07.md\":\"ffde4721\",\"daily_2022_08.md\":\"182d0dc2\",\"daily_2022_09.md\":\"9953691d\",\"daily_index.md\":\"1d081e3c\",\"data-structures_index.md\":\"b1490889\",\"data-structures_二叉查找树.md\":\"44f506cf\",\"data-structures_哈希表.md\":\"1b69aa81\",\"data-structures_堆.md\":\"446bf7a2\",\"data-structures_字典树.md\":\"2d6af501\",\"data-structures_布隆过滤器.md\":\"796ba07d\",\"data-structures_平衡二叉树.md\":\"9ffa63cc\",\"data-structures_并查集.md\":\"6fc32573\",\"data-structures_树状数组.md\":\"9c16c3c9\",\"data-structures_红黑树.md\":\"c8539394\",\"data-structures_线段树.md\":\"ac9d4371\",\"design-pattern_index.md\":\"f8b6b299\",\"design-pattern_创建型模式.md\":\"bebf7553\",\"design-pattern_结构型模式.md\":\"905c1899\",\"design-pattern_行为型模式.md\":\"527084c0\",\"design-pattern_阅读资料.md\":\"0822b78d\",\"index.md\":\"50636dcd\",\"javascript_typescript.md\":\"f59690ba\",\"javascript_co库.md\":\"819fa9eb\",\"javascript_es6.md\":\"2d965035\",\"javascript_index.md\":\"8a58e0e1\",\"javascript_js方法实现.md\":\"f772646e\",\"javascript_js继承.md\":\"0b5f9f67\",\"javascript_事件循环机制.md\":\"2e4ead7e\",\"javascript_手写promise.md\":\"c45faacc\",\"leetcode_1-20.md\":\"52f21453\",\"leetcode_21-40.md\":\"737d8a8e\",\"leetcode_index.md\":\"b86fa8e0\",\"leetcode_leetcode.md\":\"5c20d528\",\"linux_bash.md\":\"8900883c\",\"linux_index.md\":\"666abd92\",\"linux_ssh.md\":\"29bbf412\",\"linux_vim.md\":\"ca772e9b\",\"network_index.md\":\"00568e63\",\"network_应用层.md\":\"bcc0153b\",\"network_缓存.md\":\"128bebcb\",\"network_运输层.md\":\"1cd350ab\",\"node_compose.md\":\"e72ccaf8\",\"node_index.md\":\"6a830b07\",\"node_手写简版express.md\":\"86760379\",\"node_资料.md\":\"c79c7a65\",\"node_进程与线程.md\":\"b0fa97e5\",\"project_css-background-img.md\":\"8f8b59d6\",\"project_css-hack.md\":\"f15a4981\",\"project_css-media.md\":\"312caa9b\",\"project_drawer.md\":\"15c543a0\",\"project_index.md\":\"6a6f1ae5\",\"project_space.md\":\"96230879\",\"react_fiber.md\":\"98990e37\",\"react_lanes模型.md\":\"7e96dadc\",\"react_suspense实现.md\":\"67103bf4\",\"react_updatequeue.md\":\"4bc0370e\",\"react_beginwork-fiber创建.md\":\"73082c34\",\"react_beginwork-fiber更新.md\":\"a174d270\",\"react_commitwork.md\":\"a5980774\",\"react_completework.md\":\"89f536b7\",\"react_hooks实现.md\":\"2d2a9239\",\"react_index.md\":\"22d713ca\",\"react_react源码调试-next.md\":\"128c136d\",\"react_react源码调试.md\":\"43c51990\",\"react_react源码起始篇.md\":\"d54a017f\",\"react_react热更新实现原理.md\":\"8303be98\",\"react_tmp.md\":\"ef2cee7a\",\"react_事件系统.md\":\"88de824b\",\"react_任务调度.md\":\"cbc29ce7\",\"react_学习计划.md\":\"137dd0f2\",\"react_手写简版react-redux.md\":\"044aa7cb\",\"react_手写简版redux.md\":\"7aecfcdc\",\"react_浏览器一帧里做了什么.md\":\"8692c2ee\",\"react_渲染.md\":\"ef21463c\",\"react_阅读资料.md\":\"a38b5e29\",\"resources_index.md\":\"5bdd1c47\",\"resources_js.md\":\"f09ffe31\",\"resources_前端博客.md\":\"f5efa5ca\",\"resources_小程序.md\":\"149142f7\",\"resources_算法.md\":\"c1c6b632\",\"resources_网络协议.md\":\"18ee9ce4\",\"rollup_plugin.md\":\"05a44124\",\"rollup_scopehoist.md\":\"04d668d3\",\"rollup_splitcode.md\":\"088832bc\",\"rollup_treeshaking.md\":\"46d1a5ae\",\"rollup_index.md\":\"33cc74bc\",\"rollup_todo.md\":\"c52a095f\",\"rollup_源码调试.md\":\"f0172f30\",\"static_index.md\":\"249a1daa\",\"tools_img-library.md\":\"d2275488\",\"tools_index.md\":\"44a55ee2\",\"tools_iterm2-ohmyzsh.md\":\"e9935c1f\",\"tools_jinkins.md\":\"ad867150\",\"tools_software.md\":\"f95a65a8\",\"trend_bundleless.md\":\"28aa6df5\",\"trend_index.md\":\"81dba32b\",\"trend_jiti.md\":\"7ad8aaa6\",\"typescript_index.md\":\"36ca4899\",\"typescript_utility-types.md\":\"d2518b16\",\"vite_index.md\":\"bbc75d29\",\"vite_源码调试.md\":\"4f950ae0\",\"vue_index.md\":\"c1116c74\",\"vue_一些原理汇总.md\":\"e6d47036\",\"vue_响应式原理上篇.md\":\"7131e3e7\",\"vue_响应式原理下篇.md\":\"31574162\",\"vue_响应式原理中篇.md\":\"3930ee0d\",\"vue_手写简版vuerouter.md\":\"ad3a47b8\",\"vue_手写简版vuex.md\":\"383f38de\",\"vue_插槽实现原理.md\":\"e2510875\",\"vue_最长递增子序列.md\":\"13a61e33\",\"vue_组件实现原理.md\":\"44fcf317\",\"vue_组成与设计.md\":\"97961f20\",\"vue_编译原理上篇.md\":\"6b364fe6\",\"vue_编译原理下篇.md\":\"a0ba2d4a\",\"vue_编译原理中篇.md\":\"bed0a18a\",\"vue_选项合并.md\":\"9b05ff32\",\"vue_阅读资料.md\":\"d328e1c8\",\"vue3_index.md\":\"27d24805\",\"vue3_源码调试.md\":\"bd7925e9\",\"webpack_splitchunksplugin.md\":\"e50ef05a\",\"webpack_tapable.md\":\"bb30978d\",\"webpack_treeshaking原理.md\":\"eb384a45\",\"webpack_addmodule.md\":\"e8d5b765\",\"webpack_buildmodule.md\":\"8fd36f5e\",\"webpack_emit阶段.md\":\"6cfb3685\",\"webpack_factorizemodule.md\":\"c298b28d\",\"webpack_import.md\":\"b239ca8e\",\"webpack_index.md\":\"15771f90\",\"webpack_make阶段.md\":\"47d3193d\",\"webpack_seal阶段.md\":\"f340fb34\",\"webpack_vue-loader实现.md\":\"97da8788\",\"webpack_watch实现.md\":\"f838042d\",\"webpack_webpack优化.md\":\"45cade7a\",\"webpack_webpack官方文档.md\":\"6718e7f2\",\"webpack_webpack源码调试.md\":\"d444fae2\",\"webpack_官方文档.md\":\"ae520960\",\"webpack_流程开始.md\":\"fa5913e6\",\"webpack_热更新实现原理.md\":\"630d4d34\"}")</script>
    <script type="module" async src="/assets/app.d322b2e6.js"></script>
    
  </body>
</html>